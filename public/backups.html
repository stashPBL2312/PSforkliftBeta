<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backups - Admin</title>
  <script src="/common.js?v=renderfix1" defer></script>
  <script>
    // Fallback: jika common.js gagal termuat, definisikan showToast minimal agar tidak error
    (function(){
      if (typeof window.showToast !== 'function'){
        window.showToast = function(message, type){
          try{
            // Minimal toast mirip common.js
            const old = document.getElementById('toast');
            if (old) { try { old.remove(); } catch(_){} }
            const el = document.createElement('div');
            el.id = 'toast';
            el.textContent = message || '';
            el.style.position = 'fixed';
            el.style.bottom = '16px';
            el.style.right = '16px';
            el.style.padding = '10px 12px';
            el.style.borderRadius = '6px';
            el.style.boxShadow = '0 8px 24px rgba(0,0,0,0.25)';
            el.style.zIndex = '9999';
            const isDark = (document.documentElement.getAttribute('data-theme')==='dark');
            const bgSuccess = isDark ? '#166534' : '#2e7d32';
            const bgError = isDark ? '#7f1d1d' : '#d32f2f';
            el.style.background = (type==='error') ? bgError : bgSuccess;
            el.style.color = '#fff';
            el.style.opacity = '0';
            el.style.transform = 'translateY(8px)';
            document.body.appendChild(el);
            requestAnimationFrame(()=>{
              el.style.transition = 'opacity .16s ease, transform .16s ease';
              el.style.opacity = '1';
              el.style.transform = 'translateY(0)';
            });
            setTimeout(()=>{
              el.style.opacity = '0';
              el.style.transform = 'translateY(8px)';
              setTimeout(()=>{ try{ el.remove(); }catch(_){ } }, 220);
            }, 2200);
          }catch(_){ try{ alert(message || 'Info'); }catch(__){} }
        };
      }
    })();
  </script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    .wrap { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 16px 0; }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: var(--cardBg, #fff); border:1px solid #ddd; border-radius:8px; padding:16px; }
    label { display:block; font-size:12px; color:#555; margin-top:10px; }
    /* Textual inputs */
    input[type="text"], input[type="number"], input[type="time"], input[type="email"], input[type="password"], select {
      width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:6px; margin-top:6px; box-sizing:border-box; min-height:36px;
    }
    /* Checkbox small */
    input[type="checkbox"]{ width:auto; height:auto; margin-top:0; }
    button { padding:8px 12px; background:#1e88e5; color:white; border:0; border-radius:6px; cursor:pointer; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    thead th { background:#f4f6f8; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-start; margin-top:12px; }
    .muted { color:#666; font-size:12px; }
    .success { color:#2e7d32; font-size:13px; }
    .error { color:#d32f2f; font-size:13px; }
    .checkbox-row { display:flex; align-items:center; gap:8px; }
    .checkbox-row span { font-size:12px; line-height:1; }
    .table-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:8px; margin-top:8px; }
    .pill { display:inline-block; font-size:12px; padding:2px 6px; border-radius:999px; background:#eef2ff; color:#1e3a8a; margin-left:8px; }
    /* Action buttons in history: consistent sizing */
    .action-btn { padding:6px 10px; border-radius:6px; font-size:12px; }
    /* Dark mode overrides for label and checkbox text */
    [data-theme="dark"] label { color:#e5e7eb !important; }
    [data-theme="dark"] .checkbox-row span { color:#e5e7eb !important; }
    #progressOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9999; }
    #progressOverlay > div{ background:#fff; border-radius:8px; padding:16px; width:420px; box-shadow:0 10px 24px rgba(0,0,0,.3); }
    [data-theme="dark"] #progressOverlay > div{ background:#0f172a; color:#e5e7eb; }
    .bar{ height:10px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .bar > span{ display:block; height:100%; width:0; background:#1e88e5; transition:width .2s ease; }
    .prog-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="wrap">
    <h1>Manajemen Backup (Admin)</h1>
    <div id="guard" class="error" style="display:none;">Halaman ini hanya bisa diakses oleh admin.</div>
    <div class="grid" id="content" style="display:none;">
      <div>
        <div class="card">
          <h2 style="margin:0 0 8px; font-size:18px;">Jadwal Backup Otomatis</h2>
          <div class="muted">Atur waktu dan retensi backup harian.</div>
          <div class="checkbox-row">
            <input id="sch_enabled" type="checkbox" />
            <span>Aktifkan backup otomatis</span>
          </div>
          <label>Waktu Backup (HH:MM)</label>
          <input id="sch_time" type="time" />
          <label>Retensi (hari)</label>
          <input id="sch_retention" type="number" min="1" max="365" />
          <div class="toolbar">
            <button id="btnSaveSchedule">Simpan Jadwal</button>
            <span id="msgSchedule" class="muted"></span>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <h2 style="margin:0 0 8px; font-size:18px;">Backup Manual</h2>
          <div class="muted">Jalankan backup sekarang. Jika tidak memilih tabel, semua tabel aktif akan diekspor.</div>
          <label>Label (opsional)</label>
          <input id="bk_label" />
          <div class="checkbox-row" style="margin-top:10px;">
            <input id="bk_all" type="checkbox" checked />
            <span>Backup semua tabel</span>
          </div>
          <div id="tablesWrap" style="margin-top:8px;">
            <label>Pilih tabel (opsional)</label>
            <div class="table-grid" id="tablesGrid"></div>
            <div class="toolbar">
              <button id="btnClearSel" type="button" style="background:#6b7280;">Bersihkan Pilihan</button>
            </div>
          </div>
          <div class="toolbar">
            <button id="btnRunBackup">Jalankan Backup</button>
            <span id="msgRun" class="muted"></span>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h2 style="margin:0 0 8px; font-size:18px;">Riwayat Backup</h2>
          <div class="toolbar">
            <button id="btnRefresh">Refresh</button>
            <button id="btnImportZip" style="background:#16a34a;">Import ZIP</button>
            <input type="file" id="zipFile" accept=".zip" style="display:none;" />
          </div>
          <div id="historyWrap" style="margin-top:12px;">
            <table>
              <thead id="historyHead">
                <tr>
                  <th data-sort="name">Nama</th>
                  <th data-sort="createdAt">Dibuat</th>
                  <th data-sort="fileCount">File</th>
                  <th data-sort="sizeBytes">Ukuran</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="progressOverlay">
    <div>
      <h2 style="margin:0 0 8px; font-size:18px;">Import Sedang Berjalan</h2>
      <div id="progMsg" class="muted">Menyiapkan…</div>
      <div class="prog-row"><div class="bar" style="flex:1"><span id="progBar"></span></div><div id="progPct" style="min-width:52px; text-align:right;">0%</div></div>
      <div class="prog-row"><div id="progTable" class="pill">–</div><div id="progCount" class="muted" style="text-align:right;">0/0</div></div>
      <div class="toolbar" style="justify-content:flex-end; margin-top:12px;"><button id="btnCloseProg" type="button" style="background:#6b7280;">Tutup</button></div>
    </div>
  </div>

  <script>
    function fmtBytes(n){
      var x = Number(n||0);
      if (x < 1024) return x + ' B';
      var i = Math.floor(Math.log(x)/Math.log(1024));
      var sizes = ['B','KB','MB','GB','TB'];
      return (x/Math.pow(1024,i)).toFixed(2)+' '+sizes[i];
    }

    document.addEventListener('DOMContentLoaded', function(){
      (async function(){
        const user = await ensureAuthedAndRenderNav();
        if (!user) return;
        if (user.role !== 'admin'){
          document.getElementById('guard').style.display='block';
          return;
        }
        document.getElementById('content').style.display='grid';

        async function loadSchedule(){
          try{
            const r = await api('/api/backup/schedule');
            document.getElementById('sch_enabled').checked = !!r.enabled;
            var hh = String(r.hour).padStart(2,'0');
            var mm = String(r.minute).padStart(2,'0');
            document.getElementById('sch_time').value = hh+':'+mm;
            document.getElementById('sch_retention').value = r.retentionDays;
            document.getElementById('msgSchedule').textContent = '';
          }catch(e){ document.getElementById('msgSchedule').textContent = 'Gagal memuat jadwal'; }
        }

        async function saveSchedule(){
          const enabled = document.getElementById('sch_enabled').checked;
          const timeVal = document.getElementById('sch_time').value || '16:00';
          const parts = timeVal.split(':');
          const hour = parseInt(parts[0]||'16',10);
          const minute = parseInt(parts[1]||'0',10);
          const retentionDays = parseInt(document.getElementById('sch_retention').value||'30',10);
          try{
            await api('/api/backup/schedule', { method:'POST', body:{ enabled, hour, minute, retentionDays } });
            document.getElementById('msgSchedule').textContent = 'Jadwal tersimpan';
            document.getElementById('msgSchedule').className = 'success';
            const hh = String(hour).padStart(2,'0');
            const mm = String(minute).padStart(2,'0');
            showToast(`Jadwal tersimpan: ${enabled?hh+':'+mm:'nonaktif'}, retensi ${retentionDays} hari`, 'success');
          }catch(e){
            document.getElementById('msgSchedule').textContent = e && e.error ? e.error : 'Gagal menyimpan';
            document.getElementById('msgSchedule').className = 'error';
            showToast(e && e.error ? e.error : 'Gagal menyimpan jadwal', 'error');
          }
        }

        async function runBackup(){
          const label = document.getElementById('bk_label').value.trim();
          let body = {};
          if (label) body.label = label;
          const allChecked = document.getElementById('bk_all').checked;
          if (!allChecked){
            const sels = Array.from(document.querySelectorAll('input[name="tables"]:checked')).map(el=>el.value);
            if (sels.length) body.tables = sels;
          }
          // Jalankan backup dan beri feedback sukses/gagal
          try{
            const r = await api('/api/backup/run', { method:'POST', body });
            document.getElementById('msgRun').textContent = 'Backup berhasil: ' + r.dir + ' ('+(r.files||[]).length+' file)';
            document.getElementById('msgRun').className = 'success';
            showToast('Backup berhasil: '+ r.dir +' ('+(r.files||[]).length+' file)', 'success');
          }catch(e){
            document.getElementById('msgRun').textContent = e && e.error ? e.error : 'Gagal menjalankan backup';
            document.getElementById('msgRun').className = 'error';
            showToast(e && e.error ? e.error : 'Gagal menjalankan backup', 'error');
            return; // Jangan lanjut refresh riwayat jika gagal utama
          }
          // Refresh riwayat secara terpisah agar error refresh tidak menimpa pesan sukses
          try{ await loadHistory(); }catch(_){ /* abaikan error refresh */ }
        }

        async function loadTables(){
          try{
            const r = await api('/api/backup/tables');
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';
            (r.tables||[]).forEach(t => {
              const id = 'tbl_'+t;
              const wrap = document.createElement('div');
              wrap.className = 'checkbox-row';
              wrap.innerHTML = `<input type="checkbox" name="tables" id="${id}" value="${t}" /> <label for="${id}" style="margin:0;">${t}</label>`;
              grid.appendChild(wrap);
            });
          }catch(e){
            document.getElementById('tablesGrid').innerHTML = '<div class="error">Gagal memuat daftar tabel</div>';
          }
        }

        var sortState = { key: 'createdAt', dir: 'desc' };
        var historyData = [];

        function renderHistory(){
          const body = document.getElementById('historyBody');
          body.innerHTML = '';
          const arr = historyData.slice();
          const key = sortState.key; const dir = sortState.dir;
          arr.sort((a,b)=>{
            let va = a[key]; let vb = b[key];
            if (key === 'createdAt'){ va = new Date(a.createdAt).getTime(); vb = new Date(b.createdAt).getTime(); }
            if (key === 'fileCount' || key === 'sizeBytes'){ va = Number(va||0); vb = Number(vb||0); }
            if (va < vb) return dir === 'asc' ? -1 : 1;
            if (va > vb) return dir === 'asc' ? 1 : -1;
            return 0;
          });
          arr.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${b.name}</td>
              <td>${new Date(b.createdAt).toLocaleString()}</td>
              <td>${b.fileCount}</td>
              <td>${fmtBytes(b.sizeBytes)}</td>
              <td>
                <button type="button" class="action-btn" data-download="${b.name}" style="background:#0ea5e9;">Download ZIP</button>
                <button type="button" class="action-btn" data-import-upsert="${b.name}">Import Upsert</button>
                <button type="button" class="action-btn" data-import-replace="${b.name}" style="background:#ef6c00;">Import Replace</button>
                <button type="button" class="action-btn" data-delete="${b.name}" style="background:#b91c1c;">Hapus</button>
              </td>
            `;
            body.appendChild(tr);
          });
        }

        async function loadHistory(){
          try{
            const r = await api('/api/backup/history');
            historyData = r.backups||[];
            renderHistory();
          }catch(e){
            const body = document.getElementById('historyBody');
            body.innerHTML = `<tr><td colspan="5" class="error">Gagal memuat riwayat</td></tr>`;
          }
        }

        async function importBackup(name, strategy){
          try{
            const r = await api('/api/backup/import-start', { method:'POST', body:{ name, strategy } });
            const id = r && r.id;
            if (!id){ showToast('Gagal memulai import', 'error'); return; }
            const overlay = document.getElementById('progressOverlay');
            const bar = document.getElementById('progBar');
            const pct = document.getElementById('progPct');
            const msg = document.getElementById('progMsg');
            const tbl = document.getElementById('progTable');
            const cnt = document.getElementById('progCount');
            overlay.style.display='flex';
            let timer = null; let done=false;
            const update = async ()=>{
              try{
                const s = await api('/api/backup/import-status?id='+encodeURIComponent(id));
                msg.textContent = s.message || '';
                tbl.textContent = s.currentTable || '–';
                const total = Number(s.totalTables||0);
                const ti = Number(s.tableIndex||0);
                const rows = Number(s.tableRows||0);
                const proc = Number(s.processedRows||0);
                cnt.textContent = (rows?proc:0)+'/'+rows;
                let p = 0;
                if (total>0){
                  const base = Math.max(0, ti-1)/total;
                  const frac = rows>0 ? (proc/rows)/total : 0;
                  p = Math.min(1, base + frac);
                }
                const val = Math.round(p*100);
                bar.style.width = val+'%';
                pct.textContent = val+'%';
                if (s.status==='done'){ done=true; clearInterval(timer); overlay.style.display='none'; showToast('Import selesai: '+name+' ('+strategy+')','success'); await loadHistory(); }
                if (s.status==='error'){ done=true; clearInterval(timer); overlay.style.display='none'; showToast('Import gagal: '+(s.message||'error'),'error'); }
              }catch(_){ }
            };
            timer = setInterval(update, 500);
            update();
            document.getElementById('btnCloseProg').onclick = function(){ if (done) overlay.style.display='none'; };
          }catch(e){ showToast('Gagal memulai import: '+(e && e.error ? e.error : 'error'),'error'); }
        }

        async function deleteBackup(name){
          try{
            await api('/api/backup/'+encodeURIComponent(name), { method:'DELETE' });
            showToast('Backup terhapus: '+ name, 'success');
            // Hapus item dari tampilan segera tanpa menunggu refresh
            historyData = (historyData||[]).filter(b => b && b.name !== name);
            renderHistory();
          }catch(e){
            showToast('Gagal menghapus backup: '+(e && e.error ? e.error : 'error'), 'error');
            return;
          }
          // Refresh riwayat di background; abaikan jika gagal agar tidak menimpa toast sukses
          try{ await loadHistory(); }catch(_){ /* abaikan */ }
        }

        document.getElementById('btnSaveSchedule').onclick = saveSchedule;
        document.getElementById('btnRunBackup').onclick = runBackup;
        document.getElementById('btnRefresh').onclick = loadHistory;

        // Import ZIP: open file picker then upload via FormData
        document.getElementById('btnImportZip').onclick = function(){
          const inp = document.getElementById('zipFile');
          inp.value = '';
          inp.click();
        };
        document.getElementById('zipFile').addEventListener('change', async function(){
          const f = this.files && this.files[0];
          if (!f) return;
          const fd = new FormData();
          fd.append('zip', f, f.name);
          try{
            const r = await fetch('/api/backup/upload', { method:'POST', body: fd, credentials:'include', cache:'no-store' });
            if (r.status === 401){ location.href = '/login.html'; return; }
            const data = await r.json().catch(()=>({}));
            if (!r.ok) throw data;
            showToast('Import ZIP berhasil: '+ (data && data.dir ? data.dir : 'backup baru'), 'success');
            await loadHistory();
          }catch(e){
            showToast('Gagal import ZIP: '+ (e && e.error ? e.error : 'error'), 'error');
          }finally{
            this.value = '';
          }
        });

        document.getElementById('bk_all').addEventListener('change', function(){
          const disabled = this.checked;
          document.querySelectorAll('input[name="tables"]').forEach(el => { el.disabled = disabled; });
        });
        // Removed 'Pilih Semua' button; users can use 'Backup semua tabel' checkbox to include semua tabel
        document.getElementById('btnClearSel').onclick = function(){
          document.querySelectorAll('input[name="tables"]').forEach(el => { el.checked = false; });
          document.getElementById('bk_all').checked = true;
          document.querySelectorAll('input[name="tables"]').forEach(el => { el.disabled = true; });
        };

        document.getElementById('historyWrap').addEventListener('click', async (ev)=>{
          // Prevent any default form submit or bubbling side-effects
          ev.preventDefault(); ev.stopPropagation();
          const btn = ev.target.closest('button');
          if (!btn) return;
          const up = btn.getAttribute('data-import-upsert');
          const rep = btn.getAttribute('data-import-replace');
          const del = btn.getAttribute('data-delete');
          const dl = btn.getAttribute('data-download');
          if (dl){
            try{
              const url = '/api/backup/'+encodeURIComponent(dl)+'/zip';
              // Open in new tab to avoid navigation issues
              window.open(url, '_blank');
            }catch(e){ showToast('Gagal memulai unduhan ZIP', 'error'); }
            return;
          }
          if (up){
            await importBackup(up, 'upsert');
            return;
          }
          if (rep){
            if (!(await confirmDialog('Yakin impor dengan replace? Data tabel terkait akan dihapus terlebih dulu.'))) return;
            await importBackup(rep, 'replace');
            return;
          }
          if (del){
            if (!(await confirmDialog('Yakin hapus folder backup ini? Tindakan tidak dapat dibatalkan.'))) return;
            await deleteBackup(del);
            return;
          }
        });

        document.getElementById('historyHead').addEventListener('click', function(ev){
          const th = ev.target.closest('th');
          if (!th) return;
          const key = th.getAttribute('data-sort');
          if (!key) return;
          if (sortState.key === key){ sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; }
          else { sortState.key = key; sortState.dir = 'desc'; }
          renderHistory();
        });

        await loadSchedule();
        await loadTables();
        await loadHistory();
      })();
    });
  </script>
</body>
</html>