<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <script src="/common.js" defer></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f5f7fb; }
    html, body { max-width:100%; overflow-x:hidden; }
    .wrap { max-width:1100px; margin:20px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .card { background:#fff; padding:14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .muted { color:#666; font-size:12px; }
    [data-theme="dark"] .muted { color:#fff; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
    th { background:#fafafa; }
    input, select { padding:6px 8px; }
    /* Late PM date styling */
    .late-date { color:#dc2626; font-weight:600; }
    [data-theme="dark"] .late-date { color:#fca5a5; }
    /* Week/Upcoming date styling */
    .week-date { color:#ca8a04; font-weight:600; }
    [data-theme="dark"] .week-date { color:#fde68a; }
    .upcoming-date { color:#16a34a; font-weight:600; }
    [data-theme="dark"] .upcoming-date { color:#86efac; }
    /* Status badges */
    .status-badge { display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .status-late { background:rgba(220,38,38,0.10); color:#dc2626; }
    [data-theme="dark"] .status-late { background:rgba(252,165,165,0.12); color:#fca5a5; }
    .status-week { background:rgba(234,179,8,0.15); color:#a16207; }
    [data-theme="dark"] .status-week { background:rgba(250,204,21,0.12); color:#fde68a; }
    .status-upcoming { background:rgba(22,163,74,0.12); color:#16a34a; }
    [data-theme="dark"] .status-upcoming { background:rgba(134,239,172,0.12); color:#86efac; }

    /* Responsive adjustments */
    /* Toolbar default (desktop) */
    .pm-toolbar { display:flex; align-items:center; gap:8px; }
    .pm-toolbar h3 { margin:0; }
    .pm-toolbar select, .pm-toolbar input { height:34px; }
    #rowsPerPage { width:80px; }

    @media (max-width: 768px){
      .wrap { margin:12px auto; padding:0 10px; }
      .card > div:first-child { flex-wrap: wrap; gap: 8px; }
      #pmTable { overflow-x:auto; }
      #pagination { display:flex; flex-wrap: wrap; gap: 6px; }
      /* Use 2 columns so cards tidak dempet di sisi kanan */
      .grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px; grid-auto-flow: row !important; overflow-x: visible !important; }
      .grid .card { padding: 8px; }
      .grid .card > div:nth-child(2) { font-size: 16px !important; }
      .muted { font-size: 10px; }

      /* Jadwal PM toolbar in mobile: grid 2 kolom simetris */
      .pm-toolbar { display:grid; grid-template-columns: 1fr 1fr; column-gap:10px; row-gap:8px; align-items:stretch; }
      .pm-toolbar h3 { grid-column: 1 / -1; margin:0; }
      .pm-toolbar select, .pm-toolbar input { height:36px; font-size:14px; width:100%; box-sizing:border-box; }
      #search { width:100%; }
      #rowsPerPage { justify-self: stretch; }

      /* PM table mobile: tanpa sticky kolom; tetap kompak dan bisa scroll horizontal */
      #pmTable .table-scroll { overflow-x:auto; -webkit-overflow-scrolling:touch; }
      #pmTable table th, #pmTable table td { padding: 6px; font-size: 13px; }
      #pmTable .table-scroll table { min-width: 640px; }
    }
    @media (max-width: 480px){
      /* Extra small phones: tetap 2 kolom vertikal, tanpa scroll horizontal, semua kartu utuh */
      .grid { grid-template-columns: repeat(2, 1fr) !important; gap: 6px; grid-auto-flow: row !important; overflow-x: visible !important; }
      .grid .card { padding: 6px; }
      .grid .card > div:nth-child(2) { font-size: 15px !important; }
      .muted { font-size: 10px; }
      /* Toolbar extra small: kompak */
      .pm-toolbar select, .pm-toolbar input { height:34px; font-size:13px; width:100%; box-sizing:border-box; }
      #rowsPerPage { justify-self: stretch; }
      /* Extra small phones: tetap tanpa sticky; ukuran tabel disesuaikan */
      #pmTable .table-scroll table { min-width: 560px; }
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="wrap">
    <h2>Dashboard</h2>
    <div id="metrics" class="grid"></div>

    <div class="card" style="margin-top:16px;">
      <div class="pm-toolbar">
        <h3>Jadwal PM</h3>
        <select id="pmCategory" title="Kategori PM">
          <option value="all" selected>Semua</option>
          <option value="late">Terlambat</option>
          <option value="week">Minggu Ini</option>
          <option value="upcoming">Akan Datang</option>
        </select>
        <select id="ptFilter" title="Filter Powertrain" aria-label="Filter Powertrain">
          <option value="all" selected>All</option>
          <option value="electric">Electric</option>
          <option value="diesel">Diesel</option>
        </select>
        <input id="search" placeholder="Cari..." />
        <select id="rowsPerPage">
          <option>10</option><option>15</option><option>25</option>
        </select>
      </div>
      <div id="pmTable" style="margin-top:8px;"></div>
      <div id="pagination" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{ (async function(){
    const user = await ensureAuthedAndRenderNav(); if (!user) return;
    const data = await api('/api/dashboard/metrics');
    // Ambil semua jobs agar kategori "Akan Datang" bisa menampilkan SEMUA PM mendatang (tidak terbatas 7 hari)
    let allJobs = [];
    try { allJobs = await api('/api/jobs'); } catch(e){ allJobs = []; }
    // Ambil daftar forklifts untuk fallback label/powertrain jika ada data kosong
    let fkMeta = {}; // by id
    try {
      const forklifts = await api('/api/forklifts');
      forklifts.forEach(f=>{ const eq = (f.eq_alias||f.eq_no)||''; fkMeta[f.id] = { label: `${f.brand} ${f.type} (${eq})`, powertrain: String(f.powertrain||'') }; });
    } catch(e){ /* abaikan jika gagal, hanya berdampak pada label forklift */ }

    // Terapkan hint performa pada kontainer tabel untuk mempercepat paint/layout
    try { applyTablePerformanceHints('pmTable'); } catch(_) {}

    function parseISODate(s){ const d = new Date(s); return Number.isNaN(d.getTime())?null:d; }
    function normalizeRow(r){
      const jadwal = r.jadwal_pm || r.next_pm || '';
      const ptrain = r.powertrain || (r.forklift_id && fkMeta[r.forklift_id] && fkMeta[r.forklift_id].powertrain) || '';
      return {
        forklift: r.forklift || (r.forklift_id && fkMeta[r.forklift_id] && fkMeta[r.forklift_id].label) || (r.forklift_id ? `#${r.forklift_id}` : ''),
        jadwal_pm: jadwal,
        status: r.status || '',
        teknisi_terakhir: r.teknisi_terakhir || r.teknisi || '',
        service_terakhir: r.service_terakhir || r.tanggal || '',
        powertrain: ptrain,
      };
    }
    function normalizeList(list){ return (Array.isArray(list)?list:[]).map(normalizeRow); }
    function byDateRange(list, predicate){ return normalizeList(list).filter(row=>{ const d=parseISODate(row.jadwal_pm); if(!d) return false; const today=new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0); const next7 = new Date(today); next7.setDate(today.getDate()+7); return predicate({ d, today, next7 }); }); }
    function ptCategoryOf(powertrain){
      const s = String(powertrain||'').trim().toLowerCase();
      if (!s) return '';
      if (s.includes('electric') || s.includes('manual') || s.includes('instrument') || s.includes('tools')) return 'electric';
      if (s.includes('diesel') || s.includes('lpg')) return 'diesel';
      return '';
    }
    // Indexing untuk mempercepat filter: powertrain (_pt) dan query gabungan (_q)
    function indexRows(list){
      const arr = Array.isArray(list)?list:[];
      for (let i=0;i<arr.length;i++){
        const r = arr[i];
        // Precompute kategori powertrain agar filter cepat
        r._pt = ptCategoryOf(r.powertrain);
        // Precompute string pencarian agar filter keyword tidak memanggil Object.values setiap kali
        r._q = (
          (r.forklift||'')+'|'+(r.jadwal_pm||'')+'|'+(r.status||'')+'|'+(r.teknisi_terakhir||'')+'|'+(r.service_terakhir||'')
        ).toLowerCase();
      }
      return arr;
    }
    function fastFilter(data, keyword){
      if (!keyword) return data;
      const q = String(keyword||'').toLowerCase();
      const base = Array.isArray(data)?data:[];
      // Gunakan _q jika tersedia; fallback ke filterData umum untuk kompatibilitas
      return base.filter(r => (r._q ? r._q.includes(q) : Object.values(r).some(v => String(v||'').toLowerCase().includes(q))));
    }
    function getDatasetForCategory(cat){
      if (cat==='late'){
        const src = Array.isArray(data.pmLate) && data.pmLate.length ? data.pmLate : (Array.isArray(data.pmMonth) ? data.pmMonth : []);
        // Jika pmLate kosong/tdk tersedia, fallback: ambil yang < today dari pmMonth
        if (src === data.pmLate) return normalizeList(src);
        return byDateRange(src, ({d,today})=> d < today);
      }
      if (cat==='week'){
        const src = Array.isArray(data.pmWeek) && data.pmWeek.length ? data.pmWeek : (Array.isArray(data.pmMonth) ? data.pmMonth : []);
        // Jika pmWeek kosong/tdk tersedia, fallback: between today..+7 dari pmMonth
        if (src === data.pmWeek) return normalizeList(src);
        return byDateRange(src, ({d,today,next7})=> d >= today && d <= next7);
      }
      if (cat==='upcoming'){
        // "Akan Datang" = semua PM dengan jadwal >= hari ini (tanpa batas 7 hari)
        // Sumber utama: seluruh jobs (jenis='PM') dengan next_pm
        if (Array.isArray(allJobs) && allJobs.length){
          const list = allJobs.filter(j => String(j.jenis||'').toUpperCase() === 'PM' && j.next_pm);
          return byDateRange(list, ({d,today})=> d >= today);
        }
        // Fallback: gabungkan pmWeek (0..+7) + pmUpcoming (>+7) bila tersedia
        const haveWeek = Array.isArray(data.pmWeek) && data.pmWeek.length>0;
        const haveUpcoming = Array.isArray(data.pmUpcoming) && data.pmUpcoming.length>0;
        if (haveWeek || haveUpcoming){
          const combined = [];
          if (haveWeek) combined.push(...data.pmWeek);
          if (haveUpcoming) combined.push(...data.pmUpcoming);
          return normalizeList(combined);
        }
        // Fallback terakhir: filter dari pmMonth (atau list lain) untuk d >= today
        const src = Array.isArray(data.pmMonth) ? data.pmMonth : [];
        return byDateRange(src, ({d,today})=> d >= today);
      }
      if (cat==='all'){
        // Semua: ambil seluruh PM (late, week, upcoming) dari allJobs bila tersedia
        if (Array.isArray(allJobs) && allJobs.length){
          const list = allJobs.filter(j => String(j.jenis||'').toUpperCase() === 'PM' && j.next_pm);
          return normalizeList(list);
        }
        // Fallback: gabungkan semua sumber yang tersedia lalu dedupe berdasarkan forklift+jadwal
        const combined = [];
        if (Array.isArray(data.pmLate)) combined.push(...data.pmLate);
        if (Array.isArray(data.pmWeek)) combined.push(...data.pmWeek);
        if (Array.isArray(data.pmUpcoming)) combined.push(...data.pmUpcoming);
        const norm = normalizeList(combined);
        const seen = new Set();
        const out = [];
        for (const r of norm){
          const key = `${r.forklift}|${r.jadwal_pm}`;
          if (seen.has(key)) continue; seen.add(key); out.push(r);
        }
        return out;
      }
      // fallback umum
      return normalizeList([]);
    }

    const monthName = new Intl.DateTimeFormat('id-ID', { month: 'long' }).format(new Date());

    const m = [
      { label:'Forklift', value:data.totalForklifts, desc:'Total forklift dalam sistem' },
      { label:'Forklift Aktif', value:data.forkliftsActive, desc:'Forklift dengan status aktif' },
      { label:'Forklift Maintenance', value:data.forkliftsMaintenance, desc:'Forklift dalam maintenance' },
      { label:'Total Pekerjaan', value:data.totalJobs, desc:'Pekerjaan PM, Lapangan dan workshop dalam sistem' },
      { label:'Jobs Bulan Ini', value:data.jobsThisMonth, desc:`Pekerjaan di Bulan ${monthName}` },
      { label:'Maintenance Jobs', value:data.maintenanceJobs, desc:'Total Pekerjaan maintenance' },
      { label:'PM Terlambat', value:(data.pmLate||[]).length, desc:'PM yang sudah melewati jadwal' },
      { label:'PM Minggu ini', value:(data.pmWeek||[]).length, desc:'PM dalam 7 hari kedepan' },
      { label:'PM Bulan Ini', value:(data.pmMonth||[]).length, desc:'PM dalam 30 hari kedepan' },
    ];
    document.getElementById('metrics').innerHTML = m.map(x=>`<div class='card'><div class='muted'>${x.label}</div><div style='font-size:22px; font-weight:700;'>${x.value}</div><div class='muted' style='margin-top:4px;'>${x.desc}</div></div>`).join('');

    let category = (document.getElementById('pmCategory')?.value) || 'all';

    function classifyPM(row){
      const d = parseISODate(row.jadwal_pm); if(!d) return 'unknown';
      const today = new Date(); today.setHours(0,0,0,0); d.setHours(0,0,0,0);
      const next7 = new Date(today); next7.setDate(today.getDate()+7);
      if (d < today) return 'late';
      if (d <= next7) return 'week';
      return 'upcoming';
    }
    const columns = [
      { key:'forklift', label:'Forklift' },
      { key:'jadwal_pm', label:'Jadwal PM', render: r => {
          const st = (category==='all' ? classifyPM(r) : category);
          const cls = st==='late'? 'late-date' : (st==='week'? 'week-date' : 'upcoming-date');
          return `<span class="${cls}">${r.jadwal_pm||''}</span>`;
        }
      },
      { key:'status', label:'Status', render: r => {
          const st = (category==='all' ? classifyPM(r) : category);
          const text = st==='late'? 'Terlambat' : (st==='week'? 'Minggu Ini' : 'Akan Datang');
          const scls = st==='late'? 'status-badge status-late' : (st==='week'? 'status-badge status-week' : 'status-badge status-upcoming');
          return `<span class="${scls}">${text}</span>`;
        }
      },
      { key:'teknisi_terakhir', label:'Teknisi Terakhir' },
      { key:'service_terakhir', label:'Tanggal Service Terakhir' },
    ];

    // Bangun dataset terindeks untuk semua kategori sekali, agar perpindahan kategori instan
    const datasetLate = indexRows(getDatasetForCategory('late'));
    const datasetWeek = indexRows(getDatasetForCategory('week'));
    const datasetUpcoming = indexRows(getDatasetForCategory('upcoming'));
    const datasetAll = indexRows(getDatasetForCategory('all'));
    let pmData = (category==='late'?datasetLate:(category==='week'?datasetWeek:(category==='upcoming'?datasetUpcoming:datasetAll)));
    let page = 1; let rows = 10;

    function render(){
      const q = document.getElementById('search').value;
      let base = pmData;
      // Terapkan filter powertrain untuk semua kategori (Terlambat, Minggu Ini, Akan Datang)
      const ptSel = document.getElementById('ptFilter');
      const ptVal = (ptSel && ptSel.value) ? ptSel.value : 'all';
      if (ptVal !== 'all'){
        base = (Array.isArray(base)?base:[]).filter(r => r._pt === ptVal);
      }
      const filtered = fastFilter(base, q);
      const start = (page-1)*rows; const end = start+rows;
      simpleTable('pmTable', columns, filtered.slice(start,end));
      const pages = Math.max(1, Math.ceil(filtered.length/rows));
      document.getElementById('pagination').innerHTML = Array.from({length: pages}, (_,i)=>`<button data-p='${i+1}' ${i+1===page?'style="font-weight:700"':''}>${i+1}</button>`).join(' ');
      document.querySelectorAll('#pagination button').forEach(b=>b.onclick = ()=>{ page = parseInt(b.getAttribute('data-p')); render();});
    }
    document.getElementById('search').oninput = debounce(render, 200);
    document.getElementById('rowsPerPage').onchange = (e)=>{ rows = parseInt(e.target.value); page=1; render(); };
    const pmCatEl = document.getElementById('pmCategory');
    if (pmCatEl){ pmCatEl.onchange = ()=>{
      category = pmCatEl.value; page=1;
      pmData = (category==='late'?datasetLate:(category==='week'?datasetWeek:(category==='upcoming'?datasetUpcoming:datasetAll)));
      render();
    }; }
    const ptEl = document.getElementById('ptFilter');
    if (ptEl){ ptEl.onchange = ()=>{ page=1; render(); }; }
    render();
  })(); });
  </script>
</body>
</html>