<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Records</title>
  <script src="/common.js" defer></script>
  <!-- Export libraries (lazy-loaded on demand); XLSX removed -->
  <script>
    (function(){
      function loadScript(src){
        return new Promise((resolve, reject)=>{
          const s=document.createElement('script'); s.src=src; s.async=true;
          s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed to load '+src));
          document.head.appendChild(s);
        });
      }
      window.ensureExcelJS = async function(){
        if (!window.ExcelJS){
          await loadScript('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
        }
        return window.ExcelJS;
      };
      window.ensureJsPDF = async function(){
        if (!(window.jspdf && window.jspdf.jsPDF)){
          await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
        }
        if (!window.__autoTableLoaded){
          await loadScript('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');
          window.__autoTableLoaded = true;
        }
        return window.jspdf && window.jspdf.jsPDF;
      };
    })();
  </script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    .container { padding: 16px; }
    .table-scroll { overflow:auto; border:1px solid #ddd; border-radius:8px; }
    .table-scroll { position: relative; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
    th { background:#fafafa; cursor:pointer; user-select:none; }
    input, select, button { padding:6px 8px; }
    /* Late PM date styling */
    .late-date { color:#dc2626; font-weight:600; }
    [data-theme="dark"] .late-date { color:#fca5a5; }
    /* Week/Upcoming date styling */
    .week-date { color:#ca8a04; font-weight:600; }
    [data-theme="dark"] .week-date { color:#fde68a; }
    .upcoming-date { color:#16a34a; font-weight:600; }
    [data-theme="dark"] .upcoming-date { color:#86efac; }
     .toolbar { display:flex; gap:6px; align-items:flex-end; margin-bottom:12px; flex-wrap:wrap; }
    .toolbar label { display:flex; flex-direction:column; font-size:12px; gap:4px; margin:0; }
    .toolbar label.date-field, .toolbar .date-field * { margin:0; padding:0; }
    .toolbar .date-field { margin-bottom:0; }
    .toolbar > * { margin:0; }
    .checks { display:flex; gap:8px; align-items:center; }
    /* Print styles for PDF export */
    @media print {
      th, td { border:1px solid #999 !important; }
      table { border:1px solid #999 !important; border-collapse:collapse; }
    }
    [data-theme="dark"] .muted { color:#fff !important; }

    /* Next PM fit konten (nowrap), Description & Recommendation sama lebar, Items Used cukup lega */
    /* Indeks kolom disesuaikan setelah menghapus kolom Location */
    /* Lebarkan kolom Forklift agar tidak dempet */
    #table table th:nth-child(4), #table table td:nth-child(4) { /* Forklift */
      width: 26%;
      white-space: normal;
    }
    #table table th:nth-child(6), #table table td:nth-child(6) { /* Next PM */
      width: 1%;
      min-width: 0;
      white-space: nowrap;
    }
    #table table th:nth-child(7), #table table td:nth-child(7) { /* Description */
      width: 26%;
      white-space: normal;
    }
    #table table th:nth-child(8), #table table td:nth-child(8) { /* Recommendation */
      width: 26%;
      white-space: normal;
    }
    #table table th:nth-child(9), #table table td:nth-child(9) { /* Items Used */
      width: 20%;
      min-width: 180px;
      white-space: normal;
      word-break: break-word;
    }
    .parts-list{ margin:0; padding-left:18px; }
    .parts-list li{ margin:0 0 4px; }
    
    /* Chips + Suggest untuk filter teknisi */
    .chips { display:flex; flex-wrap:wrap; gap:6px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; white-space:nowrap; }
    .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
    .chip .x:hover { color:#000; }
    .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:96px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
    .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
    .suggest .item:hover { background:#f6f9ff; }
    /* Dark mode: tone down suggest + modal edit */
    [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
    [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
    [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
    [data-theme="dark"] #editModal > div { background:#0f172a !important; color:#e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    [data-theme="dark"] #editModal h3 { color:#e5e7eb; }
    [data-theme="dark"] #editModal .muted,
    [data-theme="dark"] #editModal div[style*='color:#666'],
    [data-theme="dark"] #editModal div[style*='color:#777'] { color:#e5e7eb !important; }
    [data-theme="dark"] #editModal input,
    [data-theme="dark"] #editModal select,
    [data-theme="dark"] #editModal textarea { background:#0b1220; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }

    /* Rich text editor styles (seragam dengan jobs.html), posisi toolbar di atas editor */
    #editModal label.stack { display:flex; flex-direction:column; gap:6px; }
    .rte { width:100%; min-height: clamp(80px, 22vh, 160px); border:1px solid #eee; border-radius:6px; padding:6px; outline:none; }
    .rte:focus { border-color:#c5d9fd; box-shadow:0 0 0 2px #e8f0fe; }
    [data-theme="dark"] .rte { background:#0f172a; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] .rte:focus { border-color:#334155; box-shadow:0 0 0 2px #1f2937; }
    .rte-toolbar { display:flex; gap:6px; margin:4px 0 6px; flex-wrap:wrap; align-items:center; }
    .rte-toolbar button { padding: clamp(2px, 0.5vw, 6px) clamp(6px, 1vw, 10px); border:1px solid #ddd; background:#f7f7f7; border-radius:4px; cursor:pointer; font-size: clamp(11px, 1.6vw, 13px); }
    .rte-toolbar button:hover { background:#eee; }
    .rte-toolbar button.active { background:#e0e0e0; border-color:#ccc; }
    [data-theme="dark"] .rte-toolbar button { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] .rte-toolbar button:hover { background:#334155; }
    [data-theme="dark"] .rte-toolbar button.active { background:#374151; border-color:#334155; }

    /* Pastikan layout label di modal rapi (stacked) dan chips terlihat penuh */
    #editModal .input-suggest-wrap .clear-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; font-size:16px; color:#888; padding:2px; line-height:1; }
    #editModal .input-suggest-wrap .clear-btn:hover { color:#000; }
    [data-theme="dark"] #editModal .input-suggest-wrap .clear-btn { color:#e5e7eb; }
    #editModal .input-suggest-wrap input { padding-right: 28px; }
    #editModal .input-suggest-wrap.fk .clear-btn { left:4px; right:auto; }
    #editModal .input-suggest-wrap.fk input { padding-left:28px; padding-right:8px; }
    #editModal .chosen-row { display:flex; align-items:center; gap:8px; padding:6px 0; }
    #editModal .chosen-row .qty { width:72px; }
    #editModal .xbtn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; font-size:18px; line-height:1; }
    #editModal .xbtn:active { transform: scale(0.98); }
    #editModal .xbtn:focus { outline: 2px solid #c5d9fd; }
    [data-theme="dark"] #editModal .xbtn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    #editModal .xbtn { width:40px; height:40px; font-size:20px; }
    #editModal .input-suggest-wrap { position:relative; width:100%; }
    /* Batasi lebar wrapper forklift di modal agar dropdown tidak terlalu lebar pada layar lebar */
    #editModal .input-suggest-wrap.fk { max-width: 480px; }
    #editModal input#ed_teknisi_input { width:100%; box-sizing:border-box; min-height:32px; }
    #editModal [id='ed_teknisi_tags'] { min-height: 28px; }
    #ed_teknisi_tags .chip { pointer-events: none; }
    #ed_teknisi_tags .chip .x { pointer-events: auto; padding:0; margin-left:6px; width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; line-height:1; border-radius:50%; }
    /* Group untuk filter agar label dan input selalu bersama */
    .toolbar .filter-group { position:relative; display:flex; flex-direction:column; gap:4px; min-width:260px; max-width:460px; }
    /* Baris kedua toolbar: Keyword + Teknisi + Aksi (wrap agar tidak melebar) */
    .toolbar .toolbar-row { display:flex; gap:12px; align-items:flex-end; width:100%; flex-wrap:wrap; }
    .toolbar .field { display:flex; flex-direction:column; gap:4px; }
    .toolbar .toolbar-row .q-field { flex:1 1 260px; min-width:220px; }
    .toolbar .toolbar-row .tech-field { flex:1 1 260px; min-width:220px; }
    /* Samakan lebar field tanggal dengan Forklift & Cari Record */
    .toolbar .date-field { flex:1 1 260px; min-width:220px; max-width:460px; }
    .toolbar .date-field .date-input-wrap { width:100%; display:block; }
    .toolbar .date-field .date-input-wrap input[type="date"] { width:100%; box-sizing:border-box; height:36px; min-height:36px; line-height:36px; }
    .toolbar .filter-group .label-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .toolbar .filter-group .chips-inline { display:flex; gap:6px; flex-wrap:wrap; max-width: calc(100% - 80px); }
    .toolbar .filter-group .chips-inline .chip { background:#eee; border-color:#ddd; }
    .toolbar .filter-group .input-wrap { position:relative; }
    .toolbar .toolbar-row .actions { display:flex; gap:8px; flex:1 1 100%; flex-wrap:wrap; align-items:flex-start; }
    /* Samakan tinggi komponen aksi agar sejajar */
    .toolbar .toolbar-row .actions button,
    .toolbar .toolbar-row .actions select { height:36px; min-height:36px; }
    .toolbar .toolbar-row .actions .rows-group { display:inline-flex; align-items:center; gap:8px; height:36px; }
    .toolbar .toolbar-row .actions .rows-group select { width:96px; min-width:96px; height:36px; }
    /* Kelompok Rows (label + dropdown) agar berdekatan */
    .toolbar .toolbar-row .actions .rows-group { display:inline-flex; align-items:center; gap:8px; }
    .toolbar .toolbar-row .actions .rows-group select { width:96px; min-width:96px; }

    /* Responsive */
    @media (max-width: 768px){
      .container { padding:0 12px; }
      /* Hindari child melar penuh agar ikon kalender berada dekat input */
      .toolbar { display:grid; grid-template-columns: minmax(0,1fr); row-gap:6px; align-items:start; padding-right:6px; }
      .toolbar > * { width:100%; }
      /* Pastikan wrapper input tanggal tidak ikut melar pada mobile */
      .toolbar .date-input-wrap { align-self: flex-start; }
      .toolbar .toolbar-row { flex-wrap: wrap; }
      .toolbar .filter-group, .toolbar .toolbar-row .q-field, .toolbar .toolbar-row .tech-field, .toolbar .date-field { min-width: 0; width: 100%; max-width: 100%; }
      /* Actions jadi grid 2 kolom agar rapi dan panjang seragam */
      .toolbar .toolbar-row .actions { display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); gap:8px; width:100%; align-items:start; }
      .toolbar .toolbar-row .actions button { width:100%; height:36px; min-height:36px; }
      /* Jadikan kelompok Rows satu baris penuh di atas pasangan tombol */
      .toolbar .toolbar-row .actions .rows-group { grid-column: 1 / -1; }
      .toolbar .toolbar-row .actions .rows-group select { width:96px; }
      #table { overflow-x:auto; }
      /* Netralkan aturan width berbasis nth-child untuk mobile agar tidak bentrok saat re-order */
      #table table th, #table table td { width: auto !important; }
      /* Kecilkan dropdown forklift di modal edit pada mobile */
      #edFkSuggest { max-height: 30vh !important; -webkit-overflow-scrolling: touch; }
    }

    /* Ikon kalender kustom (seragam dengan jobs.html) */
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; filter: none !important; }
    .date-input-wrap { position: relative; display: inline-block; color:#111; }
    [data-theme="dark"] .date-input-wrap { color:#fff; }
    .date-input-wrap input[type="date"] { padding-right: 26px; }
    .date-input-wrap::after { content: ""; position:absolute; right:4px; top:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none; background-color: currentColor; -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; }

    /* Uniform action buttons size in table */
    #table table th:last-child, #table table td:last-child { white-space: nowrap; width: 1%; }
    #table td:last-child button + button { margin-top: 6px; }
    #table button { height: 32px; min-height: 32px; padding: 0 10px; box-sizing: border-box; display:flex; align-items:center; gap:6px; line-height:1; white-space: nowrap; }
    #table button.btn-ico svg { width:16px; height:16px; display:block; }
    #table td:last-child .action-btn { width:100%; }
    /* Subteks pada kolom Forklift */
    .subtext { color:#666; font-size:12px; }
    [data-theme="dark"] .subtext { color:#fff; }
    .tech-subtext { color:#444; font-size:14px; font-weight:600; line-height:1.25; }
    [data-theme="dark"] .tech-subtext { color:#fff; }
    /* Tag penanda baris arsip */
    .arsip-tag { display:inline-block; margin-left:6px; padding:2px 8px; border-radius:10px; font-size:11px; background:#eef2ff; color:#111; border:1px solid #dbeafe; }
    [data-theme="dark"] .arsip-tag { background:#1f2937; color:#e5e7eb; border-color:#374151; }
    /* Sticky columns visual fix: solid background and divider to avoid text overlap */
    .sticky-th, .sticky-cell { background:#fff !important; }
    [data-theme="dark"] .sticky-th, [data-theme="dark"] .sticky-cell { background:#0f172a !important; }
    .sticky-th { z-index:4 !important; box-shadow: 2px 0 0 #eee; }
    .sticky-cell { z-index:2 !important; box-shadow: 2px 0 0 #eee; }
    [data-theme="dark"] .sticky-th, [data-theme="dark"] .sticky-cell { box-shadow: 2px 0 0 #334155; }
    #table table th:nth-child(2), #table table td:nth-child(2) { /* Tanggal */
      width: 9%;
      min-width: 140px;
      white-space: normal;
    }
    .dd { position:relative; display:inline-block; }
    .dd .dd-btn { height:36px; min-height:36px; padding:8px 12px; border:1px solid #ddd; background:#f7f7f7; border-radius:6px; cursor:pointer; }
    .dd .dd-btn:hover { background:#eee; }
    .dd .dd-menu { display:none; position:absolute; z-index:1000; top:calc(100% + 6px); left:0; min-width:280px; max-width:480px; background:#fff; border:1px solid #e0e0e0; border-radius:6px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.12); }
    .dd.open .dd-menu { display:block; }
    [data-theme="dark"] .dd .dd-btn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] .dd .dd-btn:hover { background:#334155; }
    [data-theme="dark"] .dd .dd-menu { background:#0f172a; border-color:#334155; color:#e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    .btn{ padding:8px 12px; background:#1e88e5; color:#fff; border:0; border-radius:6px; cursor:pointer; display:inline-flex; align-items:center; gap:6px; white-space:nowrap; }
    .btn .ico svg{ width:16px; height:16px; display:block; }
    .btn-green{ background:#16a34a; }
    .btn-blue{ background:#0ea5e9; }
    .btn-red{ background:#b91c1c; }
    .btn-gray{ background:#374151; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    [data-theme="dark"] .btn { color:#fff; }
    [data-theme="dark"] .btn-green{ background:#16a34a; }
    [data-theme="dark"] .btn-blue{ background:#0ea5e9; }
    [data-theme="dark"] .btn-red{ background:#b91c1c; }
    .label-muted { font-size:12px; color:#666; }
    [data-theme="dark"] .label-muted { color:#fff; }
    .action-btn{ height:24px; min-height:24px; padding:0 6px; border-radius:6px; font-size:12px; color:#fff; border:0; width:auto; display:inline-flex; align-items:center; justify-content:center; }
    .footer-bar{ display:grid; grid-template-columns: 1fr auto; align-items:center; gap:8px; }
    .footer-bar .result-info{ justify-self:start; font-size:12px; color:#666; }
    [data-theme="dark"] .footer-bar .result-info{ color:#e5e7eb; }
    .pager-bar{ display:flex; align-items:center; gap:16px; justify-content:center; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="container">
    <h2>Service Records</h2>
    <div class="toolbar" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button id="gotoJobs" type="button" class="btn btn-green">Buat Jobs</button>
      <input id="q" placeholder="Cari Record" style="width:360px; max-width:40vw; min-width:220px; flex:0 0 auto;" />

      <div class="dd" id="filterDd">
        <button type="button" class="dd-btn">Filter</button>
        <div class="dd-menu">
          <div id="forkliftFilter" class="filter-group" style="margin-bottom:8px;">
            <div class="label-row">
              <div class="label-muted">Forklift</div>
              <div id="forklift_tags" class="chips chips-inline"></div>
            </div>
            <input id="forklift_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
            <div id="fkSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
          </div>
          <div id="teknisiFilter" class="filter-group field tech-field" style="margin-bottom:8px;">
            <div class="label-row">
              <div class="label-muted">Teknisi</div>
              <div id="teknisi_tags" class="chips chips-inline"></div>
            </div>
            <input id="teknisi_input" placeholder="Ketik untuk cari teknisi..." autocomplete="off" />
            <div id="techSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
          </div>
          <div id="jenisFilter" class="filter-group" style="margin-bottom:8px;">
            <div class="label-row">
              <div class="label-muted">Jenis Pekerjaan</div>
            </div>
            <div class="checks" id="jenisChecks" style="display:flex; gap:12px; align-items:center;">
              <label><input type="checkbox" value="PM" checked /> PM</label>
              <label><input type="checkbox" value="Lapangan" checked /> Lapangan</label>
              <label><input type="checkbox" value="Workshop" checked /> Workshop</label>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:8px;">
            <label class="date-field">Tanggal Mulai<div class="date-input-wrap"><input id="start" type="date" /></div></label>
            <label class="date-field">Tanggal Akhir<div class="date-input-wrap"><input id="end" type="date" /></div></label>
          </div>
          
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button id="apply">Reset</button>
          </div>
        </div>
      </div>

      <div class="dd" id="actionsDd" style="display:none;">
        <button type="button" class="dd-btn">Tindakkan</button>
        <div class="dd-menu">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button id="importExcel" class="btn btn-green"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M9 12h6"/><path d="M9 16h6"/></svg></span>Import Excel</button>
            <button id="exportCSV" class="btn"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/></svg></span>Export CSV</button>
            <button id="exportExcel" class="btn"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8"/><path d="M8 17h8"/></svg></span>Export Excel</button>
            <button id="exportPDF" class="btn"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="14" height="16" rx="2"/><path d="M17 8h4v12H7"/></svg></span>Export PDF</button>
            <button id="bulkDeleteBtn" class="btn btn-red"><span class="ico"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg></span>Hapus Terpilih</button>
          </div>
        </div>
      </div>
      <span id="archiveStatus" class="label-muted" style="display:none;"></span>
    </div>
    <div id="table"></div>
    <div id="footerBar" class="footer-bar" style="margin-top:8px;">
      <div id="resultInfo" class="resultInfo result-info"></div>
      <div id="pagerBar" class="pager-bar">
        <div id="rowsControl" class="rows-control" style="display:flex; align-items:center; gap:8px;">
          <label for="rowsPerPage" style="margin:0;">Rows</label>
          <select id="rowsPerPage">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="All">All</option>
          </select>
        </div>
        <div id="pagination"></div>
      </div>
    </div>

    <!-- Modal Detail Arsip (view-only) -->
    <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.3); align-items:center; justify-content:center;">
      <div style="background:#fff; padding:16px; width:720px; max-width:95vw; max-height:90vh; overflow:auto; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
        <h3 id="modalTitle" style="margin-top:0;">Detail Arsip</h3>
        <div id="modalBody" style="overflow:auto;"></div>
        <div style="margin-top:12px; text-align:right;">
          <button id="closeBtn">Tutup</button>
        </div>
      </div>
    </div>

    <!-- Modal Edit -->
    <div id="editModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); align-items:center; justify-content:center;">
      <div style="background:#fff; padding:16px; width:680px; max-width:95vw; max-height:90vh; overflow:auto; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.2);">
        <h3 style="margin-top:0;">Edit Record</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <label>Tanggal <div class="date-input-wrap"><input id="ed_tanggal" type="date" /></div></label>
          <label>Report No <input id="ed_report_no" /></label>
          <label>Forklift
            <div class="input-suggest-wrap fk" style="position:relative;">
              <input id="ed_forklift_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
              <button type="button" class="clear-btn" aria-label="Clear" title="Clear">&times;</button>
              <div id="edFkSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
            </div>
          </label>
          <label>Pekerjaan
            <select id="ed_pekerjaan">
              <option>PM</option>
              <option>Lapangan</option>
              <option>Workshop</option>
            </select>
          </label>
          <label id="ed_next_pm_wrap" style="display:none; grid-column: 2 / 3;">Next PM
            <div class="date-input-wrap"><input id="ed_next_pm" type="date" /></div>
          </label>
          <label for="ed_teknisi_input" style="grid-column: 1 / -1;">Teknisi</label>
          <div class="teknisi-field" style="grid-column: 1 / -1;">
            <div id="ed_teknisi_tags" class="chips"></div>
            <div class="input-suggest-wrap" style="position:relative;">
              <input id="ed_teknisi_input" placeholder="Ketik untuk cari teknisi..." autocomplete="off" />
              <div id="edTechSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
            </div>
            <div class="muted" style="font-size:11px; color:#777;">Klik hasil untuk menambahkan. Hapus dengan tanda × pada chip.</div>
          </div>
          <label>Location (Snapshot) <input id="ed_location" placeholder="Lokasi saat service (snapshot)" /></label>
          <label class="stack" style="grid-column: 1 / -1;">Description
            <div class="rte-toolbar">
              <button type="button" data-target="ed_description_rich" data-cmd="bold"><b>B</b></button>
              <button type="button" data-target="ed_description_rich" data-cmd="italic"><i>I</i></button>
              <button type="button" data-target="ed_description_rich" data-cmd="underline"><u>U</u></button>
              <button type="button" data-target="ed_description_rich" data-cmd="insertUnorderedList">• List</button>
              <button type="button" data-target="ed_description_rich" data-cmd="insertOrderedList">1. List</button>
            </div>
            <div id="ed_description_rich" class="rte" contenteditable="true"></div>
          </label>
          <label class="stack" style="grid-column: 1 / -1;">Recommendation
            <div class="rte-toolbar">
              <button type="button" data-target="ed_recommendation_rich" data-cmd="bold"><b>B</b></button>
              <button type="button" data-target="ed_recommendation_rich" data-cmd="italic"><i>I</i></button>
              <button type="button" data-target="ed_recommendation_rich" data-cmd="underline"><u>U</u></button>
              <button type="button" data-target="ed_recommendation_rich" data-cmd="insertUnorderedList">• List</button>
              <button type="button" data-target="ed_recommendation_rich" data-cmd="insertOrderedList">1. List</button>
            </div>
            <div id="ed_recommendation_rich" class="rte" contenteditable="true"></div>
          </label>
          <div id="ed_itemsChoiceWrap" style="grid-column: 1 / -1; display:none;">
            <div style="font-size:12px; color:#666; margin-bottom:4px;">Item dipakai (pilih dari katalog)</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div class="input-suggest-wrap" style="position:relative; flex:1;">
                <input id="ed_itemSearch" placeholder="Cari item..." autocomplete="off" />
                <div id="edItemSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
              </div>
              <div style="display:flex; gap:6px; align-items:center;">
                <label for="ed_itemQty" style="font-size:12px; color:#555;">Qty</label>
                <input id="ed_itemQty" type="number" min="1" value="1" />
              </div>
            </div>
            <div id="ed_chosenItems" style="margin-top:8px; max-height:240px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:6px;"></div>
            <div class="muted" style="font-size:11px; color:#777; margin-top:6px;">Ketik untuk mencari item, pilih untuk menambahkan. Anda bisa menghapus item terpilih.</div>
          </div>
          <label id="ed_itemsFreeWrap" style="grid-column: 1 / -1;" class="stack">Item dipakai (free text)
            <div class="rte-toolbar" id="ed_items_toolbar">
              <button type="button" data-target="ed_items_used_rich" data-cmd="bold"><b>B</b></button>
              <button type="button" data-target="ed_items_used_rich" data-cmd="italic"><i>I</i></button>
              <button type="button" data-target="ed_items_used_rich" data-cmd="underline"><u>U</u></button>
              <button type="button" data-target="ed_items_used_rich" data-cmd="insertUnorderedList">• List</button>
              <button type="button" data-target="ed_items_used_rich" data-cmd="insertOrderedList">1. List</button>
            </div>
            <div id="ed_items_used_rich" class="rte" contenteditable="true"></div>
          </label>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button id="btnCancelEdit">Batal</button>
          <button id="btnSaveEdit" style="background:#0d47a1; color:#fff;">Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{ (async function(){
    const user = await ensureAuthedAndRenderNav(); if (!user) return;
    const goJobs = document.getElementById('gotoJobs'); if (goJobs) goJobs.onclick = ()=>{ location.href = '/jobs.html'; };
    if (user.role === 'teknisi'){
      ['bulkDeleteBtn','importExcel'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.style.display='none'; el.disabled=true; } });
    }
    const forklifts = await api('/api/forklifts');
    const fkCache = Array.isArray(forklifts) ? forklifts : [];
    // Tambah: daftar items untuk chooser di modal edit
    const items = await api('/api/items');
    let edChosen = [];
    let edSelectedTech = [];
    let edItemsMode = 'free';
    // State: pilihan forklift pada modal edit (single-select)
    let edForkliftId = null;

    // small utility: debounce
    function makeDebounce(fn, delay=200){
      let t;
      return function(...args){
        clearTimeout(t);
        t = setTimeout(()=> fn.apply(this, args), delay);
      };
    }
    // preload ke modal

    // Input + suggest forklift untuk modal edit
    const edFkInput = document.getElementById('ed_forklift_input');
    const edFkSuggest = document.getElementById('edFkSuggest');
    const edFkClearBtn = document.querySelector('#editModal .input-suggest-wrap.fk .clear-btn');
    function syncEdFkClear(){ if (!edFkClearBtn) return; const hasVal = (edFkInput && (edFkInput.value||'').trim().length>0); edFkClearBtn.style.display = hasVal ? 'block' : 'none'; }
    if (edFkClearBtn){
      edFkClearBtn.onclick = (e)=>{ e.preventDefault(); if (edFkInput) { edFkInput.value=''; } edForkliftId=null; if (edFkSuggest) edFkSuggest.style.display='none'; if (edFkInput) edFkInput.focus(); syncEdFkClear(); };
    }
    syncEdFkClear();
    function fkLabel(f){ return [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - '); }
    function filterFk(q){
      const s = String(q||'').toLowerCase();
      if (!s) return fkCache;
      return fkCache.filter(f=>{
        const fields = [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=> String(v||'').toLowerCase());
        return fields.some(v=> v.includes(q));
      });
    }
    function renderEdFkSuggest(){
      if (!edFkInput || !edFkSuggest) return;
      const list = filterFk(edFkInput.value);
      if (!Array.isArray(list) || list.length===0){ edFkSuggest.style.display='none'; edFkSuggest.innerHTML=''; return; }
      edFkSuggest.innerHTML = list.map(f=>`<div class="item" data-id="${f.id}">${fkLabel(f)}</div>`).join('');
      edFkSuggest.style.display='block';
      // Drag guard untuk mencegah accidental tap saat scrolling (lebih ketat di modal edit)
      if (!edFkSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        edFkSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY || 0; dragging = false; }, { passive:true });
        edFkSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0) - startY) > 5) dragging = true; }, { passive:true });
        edFkSuggest._isDragging = ()=>dragging;
        edFkSuggest._dragGuardAttached = true;
      }
      edFkSuggest.querySelectorAll('.item').forEach(it=>{
        const chooseEdFk = (ev)=>{ // mobile-friendly: click dengan drag guard
          if (edFkSuggest._isDragging && edFkSuggest._isDragging()) { ev.preventDefault(); return; }
          const id = +it.getAttribute('data-id');
          const f = fkCache.find(x=>x.id===id); if (!f) return;
          edForkliftId = f.id;
          edFkInput.value = fkLabel(f);
          // Optional: isi location snapshot default dari forklift terpilih jika kosong
          const loc = document.getElementById('ed_location');
          if (loc && !loc.value){ loc.value = String(f.location||''); }
          edFkSuggest.style.display='none';
          syncEdFkClear();
        };
        // Hanya gunakan click, jangan pointerdown agar tidak mudah terpencet saat scroll
        it.onclick = chooseEdFk;
      });
    }
    if (edFkInput){
      const debouncedFkEd = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),200); }; })(renderEdFkSuggest);
      edFkInput.addEventListener('input', (e)=>{ debouncedFkEd(); syncEdFkClear(); });
      edFkInput.addEventListener('focus', ()=> { renderEdFkSuggest(); syncEdFkClear(); });
      edFkInput.addEventListener('click', ()=> { renderEdFkSuggest(); syncEdFkClear(); });
    }
    // Tap outside handler untuk menutup dropdown di modal edit
    const editModal = document.getElementById('editModal');
    if (editModal){
      editModal.addEventListener('pointerdown', (e)=>{
        const t = e.target;
        const inEdFk = t.closest && t.closest('#edFkSuggest, #ed_forklift_input');
        const inEdTech = t.closest && t.closest('#edTechSuggest, #ed_teknisi_input');
        const inEdItem = t.closest && t.closest('#edItemSuggest, #ed_itemSearch');
        if (!inEdFk && edFkSuggest){ edFkSuggest.style.display = 'none'; }
        if (!inEdTech && edTechSuggest){ edTechSuggest.style.display = 'none'; }
        if (!inEdItem && edItemSuggest){ edItemSuggest.style.display = 'none'; }
      });
      // Click-away: tutup modal jika klik di overlay (di luar konten)
      editModal.addEventListener('click', (ev)=>{
        if (ev.target === editModal){ editModal.style.display = 'none'; }
      });
    }

    // ===== Items chooser untuk modal edit (PM/Workshop) =====
    const edItemInput = document.getElementById('ed_itemSearch');
    const edItemSuggest = document.getElementById('edItemSuggest');
    const edItemQtyEl = document.getElementById('ed_itemQty');

    function sortByItemCodeAsc(a, b){
      const ac0 = String(a?.code||'').trim();
      const bc0 = String(b?.code||'').trim();
      if (!ac0 && !bc0) return 0;
      if (!ac0) return 1;
      if (!bc0) return -1;
      const ac = ac0.toUpperCase();
      const bc = bc0.toUpperCase();
      const ma = ac.match(/^([A-Z]+)(\d+)/);
      const mb = bc.match(/^([A-Z]+)(\d+)/);
      if (ma && mb){
        if (ma[1] !== mb[1]) return ma[1].localeCompare(mb[1]);
        const na = parseInt(ma[2], 10);
        const nb = parseInt(mb[2], 10);
        if (isNaN(na) && isNaN(nb)) return ac.localeCompare(bc);
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      }
      return ac.localeCompare(bc);
    }

    function sortItemsTmiFirst(a, b){
      const ac = String(a?.code||'');
      const bc = String(b?.code||'');
      const ta = /^TMI-(\d+)$/i.exec(ac.trim());
      const tb = /^TMI-(\d+)$/i.exec(bc.trim());
      const aIs = !!ta; const bIs = !!tb;
      if (aIs && !bIs) return -1;
      if (!aIs && bIs) return 1;
      if (aIs && bIs){
        const na = parseInt(ta[1], 10); const nb = parseInt(tb[1], 10);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        return ac.localeCompare(bc);
      }
      return sortByItemCodeAsc(a, b);
    }

    function renderEdItemSuggest(){
      if (!edItemInput || !edItemSuggest) return;
      const q = String(edItemInput.value||'').trim().toLowerCase();
      const list = (Array.isArray(items)?items:[])
        .filter(i=> !q || `${i.code} ${i.nama}`.toLowerCase().includes(q))
        .sort(sortItemsTmiFirst);
      if (!list.length){ edItemSuggest.style.display='none'; edItemSuggest.innerHTML=''; return; }
      edItemSuggest.innerHTML = list.map(i=>{
        const unavailable = String(i.status||'').toLowerCase()==='unavailable';
        const rowStyle = unavailable ? 'opacity:0.5;' : '';
        const statusBadge = unavailable ? " <span class='muted'>(unavailable)</span>" : '';
        return `<div class="item" data-id="${i.id}" data-unavail="${unavailable?1:0}" style="${rowStyle}">${i.code} - ${i.nama}${statusBadge}</div>`;
      }).join('');
      edItemSuggest.style.display='block';
      if (!edItemSuggest._dragGuardAttached){
        let startY=0, dragging=false;
        edItemSuggest.addEventListener('pointerdown', e=>{ startY=e.clientY||0; dragging=false; }, {passive:true});
        edItemSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY)>8) dragging=true; }, {passive:true});
        edItemSuggest._isDragging = ()=>dragging;
        edItemSuggest._dragGuardAttached = true;
      }
      edItemSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = (ev)=>{
          if (edItemSuggest._isDragging && edItemSuggest._isDragging()) { ev.preventDefault(); return; }
          const unavail = it.getAttribute('data-unavail')==='1'; if (unavail) return;
          const id = +it.getAttribute('data-id');
          const f = (items||[]).find(x=>x.id===id); if (!f) return;
          let qty = 1; if (edItemQtyEl){ qty = parseInt(edItemQtyEl.value||'1',10); if (!qty || qty<1) qty = 1; }
          const exist = (edChosen||[]).find(c=>c.id===id);
          if (exist){ exist.qty += qty; } else { edChosen.push({ id, code:f.code, nama:f.nama, qty }); }
          edRenderChosen();
          edItemInput.value = '';
          edItemSuggest.style.display='none';
        };
      });
    }

    (function ensureTmiTopOnFocus(){
      const inp = document.getElementById('ed_itemSearch');
      if (!inp) return;
      inp.addEventListener('focus', ()=>{ try { renderEdItemSuggest(); } catch {} });
    })();

    // Backward-compat wrapper to keep function name used elsewhere
    function edRenderItems(){ renderEdItemSuggest(); }
    function edRenderChosen(){
      const chosenEl = document.getElementById('ed_chosenItems'); if (!chosenEl) return;
      chosenEl.innerHTML = (edChosen||[]).map((c,idx)=>`
        <div class="chosen-row">
          <div style="flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis;">${c.code ? (c.code+' - '+c.nama) : (c.nama||'')}</div>
          <input class="qty" type="number" min="1" value="${c.qty}" data-row="${idx}" />
          <button class="xbtn" aria-label="Hapus item" title="Hapus" data-row="${idx}">&times;</button>
        </div>
      `).join('');
      chosenEl.querySelectorAll('button[data-row]').forEach(b=> b.onclick = ()=>{ const rid=+b.getAttribute('data-row'); edChosen.splice(rid,1); edRenderChosen(); });
      chosenEl.querySelectorAll('input[data-row]').forEach(inp=>{
        inp.oninput = ()=>{
          const rid = +inp.getAttribute('data-row');
          let v = parseInt(inp.value||'1',10); if (!v || v<1) v = 1; inp.value = String(v);
          const row = (edChosen||[])[rid]; if (row) row.qty = v;
        };
      });
    }
    const edJenisSel = document.getElementById('ed_pekerjaan');
    function edUpdateJenisUI(){
      const j = edJenisSel ? edJenisSel.value : '';
      const choice = document.getElementById('ed_itemsChoiceWrap');
      const free = document.getElementById('ed_itemsFreeWrap');
      const nextPmWrap = document.getElementById('ed_next_pm_wrap');
      const mode = edItemsMode || ((j==='Workshop') ? 'choice' : 'free');
      if (choice) choice.style.display = (mode==='choice') ? 'block' : 'none';
      if (free) free.style.display = (mode==='free') ? 'block' : 'none';
      if (nextPmWrap) nextPmWrap.style.display = (j==='PM') ? 'block' : 'none';
    }
    if (edJenisSel){ edJenisSel.addEventListener('change', ()=>{ edUpdateJenisUI(); }); }
    const edSearch = document.getElementById('ed_itemSearch');
    if (edSearch){
      const debouncedEdItems = makeDebounce(renderEdItemSuggest, 200);
      edSearch.addEventListener('input', debouncedEdItems);
      edSearch.addEventListener('focus', ()=> renderEdItemSuggest());
      edSearch.addEventListener('click', ()=> renderEdItemSuggest());
      edSearch.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = edItemSuggest && edItemSuggest.querySelector('.item[data-unavail="0"]');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (edItemSuggest) edItemSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (edItemSuggest && !edItemSuggest.contains(e.target) && e.target!==edSearch){ edItemSuggest.style.display='none'; } });
    }
    // (fix) remove erroneous block that referenced techInput/fetchAndRenderTech for modal edit
    const edTechInput = document.getElementById('ed_teknisi_input');
    const edTechSuggest = document.getElementById('edTechSuggest');
    const edTechTags = document.getElementById('ed_teknisi_tags');

    function renderEdTechTags(){
      if (!edTechTags) return;
      const esc = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      edTechTags.innerHTML = (edSelectedTech||[]).map((t,i)=>{
        const lbl = String(t.label||'');
        const idAttr = (t.id!=null ? t.id : '');
        return `<span class="chip" data-id="${idAttr}">${esc(lbl)} <button class="x" title="Hapus" data-idx="${i}">×</button></span>`;
      }).join('');
      edTechTags.querySelectorAll('button[data-idx]').forEach(b=>{
        b.onclick = (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          const idx = parseInt(b.getAttribute('data-idx'),10);
          if (!Number.isNaN(idx)){
            edSelectedTech.splice(idx,1);
          }
          renderEdTechTags();
        };
      });
    }

    // ===== Rich Text Editor helpers (adopted from jobs.html) =====
    function sanitizeHTML(html){
      const allowed = new Set(['B','I','U','BR','P','UL','OL','LI','STRONG','EM']);
      const div = document.createElement('div');
      div.innerHTML = html;
      const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null);
      const toRemove = [];
      let node;
      while(node = walker.nextNode()){
        if (!allowed.has(node.tagName)) toRemove.push(node);
        else {
          while(node.attributes && node.attributes.length>0){ node.removeAttribute(node.attributes[0].name); }
        }
      }
      toRemove.forEach(n=> n.replaceWith(document.createTextNode(n.textContent || '')));
      return div.innerHTML.replace(/\u00A0/g, ' ').trim();
    }

    function getRteValue(id){
      const el = document.getElementById(id);
      return sanitizeHTML(el ? (el.innerHTML||'') : '');
    }

    function getActiveRteId(){
      const sel = document.getSelection();
      if (!sel || !sel.anchorNode) return null;
      let n = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
      while(n && n !== document){
        if (n.getAttribute && n.getAttribute('contenteditable')==='true') return n.id;
        n = n.parentElement;
      }
      return null;
    }

    function updateToolbarState(){
      const activeId = getActiveRteId();
      const commands = ['bold','italic','underline','insertUnorderedList','insertOrderedList'];
      document.querySelectorAll('#editModal .rte-toolbar button').forEach(btn=>{
        const target = btn.dataset.target;
        const cmd = btn.dataset.cmd;
        if (target===activeId && commands.includes(cmd)){
          let on = false; try { on = document.queryCommandState(cmd); } catch (e) {}
          btn.classList.toggle('active', !!on);
        } else {
          btn.classList.remove('active');
        }
      });
    }
    document.querySelectorAll('#editModal .rte-toolbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        target.focus();
        try { document.execCommand(btn.dataset.cmd, false, null); } catch (e) {}
        updateToolbarState();
      });
    });
    document.addEventListener('selectionchange', updateToolbarState);

    const fetchAndRenderEdTech = async ()=>{
      if (!edTechInput || !edTechSuggest) return;
      const q = (edTechInput.value||'').trim();
      let list = [];
      try {
        const url = q ? ('/api/technicians?q='+encodeURIComponent(q)) : '/api/technicians';
        list = await api(url);
      } catch(e) { list = []; }
      if (!Array.isArray(list) || list.length===0){ edTechSuggest.style.display='none'; edTechSuggest.innerHTML=''; return; }
      const esc = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      edTechSuggest.innerHTML = list.map(t=>{
        const label = (t.name && t.name.trim()) ? t.name.trim() : String(t.email||'').trim();
        return `<div class="item" data-id="${t.id}">${esc(label)}</div>`;
      }).join('');
      edTechSuggest.style.display='block';
      if (!edTechSuggest._dragGuardAttached){
        let startY=0, dragging=false;
        edTechSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY||0; dragging=false; }, {passive:true});
        edTechSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging=true; }, {passive:true});
        edTechSuggest._isDragging = ()=>dragging;
        edTechSuggest._dragGuardAttached = true;
      }
      edTechSuggest.querySelectorAll('.item').forEach(it=>{
        const choose = (ev)=>{
          if (edTechSuggest._isDragging && edTechSuggest._isDragging()) { ev.preventDefault(); return; }
          const id = +it.getAttribute('data-id');
          const t = list.find(x=>x.id===id);
          if (!t) return;
          const label = (t.name && t.name.trim()) ? t.name.trim() : String(t.email||'').trim();
          const exists = (edSelectedTech||[]).some(x=> (t.id!=null && x.id!=null) ? String(x.id)===String(t.id) : (String(x.label||'').toLowerCase()===String(label).toLowerCase()));
          if (!exists){
            if (!Array.isArray(edSelectedTech)) edSelectedTech = [];
            edSelectedTech.push({ id:t.id, label });
            renderEdTechTags();
          }
          edTechInput.value = '';
          edTechSuggest.style.display='none';
          edTechInput.focus();
          // Tampilkan lagi dropdown agar user bisa lanjut memilih dengan cepat
          fetchAndRenderEdTech();
        };
        it.onclick = choose;
      });
    }

    if (edTechInput){
      const debouncedEd = makeDebounce(fetchAndRenderEdTech, 250);
      edTechInput.addEventListener('input', debouncedEd);
      edTechInput.addEventListener('focus', ()=>{ fetchAndRenderEdTech(); });
      edTechInput.addEventListener('click', ()=>{ fetchAndRenderEdTech(); });
      edTechInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = edTechSuggest && edTechSuggest.querySelector('.item');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (edTechSuggest) edTechSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{
        if (edTechSuggest && !edTechSuggest.contains(e.target) && e.target!==edTechInput){ edTechSuggest.style.display='none'; }
      });
      // Proteksi: klik pada label/teks bantuan/area field teknisi tidak melakukan apapun pada chips
      const teknisiField = document.querySelector('.teknisi-field');
      const teknisiLabel = document.querySelector('label[for="ed_teknisi_input"]');
      [teknisiField, teknisiLabel].forEach(el=>{
        if (!el) return;
        el.addEventListener('click', (ev)=>{
          // Biarkan default (mis. fokus input) tapi jangan propagasi ke listener global lain
          if (ev.target && (ev.target.classList && ev.target.classList.contains('x'))) return; // tombol X tetap lanjut
          ev.stopPropagation();
        });
      });
    }

    // ================= Records Table State & Functions =================
    // Global/state for records page
    let data = [];
    let page = 1;
    let rowsPerPage = 25;
    let sortKey = 'tanggal';
    let sortDir = 'desc';
    let selected = new Set();
    let currentRows = [];
    let archiveCache = { rows: [], loaded: false, loading: false };

    function setArchiveStatus(t){ const el = document.getElementById('archiveStatus'); if (el){ el.textContent = t||''; el.style.display = t ? '' : 'none'; } }
    function mapArchiveRow(ar, src){ const isMaint = src==='maintenance'; const tag = isMaint ? 'Arsip PM/Lapangan' : 'Arsip Workshop'; return {
      id: -(100000 + (parseInt(ar.id,10)||0)),
      tanggal: ar.job_date || '',
      report_no: ar.job_no || '',
      forklift: (ar.forklift || ''),
      forklift_id: ar.forklift_id || null,
      forklift_eq_no: ar.forklift_eq_no || '',
      pekerjaan: isMaint ? 'PM/Lapangan' : 'Workshop',
      teknisi: '',
      next_pm: ar.next_pm || '',
      description: ar.description || '',
      recommendation: isMaint ? (ar.recommendation || '') : '',
      items_used: '',
      __arsip: true,
      __arsip_source: src,
      __arsip_id: ar.id,
      __arsip_tag: tag,
      forklift_owner: '',
      forklift_location_fk: '',
      forklift_serial: ar.forklift_serial || '',
      forklift_powertrain: '',
    }; }
    function filterArchiveRows(rows, filters){ const { jenisVals, fkIdSet, q, start, end } = filters; let out = rows; if (Array.isArray(jenisVals) && jenisVals.length && jenisVals.length<3){ const set = new Set(jenisVals.map(x=>String(x).toLowerCase())); out = out.filter(r=> set.has(String(r.pekerjaan||'').toLowerCase())); } if (fkIdSet && fkIdSet.size>0){ const selIds = new Set(fkIdSet); const fkEqNos = new Set(Array.from(selIds).map(id=>{ try { const f = (fkCache||[]).find(x=>x.id===id); return String(f?.eq_no||'').trim().toLowerCase(); } catch { return ''; } }).filter(Boolean)); const fkSerials = new Set(Array.from(selIds).map(id=>{ try { const f = (fkCache||[]).find(x=>x.id===id); return String(f?.serial||'').trim().toLowerCase(); } catch { return ''; } }).filter(Boolean)); out = out.filter(r=>{ const idMatch = !!r.forklift_id && selIds.has(r.forklift_id); const eqMatch = r.forklift_eq_no && fkEqNos.has(String(r.forklift_eq_no).trim().toLowerCase()); const serialMatch = r.forklift_serial && fkSerials.has(String(r.forklift_serial).trim().toLowerCase()); return idMatch || eqMatch || serialMatch; }); } if (q){ const qq = String(q).toLowerCase(); out = out.filter(r=> String(r.report_no||'').toLowerCase().includes(qq) || String(r.forklift||'').toLowerCase().includes(qq) || String(r.description||'').toLowerCase().includes(qq) || String(r.recommendation||'').toLowerCase().includes(qq)); } if (start){ out = out.filter(r=> String(r.tanggal||'') >= String(start)); } if (end){ out = out.filter(r=> String(r.tanggal||'') <= String(end)); } return out; }
    async function ensureArchiveLoaded(){ if (archiveCache.loaded || archiveCache.loading) return; archiveCache.loading = true; setArchiveStatus('Memuat arsip...'); const all = []; const fetchSrc = async (src)=>{ let offset=0; const limit=1000; let total=0; for(;;){ const qs = new URLSearchParams(); qs.set('job_source', src); qs.set('limit', String(limit)); qs.set('offset', String(offset)); try{ const resp = await api('/api/archive/jobs?' + qs.toString()); const arr = Array.isArray(resp?.rows) ? resp.rows : (Array.isArray(resp) ? resp : []); for (const ar of arr) all.push(mapArchiveRow(ar, src)); if (Array.isArray(resp?.rows) && typeof resp?.total==='number') total = resp.total; if (arr.length < limit) break; offset += limit; if (total && offset>=total) break; }catch(e){ console.warn('Gagal fetch arsip', src, e); break; } } }; await Promise.all([fetchSrc('maintenance'), fetchSrc('workshop')]); archiveCache.rows = all; archiveCache.loaded = true; archiveCache.loading = false; setArchiveStatus(''); try{ const filters = getFilters(); const rowsActive = data.filter(r=> !r.__arsip); const merged = rowsActive.concat(filterArchiveRows(archiveCache.rows, filters)); data = sortRows(merged); indexRows(data); render(); }catch{} }

    // Indexing ringan untuk pencarian/penyaringan cepat (internal)
    function indexRows(rows){
      if (!Array.isArray(rows)) return;
      for (const r of rows){
        r._q = [r.tanggal, r.report_no, r.forklift, r.forklift_owner, r.forklift_location_fk, r.forklift_serial, r.forklift_powertrain, r.pekerjaan, r.teknisi, r.next_pm, r.description, r.recommendation, r.items_used]
          .map(v=> String(v||'').toLowerCase())
          .join(' ');
      }
    }

    // Columns for table and export (keep keys in sync with export handlers)
    function escHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function formatTanggalDisplay(str){ const s = String(str||'').trim(); if(!s) return ''; const d = new Date(s); if(!Number.isNaN(d.getTime())){ const day = String(d.getDate()).padStart(2,'0'); const month = d.toLocaleString('id-ID',{ month:'short' }); const year = d.getFullYear(); return `${day} ${month} ${year}`; } return s; }
    function normalizeParts(raw){ const s = String(raw||'').trim(); if(!s) return []; const looksHtml = /<\s*(ul|ol|li)\b/i.test(s); if(looksHtml){ const t = s.replace(/<br\s*\/?\s*>/gi,'\n'); const cleaned = t.replace(/<(?!\/?(ul|ol|li)\b)[^>]*>/gi,'').replace(/<\/?(ul|ol)\b[^>]*>/gi,'').replace(/<li[^>]*>/gi,'\n').replace(/<\/li>/gi,'\n').replace(/\r?\n+/g,'\n'); return cleaned.split('\n').map(x=>x.trim()).filter(Boolean); } else { return s.split(/\r?\n|,/).map(x=>x.trim()).filter(Boolean); } }
    function renderPartsCell(row){ const items = normalizeParts(row.items_used); if(items.length===0) return ''; return '<ul class="parts-list">'+ items.map(i=> '<li>'+ escHtml(i) +'</li>').join('') +'</ul>'; }
    const columns = [
      { key: '__sel', label: '' },
      { key: 'tanggal', label: 'Tanggal' },
      { key: 'report_no', label: 'Report No' },
      { key: 'forklift', label: 'Forklift' },
      { key: 'pekerjaan', label: 'Jenis' },
      { key: 'next_pm', label: 'Next PM' },
      { key: 'description', label: 'Pekerjaan' },
      { key: 'recommendation', label: 'Recommendation' },
      { key: 'items_used', label: 'Parts', render: renderPartsCell },
      { key: 'actions', label: '' },
    ];
    // Khusus mobile: urutan kolom diubah menjadi Sel, Tanggal, Forklift, Pekerjaan, Report No, dst
    const columnsMobile = [
      { key: '__sel', label: '' },
      { key: 'tanggal', label: 'Tanggal' },
      { key: 'forklift', label: 'Forklift' },
      { key: 'pekerjaan', label: 'Jenis' },
      { key: 'report_no', label: 'Report No' },
      { key: 'next_pm', label: 'Next PM' },
      { key: 'description', label: 'Pekerjaan' },
      { key: 'recommendation', label: 'Recommendation' },
      { key: 'items_used', label: 'Parts', render: renderPartsCell },
      { key: 'actions', label: '' },
    ];

    // Forklift filter UI (multi-select chips + suggest)
    const fkInput = document.getElementById('forklift_input');
    const fkTags = document.getElementById('forklift_tags');
    const fkSuggest = document.getElementById('fkSuggest');
    let selectedForklifts = [];

    function renderFkTags(){
      if (!fkTags) return;
      fkTags.innerHTML = (selectedForklifts||[]).map(f=>`<span class="chip" data-id="${f.id}">${f.label} <button class="x" title="Hapus" data-rem="${f.id}">×</button></span>`).join('');
      fkTags.querySelectorAll('button[data-rem]').forEach(b=>{
        b.onclick = ()=>{ const id = +b.getAttribute('data-rem'); selectedForklifts = (selectedForklifts||[]).filter(x=>x.id!==id); renderFkTags(); load(); };
      });
    }

    function filterForkliftList(query){
      const q = String(query||'').trim().toLowerCase();
      if (!q) return fkCache;
      return fkCache.filter(f=>{
        const fields = [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=> String(v||'').toLowerCase());
        return fields.some(v=> v.includes(q));
      });
    }

    function fetchAndRenderFk(){
      if (!fkInput || !fkSuggest) return;
      const list = filterForkliftList(fkInput.value);
      if (!Array.isArray(list) || list.length===0){ fkSuggest.style.display='none'; fkSuggest.innerHTML=''; return; }
      fkSuggest.innerHTML = list.map(f=>{
        const label = [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - ');
        return `<div class="item" data-id="${f.id}">${label}</div>`;
      }).join('');
      fkSuggest.style.display='block';
      if (!fkSuggest._dragGuardAttached){
        let startY=0, dragging=false;
        fkSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY||0; dragging=false; }, {passive:true});
        fkSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging=true; }, {passive:true});
        fkSuggest._isDragging = ()=>dragging;
        fkSuggest._dragGuardAttached = true;
      }
      fkSuggest.querySelectorAll('.item').forEach(it=>{
        const chooseFk = (ev)=>{
          if (fkSuggest._isDragging && fkSuggest._isDragging()) { ev.preventDefault(); return; }
          const id = +it.getAttribute('data-id');
          const f = fkCache.find(x=>x.id===id);
          if (!f) return;
          if (!selectedForklifts.some(x=>x.id===f.id)){
            const label = [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - ');
            selectedForklifts.push({ id:f.id, label });
            renderFkTags();
            load();
          }
          fkInput.value=''; fkSuggest.style.display='none'; fkInput.focus();
        };
        it.onclick = chooseFk;
      });
    }

    if (fkInput){
      const debouncedFk = makeDebounce(fetchAndRenderFk, 200);
      fkInput.addEventListener('input', debouncedFk);
      fkInput.addEventListener('focus', ()=> fetchAndRenderFk());
      fkInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = fkSuggest && fkSuggest.querySelector('.item');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (fkSuggest) fkSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (fkSuggest && !fkSuggest.contains(e.target) && e.target!==fkInput){ fkSuggest.style.display='none'; } });
    }

    // ================= Filter Teknisi (chips + suggest) untuk halaman utama =================
const techInput = document.getElementById('teknisi_input');
const techSuggest = document.getElementById('techSuggest');
const techTags = document.getElementById('teknisi_tags');
let selectedTech = [];

function renderTechTags(){
  if (!techTags) return;
  const esc = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  techTags.innerHTML = (selectedTech||[]).map((t,i)=>{
    const lbl = String(t.label||'');
    return `<span class="chip" data-idx="${i}">${esc(lbl)} <button class="x" title="Hapus" data-idx="${i}">×</button></span>`;
  }).join('');
  techTags.querySelectorAll('button[data-idx]').forEach(b=>{
    b.onclick = (ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      const idx = parseInt(b.getAttribute('data-idx'),10);
      if (!Number.isNaN(idx)) selectedTech.splice(idx,1);
      renderTechTags();
      load();
    };
  });
}

const fetchAndRenderTech = async ()=>{
  if (!techInput || !techSuggest) return;
  const q = (techInput.value||'').trim();
  let list = [];
  try{
    const url = q ? ('/api/technicians?q='+encodeURIComponent(q)) : '/api/technicians';
    list = await api(url);
  }catch(e){ list = []; }
  if (!Array.isArray(list) || list.length===0){ techSuggest.style.display='none'; techSuggest.innerHTML=''; return; }
  const esc = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  techSuggest.innerHTML = list.map(t=>{
    const label = (t.name && t.name.trim()) ? t.name.trim() : String(t.email||'').trim();
    return `<div class="item" data-id="${t.id}">${esc(label)}</div>`;
  }).join('');
  techSuggest.style.display='block';
  if (!techSuggest._dragGuardAttached){
    let startY=0, dragging=false;
    techSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY||0; dragging=false; }, {passive:true});
    techSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging=true; }, {passive:true});
    techSuggest._isDragging = ()=>dragging;
    techSuggest._dragGuardAttached = true;
  }
  techSuggest.querySelectorAll('.item').forEach(it=>{
    const chooseTech = (ev)=>{
      if (techSuggest._isDragging && techSuggest._isDragging()) { ev.preventDefault(); return; }
      const id = +it.getAttribute('data-id');
      const t = list.find(x=>x.id===id);
      if (!t) return;
      const label = (t.name && t.name.trim()) ? t.name.trim() : String(t.email||'').trim();
      const exists = (selectedTech||[]).some(x=> (t.id!=null && x.id!=null) ? String(x.id)===String(t.id) : (String(x.label||'').toLowerCase()===String(label).toLowerCase()));
      if (!exists){
        if (!Array.isArray(selectedTech)) selectedTech = [];
        selectedTech.push({ id:t.id, label });
        renderTechTags();
        load();
      }
      techInput.value = '';
      techSuggest.style.display='none';
      techInput.focus();
      // tampilkan lagi agar bisa memilih beruntun
      fetchAndRenderTech();
    };
    it.onclick = chooseTech;
  });
};

if (techInput){
  const debouncedTech = makeDebounce(fetchAndRenderTech, 250);
  techInput.addEventListener('input', debouncedTech);
  techInput.addEventListener('focus', ()=>{ fetchAndRenderTech(); });
  techInput.addEventListener('click', ()=>{ fetchAndRenderTech(); });
  techInput.addEventListener('keydown', (e)=>{
    if (e.key==='Enter'){
      const first = techSuggest && techSuggest.querySelector('.item');
      if (first){ first.click(); e.preventDefault(); }
    }
    if (e.key==='Escape'){ if (techSuggest) techSuggest.style.display='none'; }
  });
  document.addEventListener('click', (e)=>{
    if (techSuggest && !techSuggest.contains(e.target) && e.target!==techInput){ techSuggest.style.display='none'; }
  });
}

// Helper: tokens from technician label
function parseTechLabelTokens(label){
  const m = /^(.*?)(?:\s*<([^>]+)>)?$/.exec(String(label||''));
  const name = (m && m[1] || '').trim().toLowerCase();
  const email = (m && m[2] || '').trim().toLowerCase();
  return { name, email };
}

function getFilters(){
  const q = (document.getElementById('q')?.value||'').trim();
  const start = document.getElementById('start')?.value || '';
  const end = document.getElementById('end')?.value || '';
  const jenisVals = Array.from(document.querySelectorAll('#jenisChecks input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
  const techTokens = (selectedTech||[]).map(t=> parseTechLabelTokens(t.label));
  const fkIdSet = new Set((selectedForklifts||[]).map(f=>f.id));
  return { q, start, end, jenisVals, techTokens, fkIdSet };
}

function sortRows(rows){
  const arr = rows.slice();
  const dir = sortDir==='asc' ? 1 : -1;
  arr.sort((a,b)=>{
    const va = (a[sortKey]??'');
    const vb = (b[sortKey]??'');
    if (va==vb) return 0;
    return (va>vb?1:-1) * dir;
  });
  return arr;
}

async function load(){
  try{
    const { q, start, end, jenisVals, techTokens, fkIdSet } = getFilters();
    const params = new URLSearchParams();
    if (q) params.set('q', q);
    if (start) params.set('start', start);
    if (end) params.set('end', end);
    // Ambil semua records lalu filter client-side untuk teknisi & forklift multi-select
    const url = '/api/records' + (params.toString()?('?' + params.toString()):'');
    let rows = await api(url);
    if (!Array.isArray(rows)) rows = [];
    // Filter by jenis (client-side)
    if (Array.isArray(jenisVals) && jenisVals.length && jenisVals.length<3){
      const set = new Set(jenisVals.map(x=>String(x).toLowerCase()));
      rows = rows.filter(r=> set.has(String(r.pekerjaan||'').toLowerCase()));
    }
    // Filter by selected forklifts (client-side OR)
    if (fkIdSet && fkIdSet.size>0){
      rows = rows.filter(r=> fkIdSet.has(r.forklift_id));
    }
    // Filter by selected technicians (client-side OR)
    if (Array.isArray(techTokens) && techTokens.length>0){
      rows = rows.filter(r=>{
        const t = String(r.teknisi||'').toLowerCase();
        return techTokens.some(tok=> (tok.email && t.includes(tok.email)) || (tok.name && t.includes(tok.name)) );
      });
    }

    if (archiveCache.loaded){ rows = rows.concat(filterArchiveRows(archiveCache.rows, { q, start, end, jenisVals, fkIdSet })); }
    // Apply sorting
    data = sortRows(rows);
    indexRows(data);
    page = 1;
    render();
    ensureArchiveLoaded();
  } catch(e){
    console.error('Load records error:', e);
    setArchiveStatus(e && e.error ? String(e.error) : 'Gagal memuat data');
  }
}

function render(){
  perfStart && perfStart('records.render');
  const allMode = (rowsPerPage === 'All');
  const startIdx = allMode ? 0 : (page-1)*rowsPerPage;
  const endIdx = allMode ? data.length : (startIdx + rowsPerPage);
  currentRows = data.slice(startIdx, endIdx).map(x=>Object.assign({}, x));
  const isMobile = window.matchMedia('(max-width: 768px)').matches;
  const cols = isMobile ? columnsMobile : columns;
  const header = '<thead><tr>' + cols.map(c=>{
    if (c.key==='__sel') return '<th class="sel-header" style="cursor:pointer" title="Pilih semua di halaman">Sel</th>';
    if (c.key==='actions') return '<th></th>';
    const arrow = sortKey===c.key ? (sortDir==='asc'?' ▲':' ▼') : '';
    return `<th data-key="${c.key}">${c.label}${arrow}</th>`;
  }).join('') + '</tr></thead>';

  const body = '<tbody>' + currentRows.map(row=>{
    const cb = row.__arsip ? `<input type="checkbox" disabled />` : `<input type="checkbox" data-id="${row.id}" ${selected.has(row.id)?'checked':''}/>`;
    let actions;
    if (row.__arsip){
      const src = row.__arsip_source || 'maintenance';
      actions = `<button class="action-btn" style="background:#0ea5e9;" data-arch="${row.__arsip_id}" data-src="${src}">View</button>`;
    } else {
      if (user.role==='admin'||user.role==='supervisor') {
        actions = `<button class="action-btn" style="background:#0ea5e9;" data-edit="${row.id}">Edit</button> <button class="action-btn" style="background:#b91c1c;" data-del="${row.id}">Hapus</button>`;
      } else if (user.role==='teknisi') {
        const t = String(row.teknisi||'').toLowerCase();
        const email = String(user.email||'').toLowerCase();
        const name = String(user.name||'').toLowerCase();
        const assigned = t.includes(email) || (!!name && t.includes(name));
        actions = assigned ? `<button class="action-btn" style="background:#0ea5e9;" data-edit="${row.id}">Edit</button> <button class="action-btn" style="background:#b91c1c;" data-del="${row.id}">Hapus</button>` : `<button class="action-btn" style="background:#0ea5e9;" data-detail="${row.id}">Detail</button>`;
      } else {
        actions = `<button class="action-btn" style="background:#0ea5e9;" data-detail="${row.id}">Detail</button>`;
      }
    }
    // Highlight Next PM yang terlambat (sebelum hari ini)
    const nextPmRaw = row.next_pm || '';
    let nextPmCell = nextPmRaw || '';
    if (nextPmRaw) {
      const d = new Date(nextPmRaw);
      if (!Number.isNaN(d.getTime())){
        const today = new Date(); today.setHours(0,0,0,0);
        const next7 = new Date(today); next7.setDate(today.getDate()+7);
        d.setHours(0,0,0,0);
        if (d < today) {
          nextPmCell = `<span class="late-date">${nextPmRaw}</span>`;
        } else if (d <= next7) {
          nextPmCell = `<span class="week-date">${nextPmRaw}</span>`;
        } else {
          nextPmCell = `<span class="upcoming-date">${nextPmRaw}</span>`;
        }
      }
    }
    const fkObj = fkCache.find && fkCache.find(x=>x.id===row.forklift_id);
    const fkObjFallback = (()=>{
      if (fkObj) return null;
      const eq = String(row.forklift_eq_no||'').trim().toLowerCase();
      const sn = String(row.forklift_serial||'').trim().toLowerCase();
      const byEq = (eq && fkCache.find) ? fkCache.find(x=> String(x.eq_no||'').trim().toLowerCase()===eq) : null;
      if (byEq) return byEq;
      const bySn = (sn && fkCache.find) ? fkCache.find(x=> String(x.serial||'').trim().toLowerCase()===sn) : null;
      return bySn || null;
    })();
    const eqFromRow = String(row.forklift_eq_no||'').trim();
    const eqFromFk = fkObj && String(fkObj.eq_no||'').trim();
    const eqFromLabel = (()=>{ const m = String(row.forklift||'').match(/\(([^)]+)\)\s*$/); return m ? String(m[1]||'').trim() : ''; })();
    let forkliftText = (eqFromRow || eqFromFk || eqFromLabel || '').trim();
    const brandType = (()=>{
      const src = fkObj || fkObjFallback;
      const bt = [src && src.brand, src && src.type].map(v=>String(v||'').trim()).filter(Boolean).join(' ').trim();
      if (bt) return bt;
      const f = String(row.forklift||'').trim();
      return f ? f.replace(/\s*\([^)]*\)\s*$/, '').trim() : '';
    })();
    const owner = String(row.forklift_owner||((fkObj||fkObjFallback)&&((fkObj||fkObjFallback).owner))||'').trim();
    const floc = String(row.forklift_location||row.forklift_location_fk||((fkObj||fkObjFallback)&&((fkObj||fkObjFallback).location))||'').trim();
    if (!forkliftText) forkliftText = floc;
    const serial = String(row.forklift_serial||((fkObj||fkObjFallback)&&((fkObj||fkObjFallback).serial))||'').trim();
    const powertrain = String(row.forklift_powertrain||((fkObj||fkObjFallback)&&((fkObj||fkObjFallback).powertrain))||'').trim();
    const details = [floc].filter(Boolean).join(' / ');
    const extra = [powertrain].filter(Boolean).join(' · ');
    const sub = [brandType, details, extra].filter(Boolean).join(' — ');
    const forkliftCell = sub ? `<div>${forkliftText}<div class='subtext'>${sub}</div></div>` : forkliftText;
    const pekerjaanCell = row.__arsip ? `${row.pekerjaan||''} <span class="arsip-tag">${row.__arsip_tag||'Arsip'}</span>` : (row.pekerjaan||'');
    function tdFor(key){
      switch(key){
        case '__sel': return `<td>${cb}</td>`;
        case 'tanggal': { const t = formatTanggalDisplay(row.tanggal); const tech = String(row.teknisi||'').trim(); const cell = tech ? `<div>${t}<div class='tech-subtext'>${escHtml(tech)}</div></div>` : t; return `<td>${cell}</td>`; }
        case 'report_no': return `<td>${row.report_no||''}</td>`;
        case 'forklift': return `<td>${forkliftCell}</td>`;
        case 'pekerjaan': return `<td>${pekerjaanCell}</td>`;
        case 'next_pm': return `<td>${nextPmCell}</td>`;
        case 'description': return `<td>${row.description||''}</td>`;
        case 'recommendation': return `<td>${row.recommendation||''}</td>`;
        case 'items_used': return `<td>${renderPartsCell(row)}</td>`;
        case 'actions': return `<td>${actions}</td>`;
        default: return '<td></td>';
      }
    }
    const tds = cols.map(c=> tdFor(c.key)).join('');
    return `<tr>${tds}</tr>`;
  }).join('') + '</tbody>';

  const tableEl = document.getElementById('table');
  if (tableEl) tableEl.innerHTML = `<div class="table-scroll"><table>${header}${body}</table></div>`;
  applyTablePerformanceHints('table');
  perfEnd && perfEnd('records.render', `n=${data?.length||0} pageRows=${currentRows.length}`);

  // Select-all per halaman saat klik header "Sel"
  const selHeader = document.querySelector('th.sel-header');
  if (selHeader) selHeader.onclick = ()=>{
    const actionableRows = currentRows.filter(r=> !r.__arsip);
    const allSelected = actionableRows.length>0 && actionableRows.every(r=> selected.has(r.id));
    if (allSelected){ actionableRows.forEach(r=> selected.delete(r.id)); } else { actionableRows.forEach(r=> selected.add(r.id)); }
    render();
  };

  // Header sort handlers
  document.querySelectorAll('#table th[data-key]').forEach(th=>{
    th.onclick = ()=>{
      const key = th.getAttribute('data-key');
      if (sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortKey = key; sortDir = 'asc'; }
      data = sortRows(data);
      render();
    };
  });

  // Delegasi event untuk checkbox agar tidak memasang listener per row
  const tableContainer = document.getElementById('table');
  if (tableContainer){
    if (!tableContainer.dataset.cbDelegated){
      tableContainer.addEventListener('change', (ev)=>{
        const cb = ev.target.closest("input[type='checkbox'][data-id]");
        if (!cb) return;
        const id = +cb.getAttribute('data-id');
        if (cb.checked) selected.add(id); else selected.delete(id);
        updateActionsVisibility();
      });
      tableContainer.dataset.cbDelegated = '1';
    }
  }
  if (tableContainer){
    if (!tableContainer.dataset.clickDelegated){
    tableContainer.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button');
      if (!btn) return;
      // View arsip in-place (modal)
      if (btn.hasAttribute('data-arch')){
        const id = btn.getAttribute('data-arch');
        const src = btn.getAttribute('data-src') || '';
        try{
          const qs = src ? `?job_source=${encodeURIComponent(src)}` : '';
          const d = await api(`/api/archive/jobs/${encodeURIComponent(id)}${qs}`);
          openArchiveView('Detail Arsip', d || {});
        }catch(e){ console.error('Gagal ambil detail arsip', e); alert('Gagal memuat detail arsip'); }
        return;
      }
      if (btn.hasAttribute('data-edit')){
        const id = +btn.getAttribute('data-edit');
        const item = currentRows.find(r=>r.id===id) || data.find(r=>r.id===id);
        if (item) openEditModal(item);
        return;
      }
      if (btn.hasAttribute('data-detail')){
        const id = +btn.getAttribute('data-detail');
        const item = currentRows.find(r=>r.id===id) || data.find(r=>r.id===id);
        if (item) openEditModal(item, true);
        return;
      }
      if (btn.hasAttribute('data-del')){
        const id = +btn.getAttribute('data-del');
        if (!(await confirmDialog('Hapus record ini?'))) return;
        try{ await api('/api/records/'+id, { method:'DELETE' }); await load(); } catch(e){ alert(e && e.error ? e.error : 'Gagal menghapus'); }
        return;
      }
    });
    tableContainer.dataset.clickDelegated = '1';
    }
  }

  updateActionsVisibility();
  // Pagination
  const pages = allMode ? 1 : Math.max(1, Math.ceil(data.length / rowsPerPage));
  const pagEl = document.getElementById('pagination');
  if (pagEl){
    pagEl.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;">
        <button id="prevBtn">Prev</button>
        <span>Halaman</span>
        <input id="pageInput" type="number" min="1" value="${page}" style="width:64px;" />
        <span>/ ${pages}</span>
        <button id="nextBtn">Next</button>
      </div>`;
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInput = document.getElementById('pageInput');
    if (prevBtn) prevBtn.disabled = page <= 1 || allMode;
    if (nextBtn) nextBtn.disabled = page >= pages || allMode;
    if (prevBtn) prevBtn.onclick = ()=>{ if (page>1){ page = page-1; render(); } };
    if (nextBtn) nextBtn.onclick = ()=>{ if (page<pages){ page = page+1; render(); } };
    if (pageInput){
      pageInput.onchange = ()=>{
        let p = parseInt(pageInput.value, 10);
        if (isNaN(p) || p<1) p = 1;
        if (p>pages) p = pages;
        page = p;
        render();
      };
      pageInput.onkeydown = (e)=>{ if (e.key==='Enter'){ e.preventDefault(); pageInput.onchange(); } };
    }
  }
  const infoEl = document.getElementById('resultInfo');
  if (infoEl){ infoEl.textContent = `Menampilkan ${currentRows.length} dari ${data.length} hasil`; }
}

function openEditModal(item, readOnly=false){
  const modal = document.getElementById('editModal'); if (!modal) return;
  // Fill fields
  document.getElementById('ed_tanggal').value = item.tanggal || '';
  document.getElementById('ed_report_no').value = item.report_no || '';
  // Set nilai forklift ke input + state
  edForkliftId = item.forklift_id || null;
  if (edFkInput){
    const f = fkCache.find(x=>x.id===edForkliftId);
    edFkInput.value = f ? fkLabel(f) : '';
  }
  document.getElementById('ed_pekerjaan').value = item.pekerjaan || 'PM';
  document.getElementById('ed_location').value = item.forklift_location || '';
  const descRichEl = document.getElementById('ed_description_rich');
  if (descRichEl) descRichEl.innerHTML = item.description || '';
  const recRichEl = document.getElementById('ed_recommendation_rich');
  if (recRichEl) recRichEl.innerHTML = item.recommendation || '';
  const itemsRichEl = document.getElementById('ed_items_used_rich');
  if (itemsRichEl){
    const arr = normalizeParts(item.items_used);
    itemsRichEl.innerHTML = arr.length ? `<ul>${arr.map(x=> `<li>${escHtml(x)}</li>`).join('')}</ul>` : '';
  }
  const nextPmEl = document.getElementById('ed_next_pm');
  if (nextPmEl) nextPmEl.value = item.next_pm || '';
  edChosen = [];
  const jNow = document.getElementById('ed_pekerjaan').value;
  const txtItems = String(item.items_used||'').trim();
  if (txtItems){
    txtItems.split(',').forEach(raw=>{
      const part = String(raw||'').trim();
      const qm = /\bx\s*(\d+)\s*$/i.exec(part);
      const qty = qm ? (parseInt(qm[1],10)||1) : 1;
      const textBase = part.replace(/\bx\s*\d+\s*$/i,'').trim();
      if (!textBase) return;
      const cm = /^([A-Za-z0-9_-]+)\s+(.+)$/.exec(textBase);
      let code = '';
      let name = '';
      if (cm){
        const candidate = cm[1];
        const rest = cm[2];
        const it = (items||[]).find(x=>String(x.code||'')===candidate);
        if (it){
          code = it.code; name = it.nama;
          const exist = edChosen.find(c=>c.id===it.id);
          if (exist) exist.qty += qty; else edChosen.push({ id: it.id, code, nama: name, qty });
          return;
        }
        // candidate bukan code katalog → anggap seluruh text sebagai nama
        code = '';
        name = textBase;
      } else {
        // Tidak ada spasi: bisa nama tunggal atau code saja
        const it = (items||[]).find(x=>String(x.code||'')===textBase);
        if (it){
          const exist = edChosen.find(c=>c.id===it.id);
          if (exist) exist.qty += qty; else edChosen.push({ id: it.id, code: it.code, nama: it.nama, qty });
          return;
        }
        code=''; name=textBase;
      }
      edChosen.push({ id: null, code, nama: name, qty });
    });
  }
  edItemsMode = 'choice';
  edRenderChosen();
  edRenderItems();
  edUpdateJenisUI();
  if (typeof edTechInput !== 'undefined' && edTechInput) { edTechInput.value = (edTechInput.value||'').trim(); }
  if (typeof edTechSuggest !== 'undefined' && edTechSuggest) { edTechSuggest.style.display = (edTechInput && edTechInput.value) ? 'block' : 'none'; }
  // Prefill chips teknisi dari record agar tidak perlu pilih ulang
  try{
    const rawTech = String(item.teknisi||'');
    const labels = rawTech.split(',').map(s=> s.trim()).filter(Boolean);
    edSelectedTech = [];
    for (const lbl of labels){
      const exists = edSelectedTech.some(x=> String(x.label||'').toLowerCase() === lbl.toLowerCase());
      if (!exists) edSelectedTech.push({ id: null, label: lbl });
    }
    if (typeof renderEdTechTags === 'function') renderEdTechTags();
  }catch(_){}
  if (readOnly){
    // Matikan semua input & suggest di modal
    ['ed_tanggal','ed_report_no','ed_pekerjaan','ed_location'].forEach(id=>{
      const el = document.getElementById(id);
      if (el){ el.disabled = true; el.readOnly = true; }
    });
    const descRich = document.getElementById('ed_description_rich'); if (descRich) descRich.setAttribute('contenteditable','false');
    const recRich = document.getElementById('ed_recommendation_rich'); if (recRich) recRich.setAttribute('contenteditable','false');
    const itemsRich = document.getElementById('ed_items_used_rich'); if (itemsRich) itemsRich.setAttribute('contenteditable','false');
    if (typeof edFkInput !== 'undefined' && edFkInput) edFkInput.disabled = true;
    if (typeof edTechInput !== 'undefined' && edTechInput) edTechInput.disabled = true;
    if (typeof edItemInput !== 'undefined' && edItemInput) edItemInput.disabled = true;
    if (typeof edItemQtyEl !== 'undefined' && edItemQtyEl) edItemQtyEl.disabled = true;
    if (typeof edFkSuggest !== 'undefined' && edFkSuggest) edFkSuggest.style.display='none';
    if (typeof edTechSuggest !== 'undefined' && edTechSuggest) edTechSuggest.style.display='none';
    if (typeof edItemSuggest !== 'undefined' && edItemSuggest) edItemSuggest.style.display='none';
    // Nonaktifkan tombol hapus pada chips teknisi
    document.querySelectorAll('#ed_teknisi_tags button.x').forEach(b=>{ b.disabled = true; b.style.pointerEvents='none'; });
    // Nonaktifkan kontrol chosen items (qty & remove)
    document.querySelectorAll('#ed_chosenItems .chosen-row input.qty').forEach(el=>{ el.disabled = true; el.readOnly = true; });
    document.querySelectorAll('#ed_chosenItems .chosen-row .xbtn').forEach(btn=>{ btn.style.display = 'none'; });
  } else {
    ['ed_tanggal','ed_report_no','ed_pekerjaan','ed_location'].forEach(id=>{
      const el = document.getElementById(id);
      if (el){ el.disabled = false; el.readOnly = false; }
    });
    const descRich = document.getElementById('ed_description_rich'); if (descRich) descRich.setAttribute('contenteditable','true');
    const recRich2 = document.getElementById('ed_recommendation_rich'); if (recRich2) recRich2.setAttribute('contenteditable','true');
    const itemsRich = document.getElementById('ed_items_used_rich'); if (itemsRich) itemsRich.setAttribute('contenteditable','true');
    if (typeof edFkInput !== 'undefined' && edFkInput) edFkInput.disabled = false;
    if (typeof edTechInput !== 'undefined' && edTechInput) edTechInput.disabled = false;
    if (typeof edItemInput !== 'undefined' && edItemInput) edItemInput.disabled = false;
    if (typeof edItemQtyEl !== 'undefined' && edItemQtyEl) edItemQtyEl.disabled = false;
    // Aktifkan kembali tombol hapus pada chips teknisi
    document.querySelectorAll('#ed_teknisi_tags button.x').forEach(b=>{ b.disabled = false; b.style.pointerEvents=''; });
    // Tampilkan kembali kontrol chosen items
    document.querySelectorAll('#ed_chosenItems .chosen-row input.qty').forEach(el=>{ el.disabled = false; el.readOnly = false; });
    document.querySelectorAll('#ed_chosenItems .chosen-row .xbtn').forEach(btn=>{ btn.style.display = ''; });
  }
  modal.style.display='flex';
  const cancelBtn = document.getElementById('btnCancelEdit');
  const saveBtn = document.getElementById('btnSaveEdit');
  cancelBtn.onclick = ()=>{ modal.style.display='none'; };
  if (readOnly){ saveBtn.style.display='none'; cancelBtn.textContent='Tutup'; } else { saveBtn.style.display=''; cancelBtn.textContent='Batal'; }
  saveBtn.onclick = async ()=>{
    try{
      const teknisiList = (edSelectedTech||[]).map(t=> String(t.label||'').trim()).filter(Boolean);
      if (teknisiList.length === 0){
        alert('Teknisi harus diisi');
        return;
      }
      const rn = String(document.getElementById('ed_report_no').value||'').trim();
      if (!rn){
        alert('Report number harus diisi');
        return;
      }
      // Validasi forklift
      const fValid = fkCache.find(x=>x.id===edForkliftId);
      if (!fValid){
        alert('Pilih forklift dari daftar.');
        if (edFkInput) edFkInput.focus();
        return;
      }
      const payload = {
        tanggal: document.getElementById('ed_tanggal').value,
        report_no: document.getElementById('ed_report_no').value,
        
        forklift_id: parseInt(edForkliftId||0),
        pekerjaan: document.getElementById('ed_pekerjaan').value,
        teknisi: teknisiList.join(', '),
        description: getRteValue('ed_description_rich'),
        recommendation: getRteValue('ed_recommendation_rich'),
        items_used: (edItemsMode==='choice'
          ? (edChosen||[]).map(c=> c && c.id ? `${c.code} ${c.nama} x ${c.qty}` : `${c.nama} x ${c.qty}`).join(', ')
          : getRteValue('ed_items_used_rich')),
        location: document.getElementById('ed_location').value,
      };
      await api('/api/records/'+item.id, { method:'PUT', body: payload });
      // Jika jenis PM dan ada Next PM, update/insert pada jobs
      const jenisNow = document.getElementById('ed_pekerjaan').value;
      const nextPmVal = document.getElementById('ed_next_pm') ? document.getElementById('ed_next_pm').value : '';
      if (jenisNow==='PM' && nextPmVal){
        try{
          const jobs = await api('/api/jobs');
          const target = (Array.isArray(jobs)?jobs:[]).find(j=> String(j.jenis||'').toUpperCase()==='PM' && String(j.forklift_id)==String(edForkliftId) && String(j.report_no||'')===String(document.getElementById('ed_report_no').value||''));
          if (target && target.id){
            const newDesc = getRteValue('ed_description_rich');
            const newRec = getRteValue('ed_recommendation_rich');
            const newItems = (edItemsMode==='choice'
              ? (edChosen||[]).map(c=> c && c.id ? `${c.code} ${c.nama} x ${c.qty}` : `${c.nama} x ${c.qty}`).join(', ')
              : getRteValue('ed_items_used_rich'));
            await api('/api/jobs/'+target.id, { method:'PUT', body: { jenis: jenisNow, forklift_id: parseInt(edForkliftId||0), tanggal: document.getElementById('ed_tanggal').value, teknisi: teknisiList.join(', '), report_no: document.getElementById('ed_report_no').value, description: newDesc, recommendation: newRec, items_used: newItems, next_pm: nextPmVal } });
          } else {
            await api('/api/jobs', { method:'POST', body: { jenis: 'PM', forklift_id: parseInt(edForkliftId||0), tanggal: document.getElementById('ed_tanggal').value, teknisi: teknisiList.join(', '), report_no: document.getElementById('ed_report_no').value, description: getRteValue('ed_description_rich'), recommendation: getRteValue('ed_recommendation_rich'), items_used: (edItemsMode==='choice' ? (edChosen||[]).map(c=> c && c.id ? `${c.code} ${c.nama} x ${c.qty}` : `${c.nama} x ${c.qty}`).join(', ') : getRteValue('ed_items_used_rich')), next_pm: nextPmVal } });
          }
        }catch(_){ /* ignore update next_pm errors */ }
      }
      alert('Record berhasil diperbarui');
      modal.style.display='none';
      await load();
    } catch(e){
      alert(e && e.error ? e.error : 'Gagal menyimpan perubahan');
    }
  };
}

// Real-time triggers
const qEl = document.getElementById('q');
if (qEl) qEl.oninput = makeDebounce(load, 250);
const startEl = document.getElementById('start');
if (startEl) startEl.onchange = load;
const endEl = document.getElementById('end');
if (endEl) endEl.onchange = load;

  document.querySelectorAll('#jenisChecks input[type=checkbox]').forEach(cb=> cb.onchange = load);
  const rppEl = document.getElementById('rowsPerPage');
  if (rppEl) { rppEl.value = (rowsPerPage==='All'?'All':String(rowsPerPage)); rppEl.onchange = (e)=>{ const v = e.target.value; rowsPerPage = (v==='All'?'All':(parseInt(v,10)||25)); page=1; render(); }; }
  const applyBtn = document.getElementById('apply');
  if (applyBtn) applyBtn.onclick = ()=>{
  // Reset semua filter dan search ke default
  document.querySelectorAll('#jenisChecks input[type=checkbox]').forEach(cb=> cb.checked = true);
  const startEl = document.getElementById('start'); if (startEl) startEl.value = '';
  const endEl = document.getElementById('end'); if (endEl) endEl.value = '';
  const qEl = document.getElementById('q'); if (qEl) qEl.value = '';
  // Reset chip teknisi
  selectedTech = []; renderTechTags(); if (techInput) techInput.value=''; if (techSuggest) techSuggest.style.display='none';
  // Reset chip forklift
  selectedForklifts = []; renderFkTags(); if (fkInput) fkInput.value=''; if (fkSuggest) fkSuggest.style.display='none';
  // Reset sort ke default
  sortKey = 'tanggal';
  sortDir = 'desc';
  page = 1; rowsPerPage = 25; if (rppEl) rppEl.value = '25';
  // Muat ulang data dengan parameter default
  load();
};

function setupDropdown(dd){
  if (!dd) return;
  const btn = dd.querySelector('.dd-btn');
  const menu = dd.querySelector('.dd-menu');
  if (!btn || !menu) return;
  btn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); dd.classList.toggle('open'); };
  document.addEventListener('click', (ev)=>{ if (!dd.contains(ev.target)) dd.classList.remove('open'); });
}
setupDropdown(document.getElementById('filterDd'));
setupDropdown(document.getElementById('actionsDd'));

function updateActionsVisibility(){ const dd = document.getElementById('actionsDd'); if (dd){ dd.style.display = (selected && selected.size>0) ? 'inline-block' : 'none'; if (!(selected && selected.size>0)) dd.classList.remove('open'); } }
updateActionsVisibility();

// Sorting via header klik tetap aktif; kontrol sort radio dihapus untuk memperkecil bubble

function downloadBlob(filename, blob){
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  setTimeout(()=>{ URL.revokeObjectURL(link.href); link.remove(); }, 0);
}

// Export Excel
const btnExcel = document.getElementById('exportExcel');
if (btnExcel) btnExcel.onclick = async ()=>{
  try{
    await window.ensureExcelJS();
    const wb = new ExcelJS.Workbook();
    const ws = wb.addWorksheet('Records');
    // Set column widths to widen table and avoid squished text
    const widths = [12, 16, 24, 22, 32, 22, 14, 48, 40, 40];
    widths.forEach((w,i)=>{ try{ const col = ws.getColumn(i+1); col.width = w; col.alignment = { vertical:'top', wrapText: (i+1)>=8 }; }catch{} });
    // Header
    ws.addRow(['Tanggal','Report No','Forklift','Location','Pekerjaan','Teknisi','Next PM','Description','Recommendation','Items Used']);
    const headerRow = ws.getRow(1);
    try{
      headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
      headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
      headerRow.height = 22;
      headerRow.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF0D47A1' } });
    }catch{}
    // Freeze header and enable auto filter
    try{ ws.views = [{ state:'frozen', xSplit:0, ySplit:1 }]; }catch{}
    try{ ws.autoFilter = { from: { row:1, column:1 }, to: { row:1, column:10 } }; }catch{}

    const useSelected = selected && selected.size>0;
    const idSet = useSelected ? new Set(Array.from(selected)) : null;
    const rowsSource = useSelected ? (data||[]).filter(r=> idSet.has(r.id)) : (data||[]);
    rowsSource.forEach(r=>{
      ws.addRow([
        r.tanggal||'', r.report_no||'', r.forklift||'', r.forklift_location||'', r.pekerjaan||'', r.teknisi||'', r.next_pm||'', r.description||'', r.recommendation||'', r.items_used||''
      ]);
    });

    // Borders for all cells and zebra striping for data rows
    try{
      const lastRow = ws.rowCount;
      // Zebra striping for readability
      for (let r = 2; r <= lastRow; r++){
        if (r % 2 === 0){
          const row = ws.getRow(r);
          row.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFF2F6FC' } });
        }
      }
      // Thin borders
      for (let r = 1; r <= lastRow; r++){
        const row = ws.getRow(r);
        for (let c = 1; c <= 10; c++){
          const cell = row.getCell(c);
          cell.border = {
            top: { style:'thin', color:{ argb:'FFB0BEC5' } },
            left: { style:'thin', color:{ argb:'FFB0BEC5' } },
            bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
            right: { style:'thin', color:{ argb:'FFB0BEC5' } },
          };
        }
      }
    }catch{}

    const buf = await wb.xlsx.writeBuffer();
    downloadBlob('records.xlsx', new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
  }catch(e){ console.error(e); alert('Gagal export Excel'); }
};

// Import Excel
const btnImport = document.getElementById('importExcel');
if (btnImport) btnImport.onclick = async ()=>{
  if (user.role==='teknisi') { alert('Tidak punya akses untuk import.'); return; }
  try{
    await window.ensureExcelJS();
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.xlsx';
    input.onchange = async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const ab = await file.arrayBuffer();
      const wb = new ExcelJS.Workbook();
      await wb.xlsx.load(ab);
      const ws = wb.worksheets[0];
      if (!ws){ alert('Worksheet tidak ditemukan.'); return; }
      const expected = ['Tanggal','Report No','Forklift','Location','Pekerjaan','Teknisi','Next PM','Description','Recommendation','Items Used'];
      const header = expected.map((_,i)=> String(ws.getRow(1).getCell(i+1).value||'').trim());
      const okHeader = expected.every((h,i)=> (header[i]||'').toLowerCase() === h.toLowerCase());
      if (!okHeader){
        alert('Format header tidak sesuai. Pastikan sama seperti hasil Export: '+expected.join(', '));
        return;
      }
      const rows = [];
      for (let r = 2; r <= ws.rowCount; r++){
        const row = ws.getRow(r);
        const tanggal = String(row.getCell(1).value ?? '').trim();
        const report_no = String(row.getCell(2).value ?? '').trim();
        const forklift = String(row.getCell(3).value ?? '').trim();
        const location = String(row.getCell(4).value ?? '').trim();
        const pekerjaan = String(row.getCell(5).value ?? '').trim();
        const teknisi = String(row.getCell(6).value ?? '').trim();
        const next_pm = String(row.getCell(7).value ?? '').trim();
        const description = String(row.getCell(8).value ?? '').trim();
        const recommendation = String(row.getCell(9).value ?? '').trim();
        const items_used = String(row.getCell(10).value ?? '').trim();
        if (![tanggal,report_no,forklift,location,pekerjaan,teknisi,next_pm,description,recommendation,items_used].some(v=> (v!=='' && v!==null && v!==undefined))) continue;
        rows.push({ tanggal, report_no, forklift, location, pekerjaan, teknisi, next_pm, description, recommendation, items_used });
      }
      if (!rows.length){ alert('Tidak ada data untuk diimport.'); return; }
      const resp = await api('/api/records/import', { method:'POST', body:{ rows } });
      const errMsg = (resp && resp.errors && resp.errors.length)
        ? `, Errors: ${resp.errors.length} (Row ${resp.errors[0].index}: ${resp.errors[0].error})`
        : '';
      alert(`Import selesai. Inserted: ${resp.inserted||0}, Updated: ${resp.updated||0}${errMsg}`);
      await load();
    };
    input.click();
  }catch(e){ console.error(e); alert('Gagal import Excel.'); }
};

// Export PDF
const btnPDF = document.getElementById('exportPDF');
if (btnPDF) btnPDF.onclick = async ()=>{
  try{
    await window.ensureJsPDF();
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'l', unit:'pt', format:'a4' });
    const head = [['Tanggal','Report No','Forklift','Location','Pekerjaan','Teknisi','Next PM','Description','Recommendation','Items Used']];
    const useSelected = selected && selected.size>0;
    const idSet = useSelected ? new Set(Array.from(selected)) : null;
    const rowsSource = useSelected ? (data||[]).filter(r=> idSet.has(r.id)) : (data||[]);
    const body = rowsSource.map(r=>[
      r.tanggal||'', r.report_no||'', r.forklift||'', r.forklift_location||'', r.pekerjaan||'', r.teknisi||'', r.next_pm||'', r.description||'', r.recommendation||'', r.items_used||''
    ]);
    doc.autoTable({ head, body, styles:{ fontSize:8, cellPadding:3, overflow:'linebreak' }, headStyles:{ fillColor:[13,71,161], textColor:255 }, startY:40, margin:{ left:24, right:24 } });
    doc.save('records.pdf');
  }catch(e){ console.error(e); alert('Gagal export PDF'); }
};

// Export CSV
const btnCSV = document.getElementById('exportCSV');
if (btnCSV) btnCSV.onclick = async ()=>{
  try{
    const useSelected = selected && selected.size>0;
    const idSet = useSelected ? new Set(Array.from(selected)) : null;
    const rowsSource = useSelected ? (data||[]).filter(r=> idSet.has(r.id)) : (data||[]);
    const headers = ['Tanggal','Report No','Forklift','Location','Pekerjaan','Teknisi','Next PM','Description','Recommendation','Items Used'];
    const lines = [];
    lines.push(headers.map(h=> '"'+String(h).replace(/"/g,'""')+'"').join(','));
    for (const r of rowsSource){
      const vals = [r.tanggal||'', r.report_no||'', r.forklift||'', r.forklift_location||'', r.pekerjaan||'', r.teknisi||'', r.next_pm||'', r.description||'', r.recommendation||'', r.items_used||''];
      const row = vals.map(s=>{
        const str = String(s);
        const quoted = /[",\n]/.test(str) ? '"'+str.replace(/"/g,'""')+'"' : str;
        return quoted;
      }).join(',');
      lines.push(row);
    }
    const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
    downloadBlob('records.csv', blob);
  }catch(e){ console.error(e); alert('Gagal export CSV'); }
};

// Bulk delete selected
const bulkBtn = document.getElementById('bulkDeleteBtn');
if (bulkBtn) bulkBtn.onclick = async ()=>{
  if (!selected || selected.size===0){ alert('Pilih record terlebih dahulu'); return; }
  if (!(await confirmDialog('Hapus semua record terpilih?'))) return;
  try{
    const ids = Array.from(selected);
    const resp = await api('/api/records/bulk-delete', { method:'POST', body:{ ids } });
    const ok = resp && typeof resp.deleted==='number' ? resp.deleted : ids.length;
    const fail = ids.length - ok;
    selected.clear();
    await load();
    if (fail>0){ alert(`Bulk delete selesai. Sukses: ${ok}, Gagal: ${fail}`); }
  }catch(e){ console.error(e); alert('Gagal hapus massal'); }
};

// Detail Arsip modal helpers
function renderArchiveDetailHtml(d){
  const isPM = (String(d.jenis||'').toLowerCase()==='pm') || d.job_source==='maintenance';
  const rows = [
    ['ID', d.id],
    ['Job No', d.job_no],
    ['Sumber', d.job_source],
    ['Jenis', ((String(d.jenis||'').toLowerCase()==='pm') || d.job_source === 'maintenance') ? 'PM/Lapangan' : (d.jenis || 'Workshop')],
    ['Tanggal', d.job_date],
    ['Forklift', d.forklift || ''],
    ...(isPM ? [['Next PM', d.next_pm || '']] : []),
    ['Pekerjaan', d.pekerjaan || ''],
    ['Recommendation', d.recommendation || ''],
    ['Item Dipakai', d.items_used || d.item_dipakai || ''],
    ['Catatan', d.notes || ''],
    ['Dibuat', d.created_at || ''],
    ['Diupdate', d.updated_at || ''],
  ];
  return `<div style='display:grid; grid-template-columns: 160px 1fr; gap:8px;'>${rows.map(([k,v])=>`<div style='color:#666'>${k}</div><div>${String(v??'')}</div>`).join('')}</div>`;
}

function openArchiveView(title, detail){
  const modal = document.getElementById('modal');
  const titleEl = document.getElementById('modalTitle');
  const bodyEl = document.getElementById('modalBody');
  const closeBtn = document.getElementById('closeBtn');
  if (!modal || !titleEl || !bodyEl || !closeBtn) return;
  titleEl.textContent = title;
  bodyEl.innerHTML = renderArchiveDetailHtml(detail||{});
  modal.style.display = 'flex';
  const close = ()=>{ modal.style.display='none'; };
  closeBtn.onclick = close;
  modal.onclick = (ev)=>{ if (ev.target === modal) close(); };
}

// Initial load
renderTechTags();
renderFkTags();
await load();
})(); });
  </script>
  </body>
  </html>
