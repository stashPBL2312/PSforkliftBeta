<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Items</title>
  <script src="/common.js" defer></script>
  <!-- Lazy-load export libraries only when needed -->
  <script>
    (function(){
      function loadScript(src){
        return new Promise((resolve, reject)=>{
          const s=document.createElement('script'); s.src=src; s.async=true;
          s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed to load '+src));
          document.head.appendChild(s);
        });
      }
      window.ensureExcelJS = async function(){
        if (!window.ExcelJS){
          await loadScript('https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js');
        }
        return window.ExcelJS;
      };
      window.ensureJsPDF = async function(){
        if (!(window.jspdf && window.jspdf.jsPDF)){
          await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
        }
        if (!window.__autoTableLoaded){
          await loadScript('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js');
          window.__autoTableLoaded = true;
        }
        return window.jspdf && window.jspdf.jsPDF;
      };
    })();
   </script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    .wrap { max-width:1100px; margin:20px auto; padding:0 16px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
    th { background:#fafafa; }
    input, select, button { padding:6px 8px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    /* Dark mode: modal */
    [data-theme="dark"] #modal > div { background:#0f172a !important; color:#e5e7eb; box-shadow:0 10px 30px rgba(0,0,0,.6); }
    [data-theme="dark"] #modal h3 { color:#e5e7eb; }
    [data-theme="dark"] #modal div[style*='color:#666'],
    [data-theme="dark"] #modal div[style*='color:#777'] { color:#e5e7eb !important; }
    [data-theme="dark"] #modal input,
    [data-theme="dark"] #modal select,
    [data-theme="dark"] #modal textarea { background:#0b1220; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }
    /* Responsive: mobile-friendly layout */
    @media (max-width: 768px){
      .wrap { margin:12px auto; padding:0 12px; }
      .toolbar { flex-wrap: wrap; gap:6px; }
      /* Keep table scroll only */
      #table { overflow-x:auto; }
      th, td { padding:6px; }
      #pagination { display:flex; flex-wrap:wrap; gap:6px; }
    }
    @media (max-width: 480px){
      .toolbar { gap:6px; }
      input, select, button { padding:8px 10px; }
    }
  </style>
  <style>
    /* Page-specific overrides: keep search input compact on mobile */
    @media (max-width: 768px){
      /* Mobile toolbar: grid 2 kolom simetris, tombol seragam */
      .page-items .toolbar { display:grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr); column-gap:10px; row-gap:8px; align-items:stretch; }
      .page-items .toolbar > * { min-width:0; }
      .page-items .toolbar input#search, .page-items .toolbar select, .page-items .toolbar button { width:100%; box-sizing:border-box; height:36px; font-size:14px; }
      .page-items .toolbar button { justify-self: stretch; }
    }
    @media (max-width: 480px){
      .page-items .toolbar { column-gap:8px; row-gap:6px; }
      .page-items .toolbar input#search, .page-items .toolbar select, .page-items .toolbar button { height:34px; font-size:13px; }
    }
  </style>
</head>
<body class="page-items">
  <div id="header"></div>
  <div class="wrap">
    <h2>Items</h2>
    <div class="toolbar">
      <input id="search" placeholder="Cari..." />
      <select id="rowsPerPage"><option>25</option><option>50</option><option>100</option><option value="all">All</option></select>
      <button id="addBtn">Tambah</button>
      <button id="bulkDeleteBtn">Hapus Terpilih</button>
      <button id="importExcel">Import Excel</button>
      <button id="exportExcel">Export Excel</button>
      <button id="exportPDF">Export PDF</button>
    </div>
    <div id="table"></div>
    <div id="pagination" style="margin-top:8px;"></div>
  </div>

  <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.3); align-items:center; justify-content:center;">
    <div style="background:#fff; padding:16px; border-radius:8px; width:480px; max-width:95vw;">
      <h3 id="modalTitle" style="margin-top:0;">Tambah Item</h3>
      <div id="form"></div>
      <div style="text-align:right; margin-top:10px;">
        <button id="cancelBtn">Batal</button>
        <button id="saveBtn">Simpan</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{ (async function(){
    const user = await ensureAuthedAndRenderNav(); if (!user) return;
    if (user.role === 'teknisi'){
      ['addBtn','bulkDeleteBtn','importExcel'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.style.display='none'; el.disabled=true; } });
    }
    let data = await api('/api/items');
    let selected = new Set();
    const canEdit = (user.role==='admin'||user.role==='supervisor');
    const canImportExport = (user.role==='admin'||user.role==='supervisor');

    const columns = [
      { key:'__sel', label:'Sel' },
      { key:'code', label:'ID' },
      { key:'nama', label:'Nama' },
      { key:'unit', label:'Unit' },
      { key:'description', label:'Description' },
      { key:'status', label:'Status' },
      { key:'__act', label:'Aksi' },
    ];

    let page = 1; let rows = 25;
    let sortMode = 'codeAsc';
    let currentRows = [];

    // helper untuk kapitalisasi status saat ditampilkan
    function ucFirst(s){
      s = String(s||'');
      return s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : s;
    }

    // daftar opsi status untuk select list
    const statusList = ['Available','Unavailable'];

    // Indexing ringan untuk pencarian cepat tanpa mengubah hasil
    function indexRows(rows){
      if (!Array.isArray(rows)) return;
      for (const r of rows){
        const s = [r.code, r.nama, r.unit, r.description, r.status]
          .map(v=> String(v||'').toLowerCase())
          .join(' ');
        r._q = s;
      }
    }

    // Pencarian cepat berbasis _q (AND untuk setiap kata)
    function fastFilter(rows, q){
      const query = String(q||'').trim().toLowerCase();
      if (!query) return rows || [];
      const parts = query.split(/\s+/);
      return (rows||[]).filter(r=>{
        const s = r._q || '';
        for (const p of parts){ if (s.indexOf(p)===-1) return false; }
        return true;
      });
    }

    // Comparator: urutkan berdasarkan kode item (prefix huruf lalu angka) naik
    function sortByItemCodeAsc(a, b){
      const ac0 = String(a?.code||'').trim();
      const bc0 = String(b?.code||'').trim();
      if (!ac0 && !bc0) return 0;
      if (!ac0) return 1;
      if (!bc0) return -1;
      const ac = ac0.toUpperCase();
      const bc = bc0.toUpperCase();
      const ma = ac.match(/^([A-Z]+)(\d+)/);
      const mb = bc.match(/^([A-Z]+)(\d+)/);
      if (ma && mb){
        if (ma[1] !== mb[1]) return ma[1].localeCompare(mb[1]);
        const na = parseInt(ma[2], 10);
        const nb = parseInt(mb[2], 10);
        if (isNaN(na) && isNaN(nb)) return ac.localeCompare(bc);
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      }
      return ac.localeCompare(bc);
    }

    function sortItemsTmiFirst(a, b){
      const ac = String(a?.code||'');
      const bc = String(b?.code||'');
      const ta = /^TMI-(\d+)$/i.exec(ac.trim());
      const tb = /^TMI-(\d+)$/i.exec(bc.trim());
      const aIs = !!ta; const bIs = !!tb;
      if (aIs && !bIs) return -1;
      if (!aIs && bIs) return 1;
      if (aIs && bIs){
        const na = parseInt(ta[1], 10); const nb = parseInt(tb[1], 10);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        return ac.localeCompare(bc);
      }
      return sortByItemCodeAsc(a, b);
    }

    function formHtml(item={}){
      const stOptions = statusList.map(v=>`<option value="${v}">${v}</option>`).join('');
      const unitList = [ {value:'L', label:'Liter (L)'}, {value:'Set', label:'Set'}, {value:'Pcs', label:'Pcs'} ];
      const unitSel = String(item.unit ?? 'Pcs');
      const unitOptions = unitList.map(u=>`<option value="${u.value}" ${u.value===unitSel?'selected':''}>${u.label}</option>`).join('');
      return `
        <div style='margin-bottom:8px;'><div style='font-size:12px; color:#666;'>ID</div><input id='f_code' value='${item.code??''}' /></div>
        <div style='margin-bottom:8px;'><div style='font-size:12px; color:#666;'>NAMA</div><input id='f_nama' value='${item.nama??''}' /></div>
        <div style='margin-bottom:8px;'><div style='font-size:12px; color:#666;'>UNIT</div>
          <select id='f_unit'>${unitOptions}</select>
        </div>
        <div style='margin-bottom:8px;'><div style='font-size:12px; color:#666;'>DESCRIPTION</div><input id='f_description' value='${item.description??''}' /></div>
        <div style='margin-bottom:8px;'><div style='font-size:12px; color:#666;'>STATUS</div>
          <select id='f_status'>${stOptions}</select>
        </div>
      `;
    }

    // Modal open/close + save logic
    function openModal(title, item={}){
      if (!canEdit){ /* non-editor: jangan munculkan popup, cukup tidak membuka modal */ return; }
      const modal = document.getElementById('modal');
      const titleEl = document.getElementById('modalTitle');
      const formEl = document.getElementById('form');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      titleEl.textContent = title;
      formEl.innerHTML = formHtml(item);
      // set status default/terpilih
      const fStatus = document.getElementById('f_status');
      if (fStatus){
        const wanted = ucFirst(item.status || statusList[0]);
        fStatus.value = wanted;
      }
      modal.style.display = 'flex';

      cancelBtn.onclick = ()=>{ modal.style.display='none'; };
      modal.onclick = (ev)=>{ if (ev.target === modal) modal.style.display='none'; };

      saveBtn.onclick = async ()=>{
        const payload = {
          code: String(document.getElementById('f_code').value||'').trim(),
          nama: String(document.getElementById('f_nama').value||'').trim(),
          unit: String(document.getElementById('f_unit').value||'').trim(),
          description: String(document.getElementById('f_description').value||'').trim(),
          status: String(document.getElementById('f_status').value||'').toLowerCase(),
        };
        try{
          const created = !(item && item.id);
          if (!created){
            await api('/api/items/'+item.id, { method:'PUT', body: payload });
          } else {
            await api('/api/items', { method:'POST', body: payload });
          }
          modal.style.display='none';
          data = await api('/api/items');
          indexRows(data);
          render();
          if (created) {
            alert('Item berhasil ditambahkan');
          }
        }catch(e){ console.error('Save item error:', e); alert('Gagal menyimpan item'); }
      };
    }
    // Modal view-only untuk non-editor
    function openView(title, item={}){
      const modal = document.getElementById('modal');
      const titleEl = document.getElementById('modalTitle');
      const formEl = document.getElementById('form');
      const saveBtn = document.getElementById('saveBtn');
      const cancelBtn = document.getElementById('cancelBtn');
      titleEl.textContent = title;
      formEl.innerHTML = formHtml(item);
      const fStatus = document.getElementById('f_status');
      if (fStatus){
        const wanted = ucFirst(item.status || statusList[0]);
        fStatus.value = wanted;
      }
      // Disable semua field
      formEl.querySelectorAll('input, select, textarea').forEach(el=> el.disabled = true);
      // Sembunyikan tombol Simpan
      saveBtn.style.display = 'none';
      modal.style.display = 'flex';
      // Close handlers
      const close = ()=>{ modal.style.display='none'; saveBtn.style.display=''; };
      cancelBtn.onclick = close;
      modal.onclick = (ev)=>{ if (ev.target === modal) close(); };
    }
    function render(){
       perfStart && perfStart('items.render');
       const q = document.getElementById('search').value;
      const filtered = q ? fastFilter(data, q) : (data||[]);
      const sorted = (filtered||[]).slice();
      if (sortMode==='codeAsc') sorted.sort(sortItemsTmiFirst);
      else if (sortMode==='codeDesc') sorted.sort((a,b)=> sortItemsTmiFirst(b,a));
       const start = (page-1)*rows; const end = start+rows;
       const rowsData = sorted.slice(start,end).map(x=>Object.assign({}, x));
       currentRows = rowsData;
       const header = '<thead><tr>' + columns.map(c=>{
         if (c.key==='__sel') return `<th class="sel-header" style="cursor:pointer" title="Pilih semua di halaman">Sel</th>`;
         if (c.key==='code'){
           const arrow = sortMode==='codeAsc' ? '▲' : (sortMode==='codeDesc' ? '▼' : '');
           return `<th class="sort-code" style="cursor:pointer" title="Urutkan ID">${c.label}${arrow? ' '+arrow : ''}</th>`;
         }
         return `<th>${c.label}</th>`;
       }).join('') + '</tr></thead>';
       const body = '<tbody>' + rowsData.map(row=>{
         const cb = `<input type='checkbox' data-id='${row.id}' ${selected.has(row.id)?'checked':''}/>`;
         const actions = canEdit 
           ? `<button data-edit='${row.id}'>Edit</button> <button data-del='${row.id}'>Hapus</button>` 
           : `<button data-view='${row.id}' class='btn-view' title='View' aria-label='View'>
                <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
                  <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
                  <circle cx='12' cy='12' r='3'></circle>
                </svg>
                View
              </button>`;
         const stOptions = statusList.map(v=>{
           const val = v.toLowerCase();
           const selectedOpt = row.status && String(row.status).toLowerCase()===val ? 'selected' : '';
           return `<option value="${val}" ${selectedOpt}>${v}</option>`;
         }).join('');
         const statusCell = `<select data-status='${row.id}' ${canEdit?'' : 'disabled'}>${stOptions}</select>`;
         return `<tr data-id='${row.id}'>
           <td>${cb}</td>
           <td>${row.code||''}</td>
           <td>${row.nama||''}</td>
           <td>${row.unit||'Pcs'}</td>
           <td>${row.description||''}</td>
           <td>${statusCell}</td>
           <td>${actions}</td>
         </tr>`;
       }).join('') + '</tbody>';
       document.getElementById('table').innerHTML = `<table>${header}${body}</table>`;
  applyTablePerformanceHints('table');
       const sortCodeHeader = document.querySelector('th.sort-code');
       if (sortCodeHeader){ sortCodeHeader.onclick = ()=>{ sortMode = (sortMode==='recent' ? 'codeAsc' : (sortMode==='codeAsc' ? 'codeDesc' : 'recent')); page=1; render(); }; }
  perfEnd && perfEnd('items.render', `q="${q}" n=${data?.length||0} filtered=${filtered.length} pageRows=${rowsData.length}`);
  const pages = Math.max(1, Math.ceil(sorted.length/rows));
       document.getElementById('pagination').innerHTML = `
         <div style="display:flex; gap:8px; align-items:center;">
           <button id="prevBtn">Prev</button>
           <span>Halaman</span>
           <input id="pageInput" type="number" min="1" value="${page}" style="width:64px;" />
           <span>/ ${pages}</span>
           <button id="nextBtn">Next</button>
         </div>`;
       const prevBtn = document.getElementById('prevBtn');
       const nextBtn = document.getElementById('nextBtn');
       const pageInput = document.getElementById('pageInput');
       if (prevBtn) prevBtn.disabled = page <= 1;
       if (nextBtn) nextBtn.disabled = page >= pages;
       if (prevBtn) prevBtn.onclick = ()=>{ if (page>1){ page = page-1; render(); } };
       if (nextBtn) nextBtn.onclick = ()=>{ if (page<pages){ page = page+1; render(); } };
       if (pageInput){
         pageInput.onchange = ()=>{
           let p = parseInt(pageInput.value, 10);
           if (isNaN(p) || p<1) p = 1;
           if (p>pages) p = pages;
           page = p;
           render();
         };
         pageInput.onkeydown = (e)=>{ if (e.key==='Enter'){ e.preventDefault(); pageInput.onchange(); } };
       }
       // Select-all per halaman saat klik header "Sel"
       const selHeader = document.querySelector('th.sel-header');
       if (selHeader) selHeader.onclick = ()=>{
         const allSelected = currentRows.length>0 && currentRows.every(r=> selected.has(r.id));
         if (allSelected) { currentRows.forEach(r=> selected.delete(r.id)); } else { currentRows.forEach(r=> selected.add(r.id)); }
         render();
       };
       // Bind checkbox select per-baris
       // Delegasi event untuk checkbox select per-baris agar tidak memasang listener per row
       // Handler ini dipasang sekali pada container tabel dan akan menangani perubahan pada semua checkbox di dalamnya
       // (change event bubbling didukung, dan tableContainer dipertahankan di DOM)
       const tableContainer = document.getElementById('table');
       if (tableContainer){
         if (!tableContainer.dataset.cbDelegated){
           tableContainer.addEventListener('change', async (ev)=>{
             // Checkbox selection per-baris
             const cb = ev.target.closest("input[type='checkbox'][data-id]");
             if (cb){
               const id = +cb.getAttribute('data-id');
               if (cb.checked) selected.add(id); else selected.delete(id);
               return;
             }
             // Inline update status (khusus admin/supervisor)
             const sel = ev.target.closest("select[data-status]");
             if (sel){
               if (!canEdit) return; // safety: hanya admin/supervisor
               const id = +sel.getAttribute('data-status');
               const newStatus = String(sel.value||'').toLowerCase();
               try{
                 sel.disabled = true;
                 const item = (data||[]).find(x=> Number(x.id)===id);
                 const payload = {
                   code: String(item?.code||''),
                   nama: String(item?.nama||''),
                   unit: String(item?.unit||''),
                   description: String(item?.description||''),
                   status: newStatus,
                 };
                 await api('/api/items/'+id, { method:'PUT', body: payload });
                 data = await api('/api/items');
                 indexRows(data);
                 render();
               }catch(e){ console.error('Update status error:', e); alert('Gagal menyimpan status'); }
               finally{ sel.disabled = false; }
             }
           });
           tableContainer.dataset.cbDelegated = '1';
         }
       }
       // Bind tombol Edit/Hapus setelah render tabel
       // document.querySelectorAll('button[data-edit]').forEach(b=> b.onclick = ()=> openModal('Edit Item', data.find(x=> x.id==b.getAttribute('data-edit'))));
       // document.querySelectorAll('button[data-del]').forEach(b=> b.onclick = async ()=>{
       //  if(await confirmDialog('Hapus item ini?')){
       //     const delId = +b.getAttribute('data-del');
       //     await api('/api/items/'+delId, { method:'DELETE' });
       //     if (selected.has(delId)) selected.delete(delId);
       //     data = await api('/api/items');
       //     render();
       //   }
       // });
       
       // Event delegation pada container tabel untuk tombol aksi
       if (tableContainer){
       if (!tableContainer.dataset.clickDelegated){
          tableContainer.addEventListener('click', async (ev)=>{
            const btn = ev.target.closest('button');
            if (!btn) return;
            // Edit
            if (btn.hasAttribute('data-edit')){
              const id = btn.getAttribute('data-edit');
              const item = data.find(x=> String(x.id)===String(id));
              if (item) openModal('Edit Item', item);
              return;
            }
            // View (untuk role non-editor, termasuk Teknisi)
            if (btn.hasAttribute('data-view')){
              const id = btn.getAttribute('data-view');
              const item = data.find(x=> String(x.id)===String(id));
              if (item) openView('Lihat Item', item);
              return;
            }
            // Delete
            if (btn.hasAttribute('data-del')){
              if (!(await confirmDialog('Hapus item ini?'))) return;
              const delId = +btn.getAttribute('data-del');
              try{
                btn.disabled = true;
                await api('/api/items/'+delId, { method:'DELETE' });
                if (selected.has(delId)) selected.delete(delId);
                data = await api('/api/items');
                indexRows(data);
                render();
              }catch(e){ console.error('Delete item error:', e); alert(e && e.error ? e.error : 'Gagal menghapus item'); }
              finally{ btn.disabled = false; }
              return;
            }
          });
          tableContainer.dataset.clickDelegated = '1';
        }
      }
    }

    document.getElementById('search').oninput = debounce(render, 200);
    document.getElementById('rowsPerPage').onchange = (e)=>{ const val = String(e.target.value||''); rows = (val==='all') ? Number.MAX_SAFE_INTEGER : parseInt(val); page=1; render(); };
    // ... existing code ...
    const addBtn = document.getElementById('addBtn');
    if (addBtn){
    addBtn.onclick = ()=>{
    if (canEdit) return openModal('Tambah Item', {});
    if (user.role==='teknisi') { alert('Role Teknisi tidak punya akses untuk menambah item.'); return; }
    // Non-editor lain: tidak melakukan apa-apa (tanpa popup)
    };
    if (!canEdit && user.role!=='teknisi') addBtn.disabled = true;
    }
    const bulkBtn = document.getElementById('bulkDeleteBtn');
    if (bulkBtn) bulkBtn.onclick = async ()=>{
      if (!canEdit) return alert('Tidak punya akses');
      if (!selected || selected.size===0) return alert('Tidak ada yang dipilih');
      if (!(await confirmDialog('Hapus data yang terpilih?'))) return;
      try{
        bulkBtn.disabled = true;
        const ids = Array.from(selected);
        const results = await Promise.allSettled(ids.map(id=> api('/api/items/'+id, { method:'DELETE' })));
        const ok = results.filter(r=> r.status==='fulfilled').length;
        const fail = results.length - ok;
        selected.clear();
        data = await api('/api/items');
        indexRows(data);
        render();
        alert(`Bulk delete selesai. Sukses: ${ok}${fail?`, Gagal: ${fail}`:''}`);
      }catch(e){
        console.error('Bulk delete items error:', e);
        alert('Gagal melakukan bulk delete.');
      } finally {
        bulkBtn.disabled = false;
      }
    };

    // Helper untuk download Blob
    function downloadBlob(filename, blob){
      try{
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url; a.download = filename; a.style.display = 'none';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
      }catch(e){ console.error('downloadBlob error:', e); alert('Gagal mengunduh file.'); }
    }

    // Export Excel
    const btnExportExcel = document.getElementById('exportExcel');
    if (btnExportExcel) btnExportExcel.onclick = async ()=>{
      try{
        await window.ensureExcelJS();
        if (!window.ExcelJS){ alert('Library ExcelJS tidak tersedia.'); return; }
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('Items');
        const exportCols = columns.filter(c=> c.key !== '__act' && c.key !== '__sel');
        ws.addRow(exportCols.map(c=> c.label));
        const headerRow = ws.getRow(1);
        headerRow.font = { bold:true, color:{ argb:'FFFFFFFF' } };
        headerRow.alignment = { horizontal:'center', vertical:'middle' };
        headerRow.height = 22;
        headerRow.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF0D47A1' } });
        // Lebar kolom seragam
        const widthsMap = { code:14, nama:24, unit:12, description:40, status:14 };
        ws.columns = exportCols.map(c=> ({ header:c.label, key:c.key, width: widthsMap[c.key] || 16 }));
        // Freeze header dan AutoFilter
        ws.views = [{ state: 'frozen', ySplit: 1 }];
        const lastColLetter = String.fromCharCode(64 + exportCols.length);
        ws.autoFilter = `A1:${lastColLetter}1`;
        // Data: gunakan baris terpilih bila ada, jika tidak pakai semua yang difilter
        const q = document.getElementById('search').value;
        const filteredAll = (typeof filterData==='function') ? (filterData(data, q) || []) : (data || []);
        const useSelected = selected && selected.size>0;
        const idSet = useSelected ? new Set(Array.from(selected)) : null;
        const rowsSource = useSelected ? filteredAll.filter(r=> idSet.has(r.id)) : filteredAll;
        rowsSource.forEach(row=> ws.addRow(exportCols.map(c=> String(row[c.key] ?? ''))));
        // Wrap text untuk description
        const descIdx = exportCols.findIndex(c=> c.key==='description');
        if (descIdx>=0){ ws.getColumn(descIdx+1).alignment = { wrapText:true, vertical:'top' }; }
        // Borders & zebra striping
        for (let r = 2; r <= ws.rowCount; r++){
          const row = ws.getRow(r);
          if (r % 2 === 0){ row.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFF2F6FC' } }); }
          row.eachCell(cell=>{ cell.border = {
            top: { style:'thin', color:{ argb:'FFB0BEC5' } },
            left: { style:'thin', color:{ argb:'FFB0BEC5' } },
            bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
            right: { style:'thin', color:{ argb:'FFB0BEC5' } },
          }; });
        }
        const buffer = await wb.xlsx.writeBuffer();
        downloadBlob('items.xlsx', new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
      }catch(e){ console.error('Export Excel error:', e); alert('Gagal mengekspor Excel.'); }
    };

    // Import Excel
    const btnImportExcel = document.getElementById('importExcel');
    if (btnImportExcel) btnImportExcel.onclick = async ()=>{
       try{
        if (!canImportExport) { alert('Tidak punya akses untuk import.'); return; }
        await window.ensureExcelJS();
        if (!window.ExcelJS){ alert('Library ExcelJS tidak tersedia.'); return; }
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.xlsx';
        input.onchange = async (e)=>{
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const ab = await file.arrayBuffer();
          const wb = new ExcelJS.Workbook();
          await wb.xlsx.load(ab);
          const ws = wb.worksheets[0];
          if (!ws){ alert('Worksheet tidak ditemukan.'); return; }
          const expected = ['ID','Nama','Unit','Description','Status'];
          const header = expected.map((_,i)=> String(ws.getRow(1).getCell(i+1).value||'').trim());
          const okHeader = expected.every((h,i)=> (header[i]||'').toLowerCase() === h.toLowerCase());
          if (!okHeader){ alert('Format header tidak sesuai. Pastikan sama seperti hasil Export: '+expected.join(', ')); return; }
          const rows = [];
          for (let r = 2; r <= ws.rowCount; r++){
            const row = ws.getRow(r);
            const code = String(row.getCell(1).value ?? '').trim();
            const nama = String(row.getCell(2).value ?? '').trim();
            const unit = String(row.getCell(3).value ?? '').trim();
            const description = String(row.getCell(4).value ?? '').trim();
            const status = String(row.getCell(5).value ?? '').trim();
            if (![code,nama,unit,description,status].some(v=> (v!=='' && v!==null && v!==undefined))) continue;
            rows.push({ code, nama, unit, description, status });
          }
          if (!rows.length){ alert('Tidak ada data untuk diimport.'); return; }
          // Insert/Update per baris berdasarkan ID (kolom Code)
          const existingByCode = new Map((data||[]).map(it=> [String(it.code||'').trim().toLowerCase(), it]));
          let inserted = 0, updated = 0, errors = 0;
          const errorDetails = [];
          for (const r of rows){
            const key = String(r.code||'').trim().toLowerCase();
            const payload = { code:r.code, nama:r.nama, unit:r.unit, description:r.description, status: String(r.status||'').toLowerCase() };
            try{
              const existing = existingByCode.get(key);
              if (existing && existing.id){ await api('/api/items/'+existing.id, { method:'PUT', body: payload }); updated++; }
              else { await api('/api/items', { method:'POST', body: payload }); inserted++; }
            }catch(e){
              console.error('Import row error:', e);
              errors++;
              const msg = (e && (e.error || e.message)) ? (e.error || e.message) : 'Unknown error';
              errorDetails.push({ id: r.code || '(kosong)', error: msg });
            }
          }
          const firstErr = errorDetails.length ? ` (ID ${errorDetails[0].id}: ${errorDetails[0].error})` : '';
          alert(`Import selesai. Inserted: ${inserted}, Updated: ${updated}${errors?`, Errors: ${errors}${firstErr}`:''}`);
          data = await api('/api/items'); indexRows(data); render();
        };
        input.click();
      }catch(e){ console.error('Gagal import Excel:', e); alert('Gagal import Excel.'); }
    };

    // Export PDF
    const btnExportPDF = document.getElementById('exportPDF');
    if (btnExportPDF) btnExportPDF.onclick = async ()=>{
      try{
        await window.ensureJsPDF();
        if (window.jspdf && window.jspdf.jsPDF){
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
          const exportCols = columns.filter(c=> c.key !== '__act' && c.key !== '__sel');
          const head = [exportCols.map(c=> c.label)];
          const q = document.getElementById('search')?.value || '';
          const filteredAll = (typeof filterData==='function') ? (filterData(data, q) || []) : (data || []);
          const useSelected = selected && selected.size>0;
          const idSet = useSelected ? new Set(Array.from(selected)) : null;
          const rowsSource = useSelected ? filteredAll.filter(r=> idSet.has(r.id)) : filteredAll;
          const body = rowsSource.map(row => exportCols.map(c => String(row[c.key] ?? '')));
          if (doc.autoTable){
            doc.autoTable({
              head, body,
              styles: { fontSize: 8, cellPadding: 3 },
              headStyles: { fillColor: [13,71,161], textColor: 255 },
              margin: { top: 20, left: 15, right: 15 },
            });
          }
          doc.save('items.pdf');
        } else {
          alert('Library jsPDF tidak tersedia.');
        }
      }catch(e){ console.error('Export PDF error:', e); alert('Gagal export PDF.'); }
     };

    // Index data untuk pencarian cepat, lalu render
    indexRows(data);
    render();
  })(); });
  </script>
</body>
</html>