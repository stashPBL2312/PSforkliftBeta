<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jobs</title>
  <script src="/common.js" defer></script>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    .wrap { max-width:1000px; margin:20px auto; padding:0 16px; }
    input, select, textarea, button { padding:6px 8px; }
    /* Ikuti preferensi skema warna agar kontrol form (termasuk date picker) adaptif */
    input[type="date"] { color-scheme: light; }
    [data-theme="dark"] input[type="date"] { color-scheme: dark; }
    /* Date icon: use custom mask driven by currentColor; hide native indicator */
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; filter: none !important; }
    .date-input-wrap { position: relative; display: inline-block; color:#111; }
    [data-theme="dark"] .date-input-wrap { color:#fff; }
    .date-input-wrap input[type="date"] { padding-right: 30px; }
    .date-input-wrap::after { content: ""; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none; background-color: currentColor; -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; }
    textarea { width:100%; min-height:80px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card { background:#fff; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; }
    [data-theme="dark"] .card label, [data-theme="dark"] .card, [data-theme="dark"] .card .muted { color:#e5e7eb !important; }
    label { font-size:12px; color:#555; }
    /* Rich text area mimic textarea */
    .rte { width:100%; min-height:80px; border:1px solid #eee; border-radius:6px; padding:6px; outline:none; }
    .rte:focus { border-color:#c5d9fd; box-shadow:0 0 0 2px #e8f0fe; }
    /* RTE toolbar */
    .rte-toolbar { display:flex; gap:6px; margin:4px 0 6px; }
    .rte-toolbar button { padding:4px 6px; border:1px solid #ddd; background:#f7f7f7; border-radius:4px; cursor:pointer; }
    .rte-toolbar button:hover { background:#eee; }
    .rte-toolbar button.active { background:#e0e0e0; border-color:#ccc; }
    /* Chips + Suggest */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; }
    .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
    .chip .x:hover { color:#000; }
    /* Chosen items row + mobile friendly X button */
    .chosen-row { display:flex; align-items:center; gap:8px; padding:6px 0; }
    .chosen-row .label { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chosen-row .qty { width:72px; }
    .xbtn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; font-size:18px; line-height:1; }
    .xbtn:active { transform: scale(0.98); }
    .xbtn:focus { outline: 2px solid #c5d9fd; }
    [data-theme="dark"] .xbtn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    @media (max-width: 768px){
      .xbtn { width:40px; height:40px; font-size:20px; }
    }
    /* Clear button for suggest inputs */
    /* Improve clear button proximity to input */
    .input-suggest-wrap .clear-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; font-size:16px; color:#888; padding:2px; line-height:1; }
    .input-suggest-wrap .clear-btn:hover { color:#000; }
    [data-theme="dark"] .input-suggest-wrap .clear-btn { color:#e5e7eb; }
    .input-suggest-wrap input { padding-right: 28px; }
    /* Override khusus forklift: clear button di kiri, beri padding kiri agar tidak menimpa teks */
    .input-suggest-wrap.fk .clear-btn { left:4px; right:auto; }
    .input-suggest-wrap.fk input { padding-left:28px; padding-right:8px; }
    /* Qty input placed before adding item */
    #itemQty { width:72px; }
    .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:96px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
    .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
    .suggest .item:hover { background:#f6f9ff; }
    /* Dark mode: tone down suggest dropdown contrast */
    [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
    [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
    [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
    
    .muted { font-size:11px; color:#777; }
     [data-theme="dark"] .muted { color:#fff; }
     [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }
     /* Dark mode: visibilitas ikon kalender input tanggal */
     /* Hapus rule yang menyembunyikan indikator */
     /* Reset aturan indikator sebelumnya agar tidak menimpa */
     /* removed: show native indicator */
     /* input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; opacity: 1; } */
     /* [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; opacity: 1; } */
     /* [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator,
     :root:not([data-theme]) input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; } */
     /* Paksa skema warna native mengikuti tema (tetap native behavior) */
     input[type="date"] { color-scheme: light; }
     [data-theme="dark"] input[type="date"] { color-scheme: dark; }
     /* Wrapper + ikon custom bergaya seperti ikon lain (pakai currentColor) */
     .date-input-wrap { position: relative; display: inline-block; color:#111; }
     [data-theme="dark"] .date-input-wrap { color:#fff; }
     .date-input-wrap input[type="date"] { padding-right: 30px; }
     .date-input-wrap::after {
       content: ""; position:absolute; right:8px; top:50%; transform:translateY(-50%);
       width:18px; height:18px; pointer-events:none;
       background-color: currentColor;
       -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain;
               mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain;
     }
     /* Sembunyikan ikon native tapi pertahankan area klik datepicker */
     input[type="date"]::-webkit-calendar-picker-indicator { opacity:0 !important; filter:none !important; }
     /* removed: jangan tampilkan indikator native di dark mode */
     /* [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1 !important; filter: invert(1) brightness(1.2) contrast(1.05) !important; } */
     /* Hapus aturan sisa date-input-wrap agar tidak mempengaruhi layout */
     /* REMOVED conflicting overrides: keep custom mask icon */
     /*
     .date-input-wrap { display: initial; position: initial; width: auto; }
     .date-input-wrap input[type="date"] { padding-right: initial; width: auto; }
     .date-input-wrap::after { content: none; }
     [data-theme="dark"] .date-input-wrap::after { background-image: none !important; }
     [data-theme="light"] .date-input-wrap::after, :root:not([data-theme]) .date-input-wrap::after { background-image: none !important; }
     [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1 !important; filter: invert(1) brightness(1.2) contrast(1.05) !important; }
     */
     textarea { width:100%; min-height:80px; }
     .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
     .card { background:#fff; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; }
     [data-theme="dark"] .card label, [data-theme="dark"] .card, [data-theme="dark"] .card .muted { color:#e5e7eb !important; }
     label { font-size:12px; color:#555; }
     /* Rich text area mimic textarea */
     .rte { width:100%; min-height:80px; border:1px solid #eee; border-radius:6px; padding:6px; outline:none; }
     .rte:focus { border-color:#c5d9fd; box-shadow:0 0 0 2px #e8f0fe; }
     /* RTE toolbar */
     .rte-toolbar { display:flex; gap:6px; margin:4px 0 6px; }
     .rte-toolbar button { padding:4px 6px; border:1px solid #ddd; background:#f7f7f7; border-radius:4px; cursor:pointer; }
     .rte-toolbar button:hover { background:#eee; }
     .rte-toolbar button.active { background:#e0e0e0; border-color:#ccc; }
     /* Chips + Suggest */
     .chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
     .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; }
     .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
     .chip .x:hover { color:#000; }
     /* Chosen items row + mobile friendly X button */
     .chosen-row { display:flex; align-items:center; gap:8px; padding:6px 0; }
     .chosen-row .label { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
     .chosen-row .qty { width:72px; }
     .xbtn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; font-size:18px; line-height:1; }
     .xbtn:active { transform: scale(0.98); }
     .xbtn:focus { outline: 2px solid #c5d9fd; }
     [data-theme="dark"] .xbtn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
     @media (max-width: 768px){
       .xbtn { width:40px; height:40px; font-size:20px; }
     }
     /* Clear button for suggest inputs */
     /* Improve clear button proximity to input */
     .input-suggest-wrap .clear-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; font-size:16px; color:#888; padding:2px; line-height:1; }
     .input-suggest-wrap .clear-btn:hover { color:#000; }
     [data-theme="dark"] .input-suggest-wrap .clear-btn { color:#e5e7eb; }
     .input-suggest-wrap input { padding-right: 28px; }
     /* Override khusus forklift: clear button di kiri, beri padding kiri agar tidak menimpa teks */
     .input-suggest-wrap.fk .clear-btn { left:4px; right:auto; }
     .input-suggest-wrap.fk input { padding-left:28px; padding-right:8px; }
     /* Qty input placed before adding item */
     #itemQty { width:72px; }
     .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:96px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
     .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
     .suggest .item:hover { background:#f6f9ff; }
     /* Dark mode: tone down suggest dropdown contrast */
     [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
     [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
     [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
     
     .muted { font-size:11px; color:#777; }
      [data-theme="dark"] .muted { color:#fff; }
      [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }
      /* Dark mode: visibilitas ikon kalender input tanggal */
      /* Hapus rule yang menyembunyikan indikator */
      /* (dihapus) [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; } */
  
    /* Responsive */
    @media (max-width: 768px){
      .wrap { margin:12px auto; padding:0 12px; }
      .row { grid-template-columns: 1fr; }
      .rte-toolbar { flex-wrap: wrap; }
      .input-suggest-wrap { width:100%; }
      /* Tinggikan suggest dan buat lebih mudah discroll di mobile */
      .suggest { max-height: 35vh; -webkit-overflow-scrolling: touch; }
       #itemList { max-height: 50vh !important; overflow: auto !important; }
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="wrap">
    <h2>Buat Job</h2>
    <div class="card">
      <div class="row">
        <div>
          <label>Jenis Pekerjaan</label>
          <select id="jenis">
            <option>PM</option>
            <option>Lapangan</option>
            <option>Workshop</option>
          </select>
        </div>
        <div>
          <label>Tanggal</label>
          <div class="date-input-wrap"><input id="tanggal" type="date" required /></div>
        </div>
        <div>
          <label>Forklift</label>
          <div class="input-suggest-wrap fk" style="position:relative;">
             <input id="fk_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
             <button id="fk_clear" class="clear-btn" type="button" title="Hapus forklift" aria-label="Hapus forklift">&times;</button>
             <div id="fkSuggest" class="suggest" style="display:none;"></div>
           </div>
        </div>
        <div>
          <label>Teknisi</label>
          <div id="teknisi_tags" class="chips"></div>
          <div class="input-suggest-wrap" style="position:relative;">
            <input id="teknisi_input" placeholder="Ketik untuk cari teknisi..." autocomplete="off" />
            <div id="techSuggest" class="suggest" style="display:none;"></div>
          </div>
          <div class="muted">Klik pada hasil untuk menambahkan. Hapus dengan klik tanda &times; pada chip.</div>
        </div>
        <div>
          <label>Report No</label>
          <input id="report_no" placeholder="Ketik Report No" />
        </div>
        <div id="nextPmWrap" style="display:none;">
          <label>Next PM</label>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label><input type="radio" name="nextpm" value="1" /> +1 bulan</label>
            <label><input type="radio" name="nextpm" value="2" /> +2 bulan</label>
            <label><input type="radio" name="nextpm" value="3" /> +3 bulan</label>
          </div>
          <div class="date-input-wrap"><input id="next_pm_date" type="date" placeholder="Atau pilih custom" /></div>
          <div class="muted">Pilih radio untuk autofill, atau isi langsung date untuk custom</div>
        </div>
      </div>
      <div>
        <label>Pekerjaan</label>
        <div class="rte-toolbar">
          <button type="button" data-target="description" data-cmd="bold"><b>B</b></button>
          <button type="button" data-target="description" data-cmd="italic"><i>I</i></button>
          <button type="button" data-target="description" data-cmd="underline"><u>U</u></button>
          <button type="button" data-target="description" data-cmd="insertUnorderedList">&bull; List</button>
          <button type="button" data-target="description" data-cmd="insertOrderedList">1. List</button>
        </div>
        <div id="description" class="rte" contenteditable="true"></div>
      </div>
      <div>
        <label>Recommendation</label>
        <div class="rte-toolbar">
          <button type="button" data-target="recommendation" data-cmd="bold"><b>B</b></button>
          <button type="button" data-target="recommendation" data-cmd="italic"><i>I</i></button>
          <button type="button" data-target="recommendation" data-cmd="underline"><u>U</u></button>
          <button type="button" data-target="recommendation" data-cmd="insertUnorderedList">&bull; List</button>
          <button type="button" data-target="recommendation" data-cmd="insertOrderedList">1. List</button>
        </div>
        <div id="recommendation" class="rte" contenteditable="true"></div>
      </div>
      <div id="itemsUsedWrap">
        <label>Item dipakai (pilih dari katalog)</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="input-suggest-wrap" style="position:relative; flex:1;">
            <input id="itemSearch" placeholder="Cari item..." autocomplete="off" />
            <div id="itemSuggest" class="suggest" style="display:none;"></div>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <label for="itemQty" style="font-size:12px; color:#555;">Qty</label>
            <input id="itemQty" type="number" min="1" value="1" />
          </div>
        </div>
        <div id="itemList" style="display:none;"></div>
        <div id="chosenItems" style="margin-top:6px;"></div>
      </div>
      <div id="itemsFreeWrap" style="display:none;">
        <label>Item dipakai (free text)</label>
        <div id="items_free" class="rte" contenteditable="true"></div>
      </div>
      <div style="text-align:right; margin-top:10px;">
        <button id="saveBtn">Simpan Job</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{ (async function(){
    const user = await ensureAuthedAndRenderNav(); if (!user) return;
    const forklifts = await api('/api/forklifts');
    const items = await api('/api/items');
    // Indexing untuk pencarian cepat (_q) tanpa mengubah perilaku
    function indexFk(rows){
      try { (rows||[]).forEach(r=>{ const vals=[r.location,r.eq_no,r.brand,r.type,r.powertrain]; r._q = vals.map(v=> String(v||'').toLowerCase()).join(' | '); }); } catch {}
      return rows;
    }
    function indexItems(rows){
      try { (rows||[]).forEach(r=>{ const vals=[r.code,r.nama,r.status]; r._q = vals.map(v=> String(v||'').toLowerCase()).join(' | '); }); } catch {}
      return rows;
    }
    indexFk(forklifts); indexItems(items);
    // Hasil pencarian teknisi via AJAX
    let lastTechResults = [];
    let techReqSeq = 0;

    // Forklift input + suggest (searchable, single-select)
    const fkCache = Array.isArray(forklifts) ? forklifts : [];
    const fkInput = document.getElementById('fk_input');
    const fkSuggest = document.getElementById('fkSuggest');
    const fkClear = document.getElementById('fk_clear');
    // Hint performa untuk dropdown suggest agar render ringan
    ;[fkSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    let jobForkliftId = null;
    if (fkClear) {
      fkClear.addEventListener('click', ()=>{
        jobForkliftId = null;
        if (fkInput) fkInput.value = '';
        if (fkSuggest){ fkSuggest.innerHTML=''; fkSuggest.style.display='none'; }
      });
    }
    function fkLabel(f){ return [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - '); }
    function filterFk(q){
      const s = String(q||'').toLowerCase();
      if (!s) return fkCache;
      try { return fkCache.filter(f=> String(f._q||'').includes(s)); }
      catch { return fkCache.filter(f=> [f.location, f.eq_no, f.brand, f.type, f.powertrain].some(v=> String(v||'').toLowerCase().includes(s)) ); }
    }
    function renderFkSuggest(){
      if (!fkInput || !fkSuggest) return;
      const list = filterFk(fkInput.value);
      if (!Array.isArray(list) || list.length===0){ fkSuggest.style.display='none'; fkSuggest.innerHTML=''; return; }
      fkSuggest.innerHTML = list.map(f=>`<div class="item" data-id="${f.id}">${fkLabel(f)}</div>`).join('');
      fkSuggest.style.display='block';
      // drag guard: cegah tap saat pengguna sedang scroll di dalam suggest
      if (!fkSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        fkSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        fkSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        fkSuggest._isDragging = ()=>dragging;
        fkSuggest._dragGuardAttached = true;
      }
      fkSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = (ev)=>{
          if (fkSuggest._isDragging && fkSuggest._isDragging()) { ev.preventDefault(); return; }
          const id = +it.getAttribute('data-id');
          const f = fkCache.find(x=>x.id===id); if (!f) return;
          jobForkliftId = f.id;
          fkInput.value = fkLabel(f);
          fkSuggest.style.display='none';
          reportDirty = false; try { if (typeof autofillReport === 'function') { autofillReport(); } } catch(e) {}
        };
      });
    }
    if (fkInput){
      const debouncedFk = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),200); }; })(renderFkSuggest);
      fkInput.addEventListener('input', ()=>{ jobForkliftId = null; });
      fkInput.addEventListener('input', debouncedFk);
      fkInput.addEventListener('focus', ()=> renderFkSuggest());
      fkInput.addEventListener('click', ()=> renderFkSuggest());
      fkInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = fkSuggest && fkSuggest.querySelector('.item');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (fkSuggest) fkSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (fkSuggest && !fkSuggest.contains(e.target) && e.target!==fkInput){ fkSuggest.style.display='none'; } });
      // Hapus default auto-select: wajib pilih forklift secara eksplisit
      // if (fkCache[0]){ jobForkliftId = fkCache[0].id; fkInput.value = fkLabel(fkCache[0]); }
    }
    // Teknisi tag-style selector
    const techInput = document.getElementById('teknisi_input');
    const techTags = document.getElementById('teknisi_tags');
    const techSuggest = document.getElementById('techSuggest');
    ;[techSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    let selectedTech = [];
    // helper debounce
    const makeDebounce = (fn, delay=250)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; };

    function renderTechTags(){
      techTags.innerHTML = selectedTech.map(t=>`<span class="chip" data-id="${t.id}">${t.label} <button class="x" title="Hapus" data-rem="${t.id}">&times;</button></span>`).join('');
      techTags.querySelectorAll('button[data-rem]').forEach(b=>{
        b.onclick = ()=>{ const id = +b.getAttribute('data-rem'); selectedTech = selectedTech.filter(x=>x.id!==id); renderTechTags(); };
      });
    }

    // fetch & render suggest teknisi via AJAX (show list even when query is empty)
    const fetchAndRenderTech = async ()=>{
      const q = (techInput.value||'').trim();
      const seq = ++techReqSeq;
      let list = [];
      try {
        const url = q ? ('/api/technicians?q='+encodeURIComponent(q)) : '/api/technicians';
        list = await api(url);
      } catch(e) { list = []; }
      if (seq !== techReqSeq) return; // abaikan respon lama
      lastTechResults = list;
      if (!Array.isArray(list) || list.length===0){ techSuggest.style.display='none'; techSuggest.innerHTML=''; return; }
      techSuggest.innerHTML = list.map(t=>{
        const label = (t.name && t.name.trim()) ? `${t.name} <${t.email}>` : t.email;
        return `<div class="item" data-id="${t.id}">${label}</div>`;
      }).join('');
      techSuggest.style.display='block';
      if (!techSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        techSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        techSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        techSuggest._isDragging = ()=>dragging;
        techSuggest._dragGuardAttached = true;
      }
      techSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = ()=>{
          if (techSuggest._isDragging && techSuggest._isDragging()) return;
          const id = +it.getAttribute('data-id');
          const t = lastTechResults.find(x=>x.id===id);
          if (!t) return;
          if (!selectedTech.some(x=>x.id===t.id)){
            const label = (t.name && t.name.trim()) ? `${t.name} <${t.email}>` : t.email;
            const value = (t.name && t.name.trim()) ? t.name : t.email;
            selectedTech.push({ id:t.id, label, value });
            renderTechTags();
          }
          techInput.value = '';
          techSuggest.style.display='none';
        };
      });
    };

    // input handlers teknisi
    techInput.addEventListener('keydown', (e)=>{
      if (e.key==='Enter'){
        const first = techSuggest.querySelector('.item');
        if (first){ first.click(); e.preventDefault(); }
      }
    });

    const debouncedFetchTech = makeDebounce(fetchAndRenderTech, 250);
    techInput.addEventListener('input', debouncedFetchTech);
    techInput.addEventListener('focus', ()=>{ fetchAndRenderTech(); });
    techInput.addEventListener('click', ()=>{ fetchAndRenderTech(); });

    // klik di luar untuk menutup suggest
    document.addEventListener('click', (e)=>{
      if (!techSuggest.contains(e.target) && e.target!==techInput){ techSuggest.style.display='none'; }
    });

    // Simple sanitize to allow only safe tags
    function sanitizeHTML(html){
      const allowed = new Set(['B','I','U','BR','P','UL','OL','LI','STRONG','EM']);
      const div = document.createElement('div');
      div.innerHTML = html;
      const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null);
      const toRemove = [];
      let node;
      while(node = walker.nextNode()){
        if (!allowed.has(node.tagName)) toRemove.push(node);
        else {
          // strip attributes
          while(node.attributes && node.attributes.length>0){ node.removeAttribute(node.attributes[0].name); }
        }
      }
      toRemove.forEach(n=> n.replaceWith(document.createTextNode(n.textContent || '')));
      return div.innerHTML
        .replace(/\u00A0/g, ' ') // nbsp to space
        .trim();
    }

    function getRteValue(id){
      const el = document.getElementById(id);
      return sanitizeHTML(el.innerHTML || '');
    }

    // RTE toolbar handlers + toggle state
    function getActiveRteId(){
      const sel = document.getSelection();
      if (!sel || !sel.anchorNode) return null;
      let n = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
      while(n && n !== document){
        if (n.getAttribute && n.getAttribute('contenteditable')==='true') return n.id;
        n = n.parentElement;
      }
      return null;
    }

    function updateToolbarState(){
      const activeId = getActiveRteId();
      const commands = ['bold','italic','underline','insertUnorderedList','insertOrderedList'];
      document.querySelectorAll('.rte-toolbar button').forEach(btn=>{
        const target = btn.dataset.target;
        const cmd = btn.dataset.cmd;
        if (target===activeId && commands.includes(cmd)){
          let on = false; try { on = document.queryCommandState(cmd); } catch (e) {}
          btn.classList.toggle('active', !!on);
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.querySelectorAll('.rte-toolbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        target.focus();
        try { document.execCommand(btn.dataset.cmd, false, null); } catch (e) {}
        updateToolbarState();
      });
    });
    document.addEventListener('selectionchange', updateToolbarState);

    let chosen = [];

    // Item suggest (dropdown) mirip forklift/teknisi
    const itemInput = document.getElementById('itemSearch');
    const itemSuggest = document.getElementById('itemSuggest');
    ;[itemSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    const itemQtyEl = document.getElementById('itemQty');

    function filterItems(q){
      const s = String(q||'').toLowerCase();
      if (!s) return items;
      try { return items.filter(i=> String(i._q||'').includes(s)); }
      catch { return items.filter(i=> Object.values(i).some(v=> String(v||'').toLowerCase().includes(s)) ); }
    }

    function renderItemSuggest(){
      if (!itemInput || !itemSuggest) return;
      const list = filterItems(itemInput.value);
      if (!Array.isArray(list) || list.length===0){ itemSuggest.style.display='none'; itemSuggest.innerHTML=''; return; }
      itemSuggest.innerHTML = list.map(i=>{
        const unavailable = String(i.status||'').toLowerCase()==='unavailable';
        const rowStyle = unavailable ? 'opacity:0.5;' : '';
        const statusBadge = unavailable ? " <span class='muted'>(unavailable)</span>" : '';
        return `<div class="item" data-id="${i.id}" data-unavail="${unavailable?1:0}" style="${rowStyle}">${i.code} - ${i.nama}${statusBadge}</div>`;
      }).join('');
      itemSuggest.style.display='block';
      // drag guard untuk mobile
      if (!itemSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        itemSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        itemSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        itemSuggest._isDragging = ()=>dragging;
        itemSuggest._dragGuardAttached = true;
      }
      itemSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = (ev)=>{
          if (itemSuggest._isDragging && itemSuggest._isDragging()) { ev.preventDefault(); return; }
          const unavail = it.getAttribute('data-unavail')==='1';
          if (unavail) return; // skip unavailable
          const id = +it.getAttribute('data-id');
          const f = items.find(x=>x.id===id); if (!f) return;
          let qty = 1; if (itemQtyEl){ qty = parseInt(itemQtyEl.value||'1',10); if (!qty || qty<1) qty = 1; }
          const exist = chosen.find(c=>c.id===id);
          if (exist) { exist.qty += qty; } else { chosen.push({ id, code: f.code, nama: f.nama, qty }); }
          renderChosen();
          itemInput.value = '';
          if (itemQtyEl) { /* keep user input or reset? choose to keep as-is */ }
          itemSuggest.style.display='none';
        };
      });
    }

    if (itemInput){
      const debouncedItems = ((fn)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), 200); }; })(renderItemSuggest);
      itemInput.addEventListener('input', debouncedItems);
      itemInput.addEventListener('focus', ()=> renderItemSuggest());
      itemInput.addEventListener('click', ()=> renderItemSuggest());
      itemInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = itemSuggest && itemSuggest.querySelector('.item[data-unavail="0"]');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (itemSuggest) itemSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (itemSuggest && !itemSuggest.contains(e.target) && e.target!==itemInput){ itemSuggest.style.display='none'; } });
    }

    function renderChosen(){
      const html = chosen.map(c=>`<div class='chosen-row'>
        <div class='label'>${c.code} - ${c.nama}</div>
        <input class='qty' type='number' min='1' value='${c.qty}' data-qty='${c.id}' />
        <button class='xbtn' aria-label='Hapus item' title='Hapus' data-rem='${c.id}'>&times;</button>
      </div>`).join('');
      document.getElementById('chosenItems').innerHTML = html;
      // handlers qty
      document.querySelectorAll("input[data-qty]").forEach(inp=>{
        inp.onchange = (e)=>{
          const id = +inp.getAttribute('data-qty');
          let v = parseInt(inp.value||'1', 10); if (!v || v<1) v = 1; inp.value = String(v);
          const row = chosen.find(x=>x.id===id); if (row) row.qty = v;
        };
      });
      // handlers remove (tap-friendly)
      document.querySelectorAll('button[data-rem]').forEach(b=>{
        const removeFn = ()=>{ const id = +b.getAttribute('data-rem'); chosen = chosen.filter(c=>c.id!==id); renderChosen(); };
        b.addEventListener('click', removeFn, { passive: true });
        b.addEventListener('pointerdown', (e)=>{ if (e.pointerType === 'touch') { e.preventDefault(); removeFn(); } }, { passive: false });
      });
    }

    // Hapus implementasi list lama
    // document.getElementById('itemSearch').oninput = ()=> renderItems(items);
    // renderItems(items);

    const jenisSel = document.getElementById('jenis');
    // Next PM radio autofill handlers
    const tanggalEl = document.getElementById('tanggal');
    const nextPmDateEl = document.getElementById('next_pm_date');
    const nextPmRadios = Array.from(document.querySelectorAll('input[name=nextpm]'));
    function toISODate(d){ const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
    function addMonthsDate(baseDate, months){ const d=new Date(baseDate.getTime()); const day=d.getDate(); d.setMonth(d.getMonth()+months); if (d.getDate()<day){ d.setDate(0); } return d; }
    function recalcNextPM(){ const sel=document.querySelector('input[name=nextpm]:checked'); if(!sel) return; const months=parseInt(sel.value||'0',10); if(!months) return; const base=tanggalEl.value? new Date(tanggalEl.value): new Date(); const nd=addMonthsDate(base, months); nextPmDateEl.value=toISODate(nd); }
    nextPmRadios.forEach(r=> r.addEventListener('change', recalcNextPM));
    tanggalEl.addEventListener('change', recalcNextPM);

    function updateJenis(){
    const j = jenisSel.value;
    document.getElementById('itemsUsedWrap').style.display = (j==='PM'||j==='Workshop') ? 'block':'none';
    document.getElementById('itemsFreeWrap').style.display = (j==='Lapangan') ? 'block':'none';
    document.getElementById('nextPmWrap').style.display = (j==='PM') ? 'block':'none';
    document.getElementById('report_no').disabled = false;
    if (j==='Workshop' && !reportDirty) { autofillReport(); }
    // Autofill pekerjaan ketika PM dipilih
    const descEl = document.getElementById('description');
    const current = getRteValue('description');
    const pmDefault = 'Preventative Maintenance';
    if (j==='PM'){
    if (!current || current === pmDefault){ descEl.textContent = pmDefault; }
    } else {
    if (current === pmDefault){ descEl.textContent = ''; }
    }
    }
    const reportInput = document.getElementById('report_no');
    let reportDirty = false; // user has typed manually
    reportInput.addEventListener('input', ()=>{ reportDirty = true; });
    
    async function autofillReport(){
    const j = jenisSel.value;
    const fid = parseInt(jobForkliftId||0);
    if (j==='Workshop' && fid){
    try {
    const data = await api('/api/jobs/next-report?forklift_id='+fid);
    // Only autofill if user hasn't typed or the field is empty
    if (!reportDirty || !reportInput.value){
    reportInput.value = data.report_no || '';
    }
    } catch (e) { /* ignore */ }
    }
    }
    
    jenisSel.onchange = ()=>{ updateJenis(); recalcNextPM(); }; updateJenis(); recalcNextPM();
    
    // Autofill when forklift changes for Workshop (if not manually edited)
    // removed: fSel.onchange handler, replaced by suggest selection handler

    function resetJobForm(){
      try {
        // Forklift
        if (typeof jobForkliftId !== 'undefined') jobForkliftId = null;
        const fkInputEl = document.getElementById('fk_input');
        if (fkInputEl) fkInputEl.value = '';
        if (fkSuggest){ fkSuggest.innerHTML=''; fkSuggest.style.display='none'; }

        // Tanggal
        const tglEl = document.getElementById('tanggal');
        if (tglEl) tglEl.value = '';

        // Teknisi
        if (Array.isArray(selectedTech)) selectedTech.length = 0;
        if (typeof renderTechTags === 'function') renderTechTags();
        if (techInput) techInput.value = '';
        if (techSuggest){ techSuggest.innerHTML=''; techSuggest.style.display='none'; }

        // Report No
        const rptEl = document.getElementById('report_no');
        if (rptEl) rptEl.value = '';
        if (typeof reportDirty !== 'undefined') reportDirty = false;

        // Deskripsi & Rekomendasi (RTE)
        const descEl = document.getElementById('description');
        if (descEl) descEl.textContent = '';
        const recEl = document.getElementById('recommendation');
        if (recEl) recEl.textContent = '';

        // Items free text (Lapangan)
        const itemsFreeEl = document.getElementById('items_free');
        if (itemsFreeEl) itemsFreeEl.textContent = '';

        // Items chosen (Workshop/PM)
        if (Array.isArray(chosen)) chosen.length = 0;
        if (typeof renderChosen === 'function') renderChosen();
        if (itemInput) itemInput.value = '';
        if (itemQtyEl) itemQtyEl.value = '1';
        if (itemSuggest){ itemSuggest.innerHTML=''; itemSuggest.style.display='none'; }

        // Next PM
        const nextDateEl = document.getElementById('next_pm_date');
        if (nextDateEl) nextDateEl.value = '';
        document.querySelectorAll('input[name="nextpm"]').forEach(r=> r.checked = false);

        // Fokus kembali ke forklift untuk input cepat berikutnya
        if (fkInputEl) fkInputEl.focus();
      // Jika jenis adalah PM, kembalikan default teks deskripsi PM
      if (typeof updateJenis === 'function') updateJenis();
      } catch (e) { /* ignore */ }
    }

    document.getElementById('saveBtn').onclick = async ()=>{
      const jenis = jenisSel.value;
      const tanggal = document.getElementById('tanggal').value;
      if (!tanggal){ alert('Tanggal wajib diisi.'); document.getElementById('tanggal').focus(); return; }
      if (!jobForkliftId){ alert('Forklift wajib dipilih dari daftar.'); document.getElementById('fk_input').focus(); return; }
      const forklift_id = parseInt(jobForkliftId||0);
      const teknisi = selectedTech.map(o=>o.value).join(', ');
      const report_no = document.getElementById('report_no').value;
      const description = getRteValue('description');
      const recommendation = getRteValue('recommendation');
      let items_used = '';
      let next_pm = null;
      if (jenis==='PM' || jenis==='Workshop') {
        items_used = chosen.map(c=>`${c.code} ${c.nama} x ${c.qty}`).join(', ');
        if (jenis==='PM') {
          // Radio atau custom date
          const radioSel = document.querySelector('input[name="nextpm"]:checked');
          const customDate = document.getElementById('next_pm_date').value;
          if (customDate){
            next_pm = customDate;
          } else if (radioSel){
            const months = parseInt(radioSel.value, 10);
            const base = new Date(tanggal);
            base.setHours(0,0,0,0);
            const d = new Date(base);
            d.setMonth(d.getMonth() + months);
            next_pm = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
          }
        }
      } else if (jenis==='Lapangan') {
        items_used = getRteValue('items_free');
      }

      const payload = { jenis, tanggal, forklift_id, teknisi, report_no, description, recommendation, items_used, next_pm };
      try {
        const r = await api('/api/jobs', { method:'POST', body: payload });
        alert('Tersimpan. Report No: '+r.report_no);
        resetJobForm();
      } catch (e) {
        alert(e.error || 'Gagal simpan');
      }
    };
  })(); });
   </script>
</body>
</html>