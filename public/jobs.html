<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Input Jobs</title>
  <script src="/common.js" defer></script>
  <style>
    /* Prevent horizontal scroll and ensure sizing behaves */
    html, body { max-width:100%; overflow-x:hidden; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; }
    .wrap { max-width:1000px; margin:20px auto; padding:0 16px; }
    input, select, textarea, button { padding:6px 8px; }
    /* Ikuti preferensi skema warna agar kontrol form (termasuk date picker) adaptif */
    input[type="date"] { color-scheme: light; }
    [data-theme="dark"] input[type="date"] { color-scheme: dark; }
    /* Date icon: use custom mask driven by currentColor; hide native indicator */
    input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; filter: none !important; }
    .date-input-wrap { position: relative; display: inline-block; color:#111; }
    [data-theme="dark"] .date-input-wrap { color:#fff; }
    .date-input-wrap input[type="date"] { padding-right: 30px; }
    .date-input-wrap::after { content: ""; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none; background-color: currentColor; -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; }
    textarea { width:100%; min-height:80px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row > * { min-width:0; }
    .row input[type="text"], .row input[type="search"], .row input[type="date"], .row select, .row textarea, .row .rte { width:100%; }
    .card { background:#fff; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; }
    [data-theme="dark"] .card label, [data-theme="dark"] .card, [data-theme="dark"] .card .muted { color:#e5e7eb !important; }
    label { font-size:12px; color:#555; }
    /* Rich text area mimic textarea */
    .rte { width:100%; min-height:80px; border:1px solid #eee; border-radius:6px; padding:6px; outline:none; }
    .rte:focus { border-color:#c5d9fd; box-shadow:0 0 0 2px #e8f0fe; }
    /* Dark mode: perhalus kontras editor dan fokus ring */
    [data-theme="dark"] .rte { background:#0f172a; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] .rte:focus { border-color:#334155; box-shadow:0 0 0 2px #1f2937; }
    /* RTE toolbar */
    .rte-toolbar { display:flex; gap:6px; margin:4px 0 6px; }
    .rte-toolbar button { padding:4px 6px; border:1px solid #ddd; background:#f7f7f7; border-radius:4px; cursor:pointer; }
    .rte-toolbar button:hover { background:#eee; }
    .rte-toolbar button.active { background:#e0e0e0; border-color:#ccc; }
    /* Dark mode: tone down warna tombol toolbar */
    [data-theme="dark"] .rte-toolbar button { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    [data-theme="dark"] .rte-toolbar button:hover { background:#334155; }
    [data-theme="dark"] .rte-toolbar button.active { background:#374151; border-color:#334155; }
    /* Radio group untuk Jenis Pekerjaan */
    .radio-group { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    /* Intro mode: tampilkan Jenis Pekerjaan lebih besar dan jelas */
    .intro-mode #jenisLabel { font-size:22px; font-weight:700; }
    .intro-mode #jenisGroup { font-size:18px; gap:14px; }
    .intro-mode #jenisGroup label { padding:10px 14px; border:2px solid #64748b; border-radius:10px; background:#f8fafc; }
    [data-theme="dark"] .intro-mode #jenisGroup label { border-color:#94a3b8; background:#0b1220; }
    .intro-mode #jenisGuide { font-size:14px; }
    /* Overlay yang jelas untuk blok form yang disabled */
    .form-blocked { position: relative; pointer-events: none; }
    .form-blocked::after { content:""; position:absolute; inset:0; border-radius:6px; background:rgba(255,255,255,0.55); }
    [data-theme="dark"] .form-blocked::after { background:rgba(2,6,23,0.55); }
    .form-blocked { filter: grayscale(0.4) saturate(0.8); }
    /* Chips + Suggest */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
    .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; }
    .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
    .chip .x:hover { color:#000; }
    /* Chosen items row + mobile friendly X button */
    .chosen-row { display:flex; align-items:center; gap:8px; padding:6px 0; }
    .chosen-row .label { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chosen-row .qty { width:72px; }
    .xbtn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; font-size:18px; line-height:1; }
    .xbtn:active { transform: scale(0.98); }
    .xbtn:focus { outline: 2px solid #c5d9fd; }
    [data-theme="dark"] .xbtn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    @media (max-width: 768px){
      .xbtn { width:40px; height:40px; font-size:20px; }
    }
    /* Clear button for suggest inputs */
    /* Improve clear button proximity to input */
    .input-suggest-wrap .clear-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; font-size:16px; color:#888; padding:2px; line-height:1; }
    .input-suggest-wrap .clear-btn:hover { color:#000; }
    [data-theme="dark"] .input-suggest-wrap .clear-btn { color:#e5e7eb; }
    .input-suggest-wrap { max-width:100%; }
    .input-suggest-wrap input { padding-right: 28px; width:100%; }
    /* Override khusus forklift: clear button di kiri, beri padding kiri agar tidak menimpa teks */
    .input-suggest-wrap.fk .clear-btn { left:4px; right:auto; }
    .input-suggest-wrap.fk input { padding-left:28px; padding-right:8px; }
    /* Qty input placed before adding item */
    #itemQty { width:72px; }
    .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:96px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
    .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
    .suggest .item:hover { background:#f6f9ff; }
    /* Dark mode: tone down suggest dropdown contrast */
    [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
    [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
    [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
    
    .muted { font-size:11px; color:#777; }
     [data-theme="dark"] .muted { color:#fff; }
     [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }
     /* Dark mode: visibilitas ikon kalender input tanggal */
     /* Hapus rule yang menyembunyikan indikator */
     /* Reset aturan indikator sebelumnya agar tidak menimpa */
     /* removed: show native indicator */
     /* input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; opacity: 1; } */
     /* [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; opacity: 1; } */
     /* [data-theme="light"] input[type="date"]::-webkit-calendar-picker-indicator,
     :root:not([data-theme]) input[type="date"]::-webkit-calendar-picker-indicator { filter: none !important; } */
     /* Paksa skema warna native mengikuti tema (tetap native behavior) */
     input[type="date"] { color-scheme: light; }
     [data-theme="dark"] input[type="date"] { color-scheme: dark; }
     /* Wrapper + ikon custom bergaya seperti ikon lain (pakai currentColor) */
     .date-input-wrap { position: relative; display: inline-block; color:#111; }
     [data-theme="dark"] .date-input-wrap { color:#fff; }
     .date-input-wrap input[type="date"] { padding-right: 30px; }
     .date-input-wrap::after {
       content: ""; position:absolute; right:8px; top:50%; transform:translateY(-50%);
       width:18px; height:18px; pointer-events:none;
       background-color: currentColor;
       -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain;
               mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain;
     }
     /* Sembunyikan ikon native tapi pertahankan area klik datepicker */
     input[type="date"]::-webkit-calendar-picker-indicator { opacity:0 !important; filter:none !important; }
     /* removed: jangan tampilkan indikator native di dark mode */
     /* [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1 !important; filter: invert(1) brightness(1.2) contrast(1.05) !important; } */
     /* Hapus aturan sisa date-input-wrap agar tidak mempengaruhi layout */
     /* REMOVED conflicting overrides: keep custom mask icon */
     /*
     .date-input-wrap { display: initial; position: initial; width: auto; }
     .date-input-wrap input[type="date"] { padding-right: initial; width: auto; }
     .date-input-wrap::after { content: none; }
     [data-theme="dark"] .date-input-wrap::after { background-image: none !important; }
     [data-theme="light"] .date-input-wrap::after, :root:not([data-theme]) .date-input-wrap::after { background-image: none !important; }
     [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 1 !important; filter: invert(1) brightness(1.2) contrast(1.05) !important; }
     */
     textarea { width:100%; min-height:80px; }
     .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
     .card { background:#fff; padding:12px; border:1px solid #eee; border-radius:8px; margin-bottom:12px; }
     [data-theme="dark"] .card label, [data-theme="dark"] .card, [data-theme="dark"] .card .muted { color:#e5e7eb !important; }
     label { font-size:12px; color:#555; }
     /* Rich text area mimic textarea */
     .rte { width:100%; min-height:80px; border:1px solid #eee; border-radius:6px; padding:6px; outline:none; }
     .rte:focus { border-color:#c5d9fd; box-shadow:0 0 0 2px #e8f0fe; }
     /* Dark mode duplicate section: perhalus editor dan ring */
     [data-theme="dark"] .rte { background:#0f172a; border-color:#334155; color:#e5e7eb; }
     [data-theme="dark"] .rte:focus { border-color:#334155; box-shadow:0 0 0 2px #1f2937; }
     /* RTE toolbar */
     .rte-toolbar { display:flex; gap:6px; margin:4px 0 6px; }
     .rte-toolbar button { padding:4px 6px; border:1px solid #ddd; background:#f7f7f7; border-radius:4px; cursor:pointer; }
     .rte-toolbar button:hover { background:#eee; }
     .rte-toolbar button.active { background:#e0e0e0; border-color:#ccc; }
     /* Dark mode duplicate section: tone down toolbar */
     [data-theme="dark"] .rte-toolbar button { background:#1f2937; border-color:#334155; color:#e5e7eb; }
     [data-theme="dark"] .rte-toolbar button:hover { background:#334155; }
     [data-theme="dark"] .rte-toolbar button.active { background:#374151; border-color:#334155; }
     /* Chips + Suggest */
     .chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
     .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; }
     .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
     .chip .x:hover { color:#000; }
     /* Chosen items row + mobile friendly X button */
     .chosen-row { display:flex; align-items:center; gap:8px; padding:6px 0; }
     .chosen-row .label { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
     .chosen-row .qty { width:72px; }
     .xbtn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:18px; border:1px solid #ddd; background:#f8f8f8; cursor:pointer; font-size:18px; line-height:1; }
     .xbtn:active { transform: scale(0.98); }
     .xbtn:focus { outline: 2px solid #c5d9fd; }
     [data-theme="dark"] .xbtn { background:#1f2937; border-color:#334155; color:#e5e7eb; }
    @media (max-width: 768px){
      .xbtn { width:40px; height:40px; font-size:20px; }
      /* Make date input fill the line on mobile */
      .date-input-wrap { display:block; }
      .date-input-wrap input[type="date"] { width:100%; }
    }
     /* Clear button for suggest inputs */
     /* Improve clear button proximity to input */
     .input-suggest-wrap .clear-btn { position:absolute; right:4px; top:50%; transform:translateY(-50%); border:none; background:transparent; cursor:pointer; font-size:16px; color:#888; padding:2px; line-height:1; }
     .input-suggest-wrap .clear-btn:hover { color:#000; }
     [data-theme="dark"] .input-suggest-wrap .clear-btn { color:#e5e7eb; }
     .input-suggest-wrap input { padding-right: 28px; }
     /* Override khusus forklift: clear button di kiri, beri padding kiri agar tidak menimpa teks */
     .input-suggest-wrap.fk .clear-btn { left:4px; right:auto; }
     .input-suggest-wrap.fk input { padding-left:28px; padding-right:8px; }
     /* Qty input placed before adding item */
     #itemQty { width:72px; }
     .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:320px; min-height:120px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
     .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
     .suggest .item:hover { background:#f6f9ff; }
     /* Dark mode: tone down suggest dropdown contrast */
     [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
     [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
     [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
     
     .muted { font-size:11px; color:#777; }
      [data-theme="dark"] .muted { color:#fff; }
      [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { color:#e5e7eb !important; opacity:1 !important; }
      /* Dark mode: visibilitas ikon kalender input tanggal */
      /* Hapus rule yang menyembunyikan indikator */
      /* (dihapus) [data-theme="dark"] input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; } */
  
    /* Responsive */
    @media (max-width: 768px){
      .wrap { margin:12px auto; padding:0 12px; }
      .row { grid-template-columns: 1fr; }
      .rte-toolbar { flex-wrap: wrap; }
      .input-suggest-wrap { width:100%; }
      /* Tinggikan suggest dan buat lebih mudah discroll di mobile */
      .suggest { max-height: 50vh; -webkit-overflow-scrolling: touch; }
       #itemList { max-height: 50vh !important; overflow: auto !important; }
    }
  </style>
</head>
<body>
  <div id="header"></div>
  <div class="wrap">
    <h2>Input Jobs</h2>
    <div class="toolbar" style="display:flex; justify-content:flex-end; gap:8px; margin-bottom:10px;">
      <button id="backToRecords" type="button">Kembali ke Records</button>
    </div>
    <div class="card">
      <div class="row">
        <div id="jenisWrap">
          <label id="jenisLabel">Jenis Pekerjaan</label>
          <div id="jenisGroup" class="radio-group">
            <label><input type="radio" name="jenis" value="PM" /> PM</label>
            <label><input type="radio" name="jenis" value="Lapangan" /> Lapangan</label>
            <label><input type="radio" name="jenis" value="Workshop" /> Workshop</label>
          </div>
          <div id="jenisGuide" class="muted">Pilih jenis pekerjaan terlebih dahulu sebelum mengisi form.</div>
        </div>
        <div id="tglWrap">
          <label>Tanggal</label>
          <div class="date-input-wrap"><input id="tanggal" type="date" required /></div>
        </div>
        <div id="fkWrap">
          <label>Forklift</label>
          <div class="input-suggest-wrap fk" style="position:relative;">
             <input id="fk_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
             <button id="fk_clear" class="clear-btn" type="button" title="Hapus forklift" aria-label="Hapus forklift">&times;</button>
             <div id="fkSuggest" class="suggest" style="display:none;"></div>
           </div>
        </div>
        <div id="techWrap">
          <label>Teknisi</label>
          <div id="teknisi_tags" class="chips"></div>
          <div class="input-suggest-wrap" style="position:relative;">
            <input id="teknisi_input" placeholder="Ketik untuk cari teknisi..." autocomplete="off" />
            <div id="techSuggest" class="suggest" style="display:none;"></div>
          </div>
          <div id="techGuide" class="muted">Klik pada hasil untuk menambahkan. Hapus dengan klik tanda &times; pada chip.</div>
        </div>
        <div id="reportWrap">
          <label>Report No</label>
          <input id="report_no" placeholder="Ketik Report No" />
        </div>
        <div id="nextPmWrap" style="display:none;">
          <label>Next PM</label>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <label><input type="radio" name="nextpm" value="1" /> +1 bulan</label>
            <label><input type="radio" name="nextpm" value="2" /> +2 bulan</label>
            <label><input type="radio" name="nextpm" value="3" /> +3 bulan</label>
          </div>
          <div class="date-input-wrap"><input id="next_pm_date" type="date" placeholder="Atau pilih custom" /></div>
          <div class="muted">Pilih radio untuk autofill, atau isi langsung date untuk custom</div>
        </div>
      </div>
      <div id="descWrap">
        <label>Pekerjaan</label>
        <div class="rte-toolbar">
          <button type="button" data-target="description" data-cmd="bold"><b>B</b></button>
          <button type="button" data-target="description" data-cmd="italic"><i>I</i></button>
          <button type="button" data-target="description" data-cmd="underline"><u>U</u></button>
          <button type="button" data-target="description" data-cmd="insertUnorderedList">&bull; List</button>
          <button type="button" data-target="description" data-cmd="insertOrderedList">1. List</button>
        </div>
        <div id="description" class="rte" contenteditable="true"></div>
      </div>
      <div id="recWrap">
        <label>Recommendation</label>
        <div class="rte-toolbar">
          <button type="button" data-target="recommendation" data-cmd="bold"><b>B</b></button>
          <button type="button" data-target="recommendation" data-cmd="italic"><i>I</i></button>
          <button type="button" data-target="recommendation" data-cmd="underline"><u>U</u></button>
          <button type="button" data-target="recommendation" data-cmd="insertUnorderedList">&bull; List</button>
          <button type="button" data-target="recommendation" data-cmd="insertOrderedList">1. List</button>
        </div>
        <div id="recommendation" class="rte" contenteditable="true"></div>
      </div>
      <div id="itemsUsedWrap">
        <label>Item dipakai (pilih dari katalog)</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <div class="input-suggest-wrap" style="position:relative; flex:1;">
            <input id="itemSearch" placeholder="Cari item..." autocomplete="off" />
            <div id="itemSuggest" class="suggest" style="display:none;"></div>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <label for="itemQty" style="font-size:12px; color:#555;">Qty</label>
            <input id="itemQty" type="number" min="1" value="1" />
          </div>
        </div>
        <div id="itemAddPrompt" role="button" tabindex="0" style="display:none; margin-top:6px; padding:6px 8px; border-radius:4px; cursor:pointer; font-weight:600; font-size:12px; color:#fff; background:#1e90ff;">Item tidak ditemukan, tambahkan item baru?</div>
        <div id="itemList" style="display:none;"></div>
        <div id="chosenItems" style="margin-top:6px;"></div>
      </div>
      <div id="itemsFreeWrap" style="display:none;">
        <label id="itemsFreeLabel">Item dipakai (free text)</label>
        <div class="rte-toolbar">
          <button type="button" data-target="items_free" data-cmd="bold"><b>B</b></button>
          <button type="button" data-target="items_free" data-cmd="italic"><i>I</i></button>
          <button type="button" data-target="items_free" data-cmd="underline"><u>U</u></button>
          <button type="button" data-target="items_free" data-cmd="insertUnorderedList">&bull; List</button>
          <button type="button" data-target="items_free" data-cmd="insertOrderedList">1. List</button>
        </div>
        <div id="items_free" class="rte" contenteditable="true"></div>
      </div>
      <div id="saveWrap" style="text-align:right; margin-top:10px;">
        <button id="saveBtn">Simpan Job</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', ()=>{ (async function(){
    const user = await ensureAuthedAndRenderNav(); if (!user) return;
    const backBtn = document.getElementById('backToRecords'); if (backBtn) backBtn.onclick = ()=>{ location.href = '/records.html'; };
    const forklifts = await api('/api/forklifts');
    const items = await api('/api/items');
    // Indexing untuk pencarian cepat (_q) tanpa mengubah perilaku
    function indexFk(rows){
      try {
        (rows||[]).forEach(r=>{
          const vals=[r.location,r.owner,r.eq_no,r.serial,r.brand,r.type,r.powertrain];
          r._q = vals.map(v=> String(v||'').toLowerCase()).join(' | ');
        });
      } catch {}
      return rows;
    }
    function indexItems(rows){
      try { (rows||[]).forEach(r=>{ const vals=[r.code,r.nama,r.status]; r._q = vals.map(v=> String(v||'').toLowerCase()).join(' | '); }); } catch {}
      return rows;
    }
    indexFk(forklifts); indexItems(items);
    // Hasil pencarian teknisi via AJAX
    let lastTechResults = [];
    let techReqSeq = 0;

    // Forklift input + suggest (searchable, single-select)
    const fkCache = Array.isArray(forklifts) ? forklifts : [];
    const fkInput = document.getElementById('fk_input');
    const fkSuggest = document.getElementById('fkSuggest');
    const fkClear = document.getElementById('fk_clear');
    // Hint performa untuk dropdown suggest agar render ringan
    ;[fkSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    let jobForkliftId = null;
    if (fkClear) {
      fkClear.addEventListener('click', ()=>{
        jobForkliftId = null;
        if (fkInput) fkInput.value = '';
        if (fkSuggest){ fkSuggest.innerHTML=''; fkSuggest.style.display='none'; }
      });
    }
    function fkLabel(f){ return [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - '); }
    // Pencarian forklift yang lebih intuitif: token-based dan mengabaikan spasi/tanda hubung
    function normalizeNoSpace(str){ return String(str||'').toLowerCase().replace(/[\s-]+/g, ''); }
    function makeTokens(q){
      const base = String(q||'').trim().toLowerCase();
      const bySpace = base.split(/\s+/).filter(Boolean);
      const byGroup = (base.match(/[a-z]+|\d+/g) || []);
      // gabungkan dan unikkan
      const set = new Set([...bySpace, ...byGroup]);
      return Array.from(set);
    }
    function matchesForklift(f, q){
      const tokens = makeTokens(q);
      if (!tokens.length) return true;
      const fields = [f.location, f.owner, f.eq_no, f.serial, f.brand, f.type, f.powertrain];
      const normFields = fields.map(normalizeNoSpace);
      const joined = normalizeNoSpace(fields.map(v=> String(v||'')).join(' | '));
      const qNoSpace = normalizeNoSpace(q);
      // Cocokkan: seluruh query tanpa spasi ada di gabungan, ATAU semua token ada di salah satu field
      if (qNoSpace && joined.includes(qNoSpace)) return true;
      return tokens.every(tok => {
        const nt = normalizeNoSpace(tok);
        return normFields.some(nf => nf.includes(nt));
      });
    }
    function filterFk(q){
      const s = String(q||'');
      if (!s.trim()) return fkCache;
      try { return fkCache.filter(f=> matchesForklift(f, s)); }
      catch { return fkCache.filter(f=> matchesForklift(f, s)); }
    }
    function renderFkSuggest(){
      if (!fkInput || !fkSuggest) return;
      const list = filterFk(fkInput.value);
      if (!Array.isArray(list) || list.length===0){ fkSuggest.style.display='none'; fkSuggest.innerHTML=''; return; }
      fkSuggest.innerHTML = list.map(f=>`<div class="item" data-id="${f.id}">${fkLabel(f)}</div>`).join('');
      fkSuggest.style.display='block';
      // drag guard: cegah tap saat pengguna sedang scroll di dalam suggest
      if (!fkSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        fkSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        fkSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        fkSuggest._isDragging = ()=>dragging;
        fkSuggest._dragGuardAttached = true;
      }
      fkSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = (ev)=>{
          if (fkSuggest._isDragging && fkSuggest._isDragging()) { ev.preventDefault(); return; }
          const id = +it.getAttribute('data-id');
          const f = fkCache.find(x=>x.id===id); if (!f) return;
          jobForkliftId = f.id;
          fkInput.value = fkLabel(f);
          fkSuggest.style.display='none';
          reportDirty = false; try { if (typeof autofillReport === 'function') { autofillReport(); } } catch(e) {}
          try { if (typeof saveDraft === 'function') saveDraft(); } catch {}
        };
      });
    }
    if (fkInput){
      const debouncedFk = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),200); }; })(renderFkSuggest);
      fkInput.addEventListener('input', ()=>{ jobForkliftId = null; try{ if (typeof saveDraft==='function') saveDraft(); }catch{} });
      fkInput.addEventListener('input', debouncedFk);
      fkInput.addEventListener('focus', ()=> renderFkSuggest());
      fkInput.addEventListener('click', ()=> renderFkSuggest());
      fkInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const first = fkSuggest && fkSuggest.querySelector('.item');
          if (first){ first.click(); e.preventDefault(); }
        }
        if (e.key==='Escape'){ if (fkSuggest) fkSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (fkSuggest && !fkSuggest.contains(e.target) && e.target!==fkInput){ fkSuggest.style.display='none'; } });
      // Hapus default auto-select: wajib pilih forklift secara eksplisit
      // if (fkCache[0]){ jobForkliftId = fkCache[0].id; fkInput.value = fkLabel(fkCache[0]); }
    }
    // Teknisi tag-style selector
    const techInput = document.getElementById('teknisi_input');
    const techTags = document.getElementById('teknisi_tags');
    const techSuggest = document.getElementById('techSuggest');
    ;[techSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    let selectedTech = [];
    // helper debounce
    const makeDebounce = (fn, delay=250)=>{ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; };

    function renderTechTags(){
      techTags.innerHTML = selectedTech.map(t=>`<span class="chip" data-id="${t.id}">${t.label} <button class="x" title="Hapus" data-rem="${t.id}">&times;</button></span>`).join('');
      techTags.querySelectorAll('button[data-rem]').forEach(b=>{
        b.onclick = ()=>{ const id = +b.getAttribute('data-rem'); selectedTech = selectedTech.filter(x=>x.id!==id); renderTechTags(); };
      });
      const guide = document.getElementById('techGuide');
      if (guide) guide.style.display = (Array.isArray(selectedTech) && selectedTech.length>0) ? 'none' : '';
    }

    // fetch & render suggest teknisi via AJAX (show list even when query is empty)
    const fetchAndRenderTech = async ()=>{
      const q = (techInput.value||'').trim();
      const seq = ++techReqSeq;
      let list = [];
      try {
        const url = q ? ('/api/technicians?q='+encodeURIComponent(q)) : '/api/technicians';
        list = await api(url);
      } catch(e) { list = []; }
      if (seq !== techReqSeq) return; // abaikan respon lama
      lastTechResults = list;
      if (!Array.isArray(list) || list.length===0){ techSuggest.style.display='none'; techSuggest.innerHTML=''; return; }
      techSuggest.innerHTML = list.map(t=>{
        const label = (t.name && t.name.trim()) ? `${t.name} <${t.email}>` : t.email;
        return `<div class="item" data-id="${t.id}">${label}</div>`;
      }).join('');
      techSuggest.style.display='block';
      if (!techSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        techSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        techSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        techSuggest._isDragging = ()=>dragging;
        techSuggest._dragGuardAttached = true;
      }
      techSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = ()=>{
          if (techSuggest._isDragging && techSuggest._isDragging()) return;
          const id = +it.getAttribute('data-id');
          const t = lastTechResults.find(x=>x.id===id);
          if (!t) return;
          if (!selectedTech.some(x=>x.id===t.id)){
            const label = (t.name && t.name.trim()) ? `${t.name} <${t.email}>` : t.email;
            const value = (t.name && t.name.trim()) ? t.name : t.email;
            selectedTech.push({ id:t.id, label, value });
            renderTechTags();
          }
          techInput.value = '';
          techSuggest.style.display='none';
        };
      });
    };

    // input handlers teknisi
    techInput.addEventListener('keydown', (e)=>{
      if (e.key==='Enter'){
        const first = techSuggest.querySelector('.item');
        if (first){ first.click(); e.preventDefault(); }
      }
    });

    const debouncedFetchTech = makeDebounce(fetchAndRenderTech, 250);
    techInput.addEventListener('input', debouncedFetchTech);
    techInput.addEventListener('focus', ()=>{ fetchAndRenderTech(); });
    techInput.addEventListener('click', ()=>{ fetchAndRenderTech(); });

    // klik di luar untuk menutup suggest
    document.addEventListener('click', (e)=>{
      if (!techSuggest.contains(e.target) && e.target!==techInput){ techSuggest.style.display='none'; }
    });

    // Simple sanitize to allow only safe tags
    function sanitizeHTML(html){
      const allowed = new Set(['B','I','U','BR','P','UL','OL','LI','STRONG','EM']);
      const div = document.createElement('div');
      div.innerHTML = html;
      const walker = document.createTreeWalker(div, NodeFilter.SHOW_ELEMENT, null);
      const toRemove = [];
      let node;
      while(node = walker.nextNode()){
        if (!allowed.has(node.tagName)) toRemove.push(node);
        else {
          // strip attributes
          while(node.attributes && node.attributes.length>0){ node.removeAttribute(node.attributes[0].name); }
        }
      }
      toRemove.forEach(n=> n.replaceWith(document.createTextNode(n.textContent || '')));
      return div.innerHTML
        .replace(/\u00A0/g, ' ') // nbsp to space
        .trim();
    }

    function getRteValue(id){
      const el = document.getElementById(id);
      return sanitizeHTML(el.innerHTML || '');
    }

    // RTE toolbar handlers + toggle state
    function getActiveRteId(){
      const sel = document.getSelection();
      if (!sel || !sel.anchorNode) return null;
      let n = sel.anchorNode.nodeType===1 ? sel.anchorNode : sel.anchorNode.parentElement;
      while(n && n !== document){
        if (n.getAttribute && n.getAttribute('contenteditable')==='true') return n.id;
        n = n.parentElement;
      }
      return null;
    }

    function updateToolbarState(){
      const activeId = getActiveRteId();
      const commands = ['bold','italic','underline','insertUnorderedList','insertOrderedList'];
      document.querySelectorAll('.rte-toolbar button').forEach(btn=>{
        const target = btn.dataset.target;
        const cmd = btn.dataset.cmd;
        if (target===activeId && commands.includes(cmd)){
          let on = false; try { on = document.queryCommandState(cmd); } catch (e) {}
          btn.classList.toggle('active', !!on);
        } else {
          btn.classList.remove('active');
        }
      });
    }

    document.querySelectorAll('.rte-toolbar button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = document.getElementById(btn.dataset.target);
        if (!target) return;
        target.focus();
        try { document.execCommand(btn.dataset.cmd, false, null); } catch (e) {}
        updateToolbarState();
      });
    });
    document.addEventListener('selectionchange', updateToolbarState);

    let chosen = [];
    let rowSeq = 1;

    // Item suggest (dropdown) mirip forklift/teknisi
    const itemInput = document.getElementById('itemSearch');
    const itemSuggest = document.getElementById('itemSuggest');
    const itemAddPrompt = document.getElementById('itemAddPrompt');
    ;[itemSuggest].forEach(el=>{ try{ if(el && !el.dataset.perfApplied){ el.style.contentVisibility = el.style.contentVisibility || 'auto'; el.style.containIntrinsicSize = el.style.containIntrinsicSize || '120px'; el.dataset.perfApplied='1'; } }catch{} });
    const itemQtyEl = document.getElementById('itemQty');

    function addNewItemFromPrompt(){
      try {
        const name = (itemInput && itemInput.value ? String(itemInput.value).trim() : '');
        if (!name) return;
        let qty = 1;
        if (itemQtyEl){ qty = parseInt(itemQtyEl.value||'1',10); if (!qty || qty<1) qty = 1; }
        chosen.push({ rowId: rowSeq++, id: null, code: '', nama: name, qty, isNew: true });
        (function(){
          try{
            const used = new Set();
            for (const r of (Array.isArray(items)?items:[])){
              const m = /^TMI-(\d+)$/i.exec(String(r.code||''));
              if (m){ const n = parseInt(m[1],10); if (!isNaN(n)) used.add(n); }
            }
            let i = 1; while (used.has(i)) i++;
            const code = `TMI-${i}`;
            const newRow = { id: null, code, nama: name, status: 'available' };
            items.push(newRow);
            try { (function(r){ const vals=[r.code,r.nama,r.status]; r._q = vals.map(v=> String(v||'').toLowerCase()).join(' | '); })(newRow); } catch {}
          } catch {}
        })();
        renderChosen();
        if (itemInput) itemInput.value = '';
        if (itemAddPrompt) itemAddPrompt.style.display='none';
      } catch {}
    }

    function filterItems(q){
      const s = String(q||'').toLowerCase();
      if (!s) return items;
      try { return items.filter(i=> String(i._q||'').includes(s)); }
      catch { return items.filter(i=> Object.values(i).some(v=> String(v||'').toLowerCase().includes(s)) ); }
    }

    function sortByItemCodeAsc(a, b){
      const ac0 = String(a?.code||'').trim();
      const bc0 = String(b?.code||'').trim();
      if (!ac0 && !bc0) return 0;
      if (!ac0) return 1;
      if (!bc0) return -1;
      const ac = ac0.toUpperCase();
      const bc = bc0.toUpperCase();
      const ma = ac.match(/^([A-Z]+)(\d+)/);
      const mb = bc.match(/^([A-Z]+)(\d+)/);
      if (ma && mb){
        if (ma[1] !== mb[1]) return ma[1].localeCompare(mb[1]);
        const na = parseInt(ma[2], 10);
        const nb = parseInt(mb[2], 10);
        if (isNaN(na) && isNaN(nb)) return ac.localeCompare(bc);
        if (isNaN(na)) return 1;
        if (isNaN(nb)) return -1;
        return na - nb;
      }
      return ac.localeCompare(bc);
    }

    function sortItemsTmiFirst(a, b){
      const ac = String(a?.code||'');
      const bc = String(b?.code||'');
      const ta = /^TMI-(\d+)$/i.exec(ac.trim());
      const tb = /^TMI-(\d+)$/i.exec(bc.trim());
      const aIs = !!ta; const bIs = !!tb;
      if (aIs && !bIs) return -1;
      if (!aIs && bIs) return 1;
      if (aIs && bIs){
        const na = parseInt(ta[1], 10); const nb = parseInt(tb[1], 10);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        return ac.localeCompare(bc);
      }
      return sortByItemCodeAsc(a, b);
    }

    function renderItemSuggest(){
      if (!itemInput || !itemSuggest) return;
      const list = (filterItems(itemInput.value)||[]).slice().sort(sortItemsTmiFirst);
      const q = (itemInput.value||'').trim();
      if (!Array.isArray(list) || list.length===0){
        // Sembunyikan dropdown dan tampilkan prompt klik di bawah input
        itemSuggest.style.display='none';
        itemSuggest.innerHTML='';
        if (itemAddPrompt){
          if (q.length>0){
            itemAddPrompt.style.display='block';
            itemAddPrompt.textContent = 'Item tidak ditemukan, tambahkan item baru?';
            // Handler dipasang permanen di inisialisasi; di sini hanya mengatur visibilitas.
          } else {
            itemAddPrompt.style.display='none';
          }
        }
        return;
      }
      if (itemAddPrompt) itemAddPrompt.style.display='none';
      itemSuggest.innerHTML = list.map(i=>{
        const unavailable = String(i.status||'').toLowerCase()==='unavailable';
        const rowStyle = unavailable ? 'opacity:0.5;' : '';
        const statusBadge = unavailable ? " <span class='muted'>(unavailable)</span>" : '';
        // Sembunyikan kode item di dropdown untuk Jobs
        return `<div class="item" data-id="${i.id}" data-unavail="${unavailable?1:0}" style="${rowStyle}">${i.nama}${statusBadge}</div>`;
      }).join('');
      itemSuggest.style.display='block';
      // drag guard untuk mobile
      if (!itemSuggest._dragGuardAttached){
        let startY = 0, dragging = false;
        itemSuggest.addEventListener('pointerdown', (e)=>{ startY = e.clientY||0; dragging = false; }, {passive:true});
        itemSuggest.addEventListener('pointermove', (e)=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging = true; }, {passive:true});
        itemSuggest._isDragging = ()=>dragging;
        itemSuggest._dragGuardAttached = true;
      }
      itemSuggest.querySelectorAll('.item').forEach(it=>{
        it.onclick = (ev)=>{
          if (itemSuggest._isDragging && itemSuggest._isDragging()) { ev.preventDefault(); return; }
          const unavail = it.getAttribute('data-unavail')==='1';
          if (unavail) return; // skip unavailable
          const id = +it.getAttribute('data-id');
          const f = items.find(x=>x.id===id); if (!f) return;
          let qty = 1; if (itemQtyEl){ qty = parseInt(itemQtyEl.value||'1',10); if (!qty || qty<1) qty = 1; }
          const exist = chosen.find(c=>c.id===id);
          if (exist) { exist.qty += qty; } else { chosen.push({ rowId: rowSeq++, id, code: f.code, nama: f.nama, qty }); }
          renderChosen();
          itemInput.value = '';
          if (itemQtyEl) { /* keep user input or reset? choose to keep as-is */ }
          itemSuggest.style.display='none';
        };
      });
    }

    if (itemInput){
      const debouncedItems = ((fn)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), 200); }; })(renderItemSuggest);
      itemInput.addEventListener('input', debouncedItems);
      itemInput.addEventListener('focus', ()=> renderItemSuggest());
      itemInput.addEventListener('click', ()=> renderItemSuggest());
      itemInput.addEventListener('keydown', (e)=>{
        if (e.key==='Enter'){
          const name = String(itemInput && itemInput.value || '').trim();
          if (!name){ e.preventDefault(); return; }
          const exact = (Array.isArray(items)?items:[]).find(x=> String(x.nama||'').trim().toLowerCase() === name.toLowerCase());
          if (exact && String(exact.status||'').toLowerCase() !== 'unavailable'){
            let qty = 1; if (itemQtyEl){ qty = parseInt(itemQtyEl.value||'1',10); if (!qty || qty<1) qty = 1; }
            const exist = chosen.find(c=>c.id===exact.id);
            if (exist) { exist.qty += qty; } else { chosen.push({ rowId: rowSeq++, id: exact.id, code: exact.code, nama: exact.nama, qty }); }
            renderChosen(); itemInput.value=''; if (itemSuggest) itemSuggest.style.display='none'; e.preventDefault(); return;
          }
          addNewItemFromPrompt(); e.preventDefault(); return;
        }
        if (e.key==='Escape'){ if (itemSuggest) itemSuggest.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{ if (itemSuggest && !itemSuggest.contains(e.target) && e.target!==itemInput){ itemSuggest.style.display='none'; } });
      // Pasang handler untuk prompt biru sekali saja
      if (itemAddPrompt && !itemAddPrompt.dataset.hook){
        itemAddPrompt.addEventListener('click', ()=> addNewItemFromPrompt(), { passive: true });
        itemAddPrompt.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); addNewItemFromPrompt(); } }, { passive: false });
        itemAddPrompt.addEventListener('pointerdown', (e)=>{ if (e.pointerType==='touch'){ e.preventDefault(); addNewItemFromPrompt(); } }, { passive: false });
        itemAddPrompt.dataset.hook='1';
      }
    }

    function renderChosen(){
      const html = chosen.map(c=>`<div class='chosen-row'>
        <div class='label'>${c.nama}</div>
        <input class='qty' type='number' min='1' value='${c.qty}' data-row='${c.rowId}' />
        <button class='xbtn' aria-label='Hapus item' title='Hapus' data-row='${c.rowId}'>&times;</button>
      </div>`).join('');
      document.getElementById('chosenItems').innerHTML = html;
      // handlers qty
      document.querySelectorAll("input[data-row]").forEach(inp=>{
        inp.onchange = (e)=>{
          const rid = parseInt(inp.getAttribute('data-row'),10);
          let v = parseInt(inp.value||'1', 10); if (!v || v<1) v = 1; inp.value = String(v);
          const row = chosen.find(x=>x.rowId===rid); if (row) row.qty = v;
          try{ if (typeof saveDraft==='function') saveDraft(); }catch{}
        };
      });
      // handlers remove (tap-friendly)
      document.querySelectorAll('button[data-row]').forEach(b=>{
        const removeFn = ()=>{ const rid = parseInt(b.getAttribute('data-row'),10); chosen = chosen.filter(c=>c.rowId!==rid); renderChosen(); };
        b.addEventListener('click', removeFn, { passive: true });
        b.addEventListener('pointerdown', (e)=>{ if (e.pointerType === 'touch') { e.preventDefault(); removeFn(); } }, { passive: false });
      });
    }

    // Hapus implementasi list lama
    // document.getElementById('itemSearch').oninput = ()=> renderItems(items);
    // renderItems(items);

    // Jenis pekerjaan: gunakan radio, wajib dipilih sebelum mengisi form
    function getJenis(){ const r = document.querySelector('input[name="jenis"]:checked'); return r ? r.value : ''; }
    const jenisRadios = Array.from(document.querySelectorAll('input[name="jenis"]'));
    function setFormEnabled(enabled){
      const toggle = (id)=>{ const el=document.getElementById(id); if(!el) return; el.disabled = !enabled; el.readOnly = !enabled; };
      ['tanggal','fk_input','teknisi_input','report_no','itemSearch','itemQty','next_pm_date'].forEach(toggle);
      const save=document.getElementById('saveBtn'); if (save) save.disabled = !enabled;
      ['description','recommendation','items_free'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.setAttribute('contenteditable', enabled?'true':'false'); } });
      const blockedWraps = ['tglWrap','fkWrap','techWrap','reportWrap','descWrap','recWrap','itemsUsedWrap','itemsFreeWrap','nextPmWrap','saveWrap'];
      blockedWraps.forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(enabled){ el.classList.remove('form-blocked'); } else { el.classList.add('form-blocked'); } });
    }
    // Next PM radio autofill handlers
    const tanggalEl = document.getElementById('tanggal');
    const nextPmDateEl = document.getElementById('next_pm_date');
    const nextPmRadios = Array.from(document.querySelectorAll('input[name=nextpm]'));
    function toISODate(d){ const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
    function addMonthsDate(baseDate, months){ const d=new Date(baseDate.getTime()); const day=d.getDate(); d.setMonth(d.getMonth()+months); if (d.getDate()<day){ d.setDate(0); } return d; }
    function recalcNextPM(){ const sel=document.querySelector('input[name=nextpm]:checked'); if(!sel) return; const months=parseInt(sel.value||'0',10); if(!months) return; const base=tanggalEl.value? new Date(tanggalEl.value): new Date(); const nd=addMonthsDate(base, months); nextPmDateEl.value=toISODate(nd); }
    nextPmRadios.forEach(r=> r.addEventListener('change', recalcNextPM));
    tanggalEl.addEventListener('change', recalcNextPM);

    function updateJenis(){
    const j = getJenis();
    // Tampilkan pemilihan item katalog untuk semua jenis pekerjaan (Workshop/PM/Lapangan)
    document.getElementById('itemsUsedWrap').style.display = (j==='Workshop'||j==='PM'||j==='Lapangan') ? 'block':'none';
    // Nonaktifkan input free text untuk PM/Lapangan (gunakan katalog)
    document.getElementById('itemsFreeWrap').style.display = 'none';
    document.getElementById('nextPmWrap').style.display = (j==='PM') ? 'block':'none';
    document.getElementById('report_no').disabled = false;
    if (j==='Workshop' && !reportDirty) { autofillReport(); }
    // Autofill pekerjaan ketika PM dipilih
    const descEl = document.getElementById('description');
    const current = getRteValue('description');
    const pmDefault = 'Preventative Maintenance';
    if (j==='PM'){
    if (!current || current === pmDefault){ descEl.textContent = pmDefault; }
    } else {
    if (current === pmDefault){ descEl.textContent = ''; }
    }
    }
    const reportInput = document.getElementById('report_no');
    let reportDirty = false; // user has typed manually
    reportInput.addEventListener('input', ()=>{ reportDirty = true; });
    
    async function autofillReport(){
    const j = getJenis();
    const fid = parseInt(jobForkliftId||0);
    if (j==='Workshop' && fid){
    try {
    const data = await api('/api/jobs/next-report?forklift_id='+fid);
    // Only autofill if user hasn't typed or the field is empty
    if (!reportDirty || !reportInput.value){
    reportInput.value = data.report_no || '';
    }
    } catch (e) { /* ignore */ }
    }
    }
    
    // ---- Intro Mode (hanya Jenis Pekerjaan tampil besar) ----
    function showFormSections(show){
      const ids=['tglWrap','fkWrap','techWrap','reportWrap','descWrap','recWrap','itemsUsedWrap','itemsFreeWrap','nextPmWrap','saveWrap'];
      ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.style.display = show? '': 'none'; } });
    }
    function enterIntroMode(){
      document.body.classList.add('intro-mode');
      showFormSections(false);
      setFormEnabled(false);
      const guide = document.getElementById('jenisGuide'); if (guide) guide.style.display='';
    }
    function exitIntroMode(){
      document.body.classList.remove('intro-mode');
      showFormSections(true);
      setFormEnabled(true);
      const guide = document.getElementById('jenisGuide'); if (guide) guide.style.display='none';
    }
    enterIntroMode();
    jenisRadios.forEach(r=> r.addEventListener('change', ()=>{ exitIntroMode(); updateJenis(); recalcNextPM(); }));
    
    // Autofill when forklift changes for Workshop (if not manually edited)
    // removed: fSel.onchange handler, replaced by suggest selection handler

    function resetJobForm(){
      try {
        // Forklift
        if (typeof jobForkliftId !== 'undefined') jobForkliftId = null;
        const fkInputEl = document.getElementById('fk_input');
        if (fkInputEl) fkInputEl.value = '';
        if (fkSuggest){ fkSuggest.innerHTML=''; fkSuggest.style.display='none'; }

        // Tanggal
        const tglEl = document.getElementById('tanggal');
        if (tglEl) tglEl.value = '';

        // Teknisi
        if (Array.isArray(selectedTech)) selectedTech.length = 0;
        if (typeof renderTechTags === 'function') renderTechTags();
        if (techInput) techInput.value = '';
        if (techSuggest){ techSuggest.innerHTML=''; techSuggest.style.display='none'; }

        // Report No
        const rptEl = document.getElementById('report_no');
        if (rptEl) rptEl.value = '';
        if (typeof reportDirty !== 'undefined') reportDirty = false;

        // Deskripsi & Rekomendasi (RTE)
        const descEl = document.getElementById('description');
        if (descEl) descEl.textContent = '';
        const recEl = document.getElementById('recommendation');
        if (recEl) recEl.textContent = '';

        // Items free text (Lapangan)
        const itemsFreeEl = document.getElementById('items_free');
        if (itemsFreeEl) itemsFreeEl.textContent = '';

        // Items chosen (Workshop/PM)
        if (Array.isArray(chosen)) chosen.length = 0;
        if (typeof renderChosen === 'function') renderChosen();
        if (itemInput) itemInput.value = '';
        if (itemQtyEl) itemQtyEl.value = '1';
        if (itemSuggest){ itemSuggest.innerHTML=''; itemSuggest.style.display='none'; }

        // Next PM
        const nextDateEl = document.getElementById('next_pm_date');
        if (nextDateEl) nextDateEl.value = '';
        document.querySelectorAll('input[name="nextpm"]').forEach(r=> r.checked = false);

        // Fokus kembali ke forklift untuk input cepat berikutnya
        if (fkInputEl) fkInputEl.focus();
      // Jika jenis adalah PM, kembalikan default teks deskripsi PM
      if (typeof updateJenis === 'function') updateJenis();
      } catch (e) { /* ignore */ }
    }

      document.getElementById('saveBtn').onclick = async ()=>{
        const jenis = getJenis();
        if (!jenis){ alert('Silakan pilih Jenis Pekerjaan terlebih dahulu.'); return; }
        const tanggal = document.getElementById('tanggal').value;
        if (!tanggal){ alert('Tanggal wajib diisi.'); document.getElementById('tanggal').focus(); return; }
        if (!jobForkliftId){ alert('Forklift wajib dipilih dari daftar.'); document.getElementById('fk_input').focus(); return; }
        const forklift_id = parseInt(jobForkliftId||0);
        const teknisi = selectedTech.map(o=>o.value).join(', ');
        let report_no = String(document.getElementById('report_no').value||'').trim();
        if (!report_no && jenis==='Workshop'){ try { await autofillReport(); report_no = String(document.getElementById('report_no').value||'').trim(); } catch {} }
        if (!report_no){ alert('Report No wajib diisi'); document.getElementById('report_no').focus(); return; }
        const description = getRteValue('description');
        const recommendation = getRteValue('recommendation');
      let items_used = '';
      let next_pm = null;
      if (jenis==='Workshop') {
        items_used = chosen.map(c=>`${c.code ? (c.code+" ") : ''}${c.nama} x ${c.qty}`).join(', ');
      } else if (jenis==='PM') {
        // PM juga menggunakan katalog item (bukan free text)
        items_used = chosen.map(c=>`${c.code ? (c.code+" ") : ''}${c.nama} x ${c.qty}`).join(', ');
        // Radio atau custom date untuk PM
        const radioSel = document.querySelector('input[name="nextpm"]:checked');
        const customDate = document.getElementById('next_pm_date').value;
        if (customDate){
          next_pm = customDate;
        } else if (radioSel){
          const months = parseInt(radioSel.value, 10);
          const base = new Date(tanggal);
          base.setHours(0,0,0,0);
          const d = new Date(base);
          d.setMonth(d.getMonth() + months);
          next_pm = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
        }
      } else if (jenis==='Lapangan') {
        // Lapangan juga menggunakan katalog item (bukan free text)
        items_used = chosen.map(c=>`${c.code ? (c.code+" ") : ''}${c.nama} x ${c.qty}`).join(', ');
      }

      const chosen_items = chosen.map(c=>({ id: c.id || null, nama: c.nama || '', qty: c.qty || 1, isNew: !!c.isNew }));
      const payload = { jenis, tanggal, forklift_id, teknisi, report_no, description, recommendation, items_used, next_pm, chosen_items };
      try {
        const r = await api('/api/jobs', { method:'POST', body: payload });
        alert('Tersimpan. Report No: '+r.report_no);
        resetJobForm();
      } catch (e) {
        alert(e.error || 'Gagal simpan');
      }
    };

    // ---- Draft Persistensi (localStorage) ----
    const DRAFT_KEY = 'jobs_form_draft';
    function saveDraft(){
      try {
        const nextpmSel = document.querySelector('input[name="nextpm"]:checked');
        const draft = {
          tanggal: document.getElementById('tanggal')?.value || '',
          forklift_id: (typeof jobForkliftId !== 'undefined' && jobForkliftId) ? jobForkliftId : null,
          forklift_label: (function(){
            try{ if(jobForkliftId){ const f=fkCache.find(x=>x.id===jobForkliftId); return f? fkLabel(f): (document.getElementById('fk_input')?.value||''); }
            }catch{}
            return document.getElementById('fk_input')?.value||'';
          })(),
          teknisi: Array.isArray(selectedTech) ? selectedTech.map(t=>({id:t.id,label:t.label,value:t.value})) : [],
          report_no: document.getElementById('report_no')?.value || '',
          description: getRteValue('description'),
          recommendation: getRteValue('recommendation'),
          items_free: getRteValue('items_free'),
          chosen: Array.isArray(chosen) ? chosen.map(c=>({rowId:c.rowId, id:c.id, code:c.code, nama:c.nama, qty:c.qty, isNew: !!c.isNew})) : [],
          next_pm_date: document.getElementById('next_pm_date')?.value || '',
          nextpm: nextpmSel ? nextpmSel.value : ''
        };
        localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      } catch (e) { /* ignore */ }
    }
    function loadDraft(){
      try {
        const raw = localStorage.getItem(DRAFT_KEY); if (!raw) return;
        const d = JSON.parse(raw||'{}');
        const t = document.getElementById('tanggal'); if (t && d.tanggal) t.value = d.tanggal;
        if (d.forklift_id){
          jobForkliftId = d.forklift_id;
          try{ const f=fkCache.find(x=>x.id===jobForkliftId); if (f && fkInput) fkInput.value = fkLabel(f); else if (fkInput && d.forklift_label) fkInput.value = d.forklift_label; }catch{}
        } else if (fkInput && d.forklift_label){ fkInput.value = d.forklift_label; }
        if (Array.isArray(d.teknisi)){ selectedTech = d.teknisi; renderTechTags(); }
        if (reportInput && d.report_no){ reportInput.value = d.report_no; reportDirty = true; }
        const descEl = document.getElementById('description'); if (descEl && d.description) descEl.innerHTML = d.description;
        const recEl = document.getElementById('recommendation'); if (recEl && d.recommendation) recEl.innerHTML = d.recommendation;
        const itemsFreeEl = document.getElementById('items_free'); if (itemsFreeEl && d.items_free) itemsFreeEl.innerHTML = d.items_free;
        if (Array.isArray(d.chosen)){
          chosen = d.chosen.map(c=>({ rowId: c.rowId||null, id: c.id||null, code: c.code||'', nama: c.nama||'', qty: c.qty||1, isNew: !!c.isNew }));
          // Atur sequence agar unik setelah load draft
          try{ const maxRow = Math.max(0, ...chosen.map(x=> (typeof x.rowId==='number' ? x.rowId : 0))); rowSeq = (isFinite(maxRow) ? maxRow : 0) + 1; }catch{ rowSeq = 1; }
          renderChosen();
        }
        const nd = document.getElementById('next_pm_date'); if (nd && d.next_pm_date) nd.value = d.next_pm_date;
        if (d.nextpm){ const r = document.querySelector(`input[name="nextpm"][value="${d.nextpm}"]`); if (r) r.checked = true; }
      } catch (e) { /* ignore */ }
    }
    // panggil setelah data siap (forklifts/items dimuat)
    loadDraft();
    // auto-save hooks
    ['tanggal','report_no','next_pm_date'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', saveDraft); }});
    const saveRte = (id)=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', saveDraft); el.addEventListener('keyup', saveDraft); }};
    ['description','recommendation','items_free'].forEach(saveRte);
    // forklift select/clear
    if (fkClear) fkClear.addEventListener('click', saveDraft);
    if (fkSuggest){ fkSuggest.addEventListener('click', saveDraft); }
    // teknisi chips save setelah render/hapus
    const origRenderTags = renderTechTags;
    renderTechTags = function(){ origRenderTags(); saveDraft(); };
    document.addEventListener('click', (e)=>{ if (e.target && e.target.matches('#teknisi_tags .x')) { setTimeout(saveDraft, 0); } });
    // items chosen: save setelah renderChosen/qty berubah
    const origRenderChosen = renderChosen;
    renderChosen = function(){ origRenderChosen(); saveDraft(); };
    document.querySelectorAll('input[name="nextpm"]').forEach(r=> r.addEventListener('change', ()=>{ recalcNextPM(); saveDraft(); }));
    tanggalEl.addEventListener('change', ()=>{ recalcNextPM(); saveDraft(); });
    window.addEventListener('beforeunload', saveDraft);
  })(); });
   </script>
</body>
</html>