<!doctype html>
<html lang="id" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arsip Jobs</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; }
      .container { padding: 16px; }
      .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end; margin-bottom:12px; }
      .toolbar label { display:flex; flex-direction:column; font-size:12px; gap:4px; }
      .toolbar input, .toolbar select { padding:6px 8px; }
      .table-scroll { overflow:auto; border:1px solid #ddd; border-radius:8px; }
      /* Border tabel ala records (terlihat jelas di light mode) */
      #table table { width:100%; border-collapse:collapse; }
      #table table th, #table table td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
      #table table th { background:#fafafa; }
      [data-theme="dark"] #table table th, [data-theme="dark"] #table table td { border-bottom:1px solid #1f2937; }
      [data-theme="dark"] #table table th { background:#0f172a; }
      .pagination { display:flex; gap:8px; align-items:center; }
      .pagination button { padding:6px 10px; }
      /* Ikon kalender kustom seperti di records */
      input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; filter: none !important; }
      .date-input-wrap { position: relative; display: inline-block; color:#111; }
      [data-theme="dark"] .date-input-wrap { color:#fff; }
      .date-input-wrap input[type="date"] { padding-right: 26px; }
      .date-input-wrap::after { content: ""; position:absolute; right:4px; top:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none; background-color: currentColor; -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; }
      /* Dropdown suggest (selaras dengan records) */
      .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:140px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
      .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
      .suggest .item:hover { background:#f6f9ff; }
      [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
      [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
      [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
      /* Subteks pada kolom Forklift */
      .subtext { color:#666; font-size:12px; }
      [data-theme="dark"] .subtext { color:#fff; }
    </style>
    <script src="/common.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div class="container">
      <h2>Arsip Jobs</h2>
      <div class="toolbar" id="filters">
        <label>
          Kata kunci
          <input type="text" id="q" placeholder="Cari job_no, forklift, deskripsi" />
        </label>
        <!-- Forklift filter: input teks + dropdown suggest (single select), menyamakan mekanisme dengan records -->
        <div class="filter-group" style="position:relative; min-width:260px; max-width:460px;">
          <div class="label-row"><label>Forklift</label></div>
          <input id="arch_forklift_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
          <div id="archFkSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
          <input type="hidden" id="forklift_id" value="" />
        </div>

        <label>
          Tanggal mulai
          <div class="date-input-wrap"><input type="date" id="start" /></div>
        </label>
        <label>
          Tanggal akhir
          <div class="date-input-wrap"><input type="date" id="end" /></div>
        </label>
        <label>
          Jenis Job
          <select id="jenis">
            <option value="Workshop">Workshop</option>
            <option value="PM">PM/Lapangan Jobs (PM)</option>
          </select>
          </label>
        <label>
          Rows
          <select id="rowsPerPage">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">All</option>
          </select>
        </label>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button id="resetBtn">Reset</button>
          <button id="exportBtn" title="Export hasil saat ini ke CSV">Export CSV</button>
          <button id="exportExcel" title="Export hasil ke Excel">Export Excel</button>
          <button id="exportPDF" title="Export hasil ke PDF">Export PDF</button>
        </div>
      </div>
      <div id="summary" style="margin-bottom:8px; color:#555;"></div>
      <div id="table"></div>
      <!-- Modal detail (view-only) -->
      <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.3); align-items:center; justify-content:center;">
        <div class="dialog" style="background:#fff; padding:16px; border-radius:8px; width:720px; max-width:95vw; max-height:85vh; display:flex; flex-direction:column; box-shadow:0 10px 24px rgba(0,0,0,0.18);">
          <h3 id="modalTitle" style="margin-top:0;">Detail Arsip</h3>
          <div id="modalBody" style="overflow:auto;"></div>
          <div style="text-align:right; margin-top:10px;">
            <button id="closeBtn">Tutup</button>
          </div>
        </div>
      </div>
      <div id="detail" style="margin-top:16px; display:none;"></div>
      <div class="pagination" style="margin-top:12px;">
        <button id="prevBtn">Prev</button>
        <span id="pageInfo"></span>
        <button id="nextBtn">Next</button>
      </div>
    </div>

    <script>
      let limit = 25;
      let offset = 0;
      let total = 0;
      let lastRows = [];
      let selected = new Set();
      let orderDir = 'desc';

      function columnsForJenis(j){
        const selCol = { key:'__sel', label:'Sel', render:(row)=>{
          const idStr = String(row.id);
          const checked = selected.has(idStr) ? 'checked' : '';
          return `<input type="checkbox" data-id="${idStr}" ${checked} />`;
        }};
        const base = [
          { key:'id', label:'ID' },
          { key:'job_no', label:'Report No' },
          { key:'jenis', label:'Jenis' },
          { key:'job_date', label:'Tanggal' },
          { key:'forklift', label:'Forklift', render:(row)=>{
            const main = String(row.forklift||'');
            const owner = String(row.forklift_owner||'').trim();
            const location = String(row.forklift_location||'').trim();
            const serial = String(row.forklift_serial||'').trim();
            const powertrain = String(row.forklift_powertrain||'').trim();
            const details = [owner, location].filter(Boolean).join(' / ');
            const extra = [serial, powertrain].filter(Boolean).join(' · ');
            const sub = [details, extra].filter(Boolean).join(' — ');
            return sub ? `<div>${main}<div class='subtext'>${sub}</div></div>` : main;
          } },
        ];
        const v = String(j||'').toLowerCase();
        if (v === 'pm'){
          const actionCol = { key:'__act', label:'Aksi', render: (row)=>{
            return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
              <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
                <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
                <circle cx='12' cy='12' r='3'></circle>
              </svg>
              View
            </button>`;
          }};
          return [selCol, ...base, { key:'next_pm', label:'Next PM' }, { key:'pekerjaan', label:'Pekerjaan' }, { key:'recommendation', label:'Recommendation' }, { key:'notes', label:'Catatan' }, actionCol];
        }
        const actionCol = { key:'__act', label:'Aksi', render: (row)=>{
          return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
            <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
              <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
              <circle cx='12' cy='12' r='3'></circle>
            </svg>
            View
          </button>`;
        }};
        return [selCol, ...base, { key:'pekerjaan', label:'Pekerjaan' }, { key:'item_dipakai', label:'Item Dipakai' }, { key:'notes', label:'Catatan' }, actionCol];
      }

      function getFilters(){
        return {
          q: document.getElementById('q').value.trim(),
          forklift_id: document.getElementById('forklift_id').value,
          start: document.getElementById('start').value,
          end: document.getElementById('end').value,
          jenis: document.getElementById('jenis').value,
        };
      }

      async function load(){
        const user = await ensureAuthedAndRenderNav();
        if (!user) return;
        await populateForklifts();
        await fetchAndRender();
      }

      let fkCache = [];
      function fkLabel(f){
        return [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - ');
      }
      async function populateForklifts(){
        try{
          const list = await api('/api/forklifts');
          fkCache = Array.isArray(list) ? list : [];
        }catch(e){ fkCache = []; }
      }

      async function fetchAndRender(){
        try{
          const f = getFilters();
          // Pastikan filter jenis diterjemahkan ke job_source agar konsisten dengan backend
          const mappedJenis = f.jenis ? (f.jenis.toLowerCase() === 'pm' ? 'maintenance' : 'workshop') : '';
          const paramsObj = { ...f, limit: String(limit), offset: String(offset) };
          if (mappedJenis) {
            paramsObj.job_source = mappedJenis;
          }
          // Sorting berdasarkan tanggal
          paramsObj.order = orderDir;
          const params = new URLSearchParams(paramsObj);
          const res = await api(`/api/archive/jobs?${params.toString()}`);
          const rows = res.rows || [];
          lastRows = rows;
          total = res.total || rows.length;
          const cols = columnsForJenis(f.jenis);
          simpleTable('table', cols, rows);
          // Header tanggal: klik untuk toggle newest/oldest
          try{
            const dateIdx = cols.findIndex(c=> c.key==='job_date');
            const ths = Array.from(document.querySelectorAll('#table th'));
            const dateTh = dateIdx>=0 ? ths[dateIdx] : null;
            if (dateTh){
              dateTh.style.cursor = 'pointer';
              dateTh.title = 'Klik untuk urutkan tanggal newest/oldest';
              dateTh.onclick = ()=>{ orderDir = (orderDir==='desc' ? 'asc' : 'desc'); offset = 0; fetchAndRender(); };
              // Tampilkan indikator arah
              dateTh.textContent = cols[dateIdx].label + (orderDir==='desc' ? ' ▼' : ' ▲');
            }
          }catch{}
          // Header "Sel": toggle pilih semua di halaman saat ini
          const selHead = document.querySelector('#table th:first-child');
          if (selHead){
            selHead.style.cursor = 'pointer';
            selHead.title = 'Pilih/bersihkan semua baris di halaman ini';
            selHead.onclick = ()=>{
              const allSelected = rows.length>0 && rows.every(r=> selected.has(String(r.id)));
              rows.forEach(r=>{ const idStr = String(r.id); if (allSelected) selected.delete(idStr); else selected.add(idStr); });
              fetchAndRender();
            };
          }
          // Delegasi klik tombol View untuk buka modal detail
          const container = document.getElementById('table');
          if (container && !container.dataset.viewDelegated){
            container.addEventListener('click', async (ev)=>{
              const btn = ev.target.closest('button.btn-view[data-view]');
              if (!btn) return;
              const id = btn.getAttribute('data-view');
              const row = (rows||[]).find(r=> String(r.id)===String(id));
              try{
                const d = await api(`/api/archive/jobs/${id}?job_source=${encodeURIComponent(row?.job_source||'')}`);
                openView('Detail Arsip', d);
              }catch(e){ console.error('Gagal ambil detail arsip', e); }
            });
            container.dataset.viewDelegated = '1';
          }
          document.getElementById('summary').textContent = `Menampilkan ${rows.length} dari total ${total} data.`;
          const page = Math.floor(offset / limit) + 1;
          const pages = Math.max(1, Math.ceil(total / limit));
          const pageEl = document.getElementById('pageInfo'); if (pageEl) pageEl.textContent = `Halaman ${page} / ${pages}`;
          document.getElementById('prevBtn').disabled = offset <= 0;
          document.getElementById('nextBtn').disabled = offset + limit >= total;
        }catch(e){ console.error('Gagal memuat arsip', e); alert('Gagal memuat arsip'); }
      }

      function bindEvents(){
        document.getElementById('resetBtn').onclick = () => {
          document.getElementById('q').value = '';
          document.getElementById('forklift_id').value = '';
          
          document.getElementById('start').value = '';
          document.getElementById('end').value = '';
          document.getElementById('jenis').value = 'Workshop';
          const rpp = document.getElementById('rowsPerPage'); if (rpp) rpp.value = '25'; limit = 25;
          offset = 0;
          fetchAndRender();
        };
        document.getElementById('prevBtn').onclick = () => { if (offset > 0) { offset = Math.max(0, offset - limit); fetchAndRender(); } };
        document.getElementById('nextBtn').onclick = () => { offset = offset + limit; fetchAndRender(); };
        // Pencarian realtime: debounce saat mengetik kata kunci
        const trigger = () => { offset = 0; fetchAndRender(); };
        const debouncedTrigger = debounce(trigger, 250);
        const qEl = document.getElementById('q');
        if (qEl) qEl.addEventListener('input', debouncedTrigger);
        // Filter lain auto-apply saat berubah
        ['jenis','start','end'].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => { offset = 0; fetchAndRender(); });
        });
        // Rows per page selector
        const rppEl = document.getElementById('rowsPerPage');
        if (rppEl){
          rppEl.addEventListener('change', ()=>{
            const v = rppEl.value;
            if (v === 'all'){ limit = 100000; offset = 0; }
            else { const n = parseInt(v,10); limit = (!isNaN(n) && n>0) ? n : 25; offset = 0; }
            fetchAndRender();
          });
        }
        // tetap dukung Enter untuk submit manual pada keyword
        document.getElementById('q').addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); offset = 0; fetchAndRender(); } });
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.onclick = exportCSV;
        const exportExcelBtn = document.getElementById('exportExcel');
        if (exportExcelBtn) exportExcelBtn.onclick = exportExcel;
        const exportPDFBtn = document.getElementById('exportPDF');
        if (exportPDFBtn) exportPDFBtn.onclick = exportPDF;
        // Ikon tombol seperti di records
        try{
          setButtonIcon(document.getElementById('resetBtn'),'reset',true);
          setButtonIcon(document.getElementById('exportExcel'),'file-excel',true);
          setButtonIcon(document.getElementById('exportPDF'),'pdf-export',true);
        }catch{}
        // Delegasi checkbox di tabel
        const tbl = document.getElementById('table');
        tbl.addEventListener('change', (e)=>{
          const t = e.target;
          if (t && t.matches('input[type="checkbox"][data-id]')){
            const idStr = String(t.getAttribute('data-id'));
            if (t.checked) selected.add(idStr); else selected.delete(idStr);
          }
        });
      }

      function toCSVRow(vals){
        return vals.map(v=>{
          let s = String(v==null?'':v);
          const needsQuote = s.includes(',') || s.includes('\n') || s.includes('"');
          if (needsQuote){ s = '"' + s.replace(/"/g,'""') + '"'; }
          return s;
        }).join(',');
      }

      function exportCSV(){
        try{
          const columns = columnsForJenis(document.getElementById('jenis').value);
          const headers = columns.map(c=> c.label);
          const keys = columns.map(c=> c.key);
          const lines = [toCSVRow(headers)];
          (Array.isArray(lastRows)? lastRows : []).forEach(r=>{
            const vals = keys.map(k=> r && r[k]);
            lines.push(toCSVRow(vals));
          });
          const csv = lines.join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
          a.href = url; a.download = `arsip-jobs-${stamp}.csv`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e){ alert('Gagal export CSV'); }
      }

      async function ensureExcelJS(){
        if (window.ExcelJS) return window.ExcelJS;
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js';
        await new Promise((res,rej)=>{ s.onload=res; s.onerror=rej; document.head.appendChild(s); });
        return window.ExcelJS;
      }
      async function ensureJsPDF(){
        if (window.jspdf && window.jspdf.jsPDF && window.jspdf.autoTable) return window.jspdf.jsPDF;
        const s1 = document.createElement('script');
        s1.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        const s2 = document.createElement('script');
        s2.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js';
        await new Promise((res,rej)=>{ s1.onload=res; s1.onerror=rej; document.head.appendChild(s1); });
        await new Promise((res,rej)=>{ s2.onload=res; s2.onerror=rej; document.head.appendChild(s2); });
        return window.jspdf.jsPDF;
      }
      function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }
      async function fetchAllFilteredRows(){
        const f = getFilters();
        const params = new URLSearchParams();
        if (f.q) params.set('q', f.q);
        if (f.start) params.set('start', f.start);
        if (f.end) params.set('end', f.end);
        params.set('jenis', f.jenis);
        params.set('limit', '100000');
        params.set('offset', '0');
        const r = await api('/api/archive/jobs?' + params.toString());
        return Array.isArray(r.rows) ? r.rows : [];
      }
      async function exportExcel(){
        try{
          await ensureExcelJS();
          const ExcelJS = window.ExcelJS;
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Archive');
          const cols = columnsForJenis(document.getElementById('jenis').value).filter(c=> c.key!=='__sel' && c.key!=='__act');
          // Lebar kolom dan alignment menyerupai records.html
          const widthsMap = { job_date:14, job_no:16, jenis:12, forklift:28, pekerjaan:24, recommendation:24, next_pm:16, item_dipakai:24, notes:24, description:40 };
          ws.columns = cols.map(c=> ({
            header: c.label,
            key: c.key,
            width: widthsMap[c.key] || 18,
            style: { alignment: { vertical:'top', wrapText: ['description','notes','pekerjaan','recommendation'].includes(c.key) } }
          }));
          const allRows = await fetchAllFilteredRows();
          const useSelected = selected && selected.size>0;
          const idSet = useSelected ? new Set(Array.from(selected)) : null;
          const rowsSource = useSelected ? allRows.filter(r=> idSet.has(String(r.id))) : allRows;
          rowsSource.forEach(r=>{
            const row = {};
            cols.forEach(c=>{ row[c.key] = r[c.key]; });
            ws.addRow(row);
          });
          // Header styling, freeze, autoFilter
          try{
            const headerRow = ws.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
            headerRow.height = 22;
            headerRow.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF0D47A1' } });
            ws.views = [{ state:'frozen', ySplit:1 }];
            ws.autoFilter = { from: { row:1, column:1 }, to: { row:1, column: cols.length } };
          }catch{}
          // Zebra striping & borders
          try{
            const lastRow = ws.rowCount;
            for (let r = 2; r <= lastRow; r++){
              if (r % 2 === 0){ ws.getRow(r).eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFF2F6FC' } }); }
              ws.getRow(r).eachCell(cell=>{ cell.border = {
                top: { style:'thin', color:{ argb:'FFB0BEC5' } },
                left: { style:'thin', color:{ argb:'FFB0BEC5' } },
                bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
                right: { style:'thin', color:{ argb:'FFB0BEC5' } },
              }; });
            }
            // Header borders
            ws.getRow(1).eachCell(cell=>{ cell.border = {
              top: { style:'thin', color:{ argb:'FFB0BEC5' } },
              left: { style:'thin', color:{ argb:'FFB0BEC5' } },
              bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
              right: { style:'thin', color:{ argb:'FFB0BEC5' } },
            }; });
          }catch{}
          const buf = await wb.xlsx.writeBuffer();
          downloadBlob(new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), 'archive.xlsx');
        }catch(e){ console.error(e); alert('Gagal export Excel'); }
      }
      async function exportPDF(){
        try{
          const jsPDF = await ensureJsPDF();
          const doc = new jsPDF({ orientation:'landscape' });
          const cols = columnsForJenis(document.getElementById('jenis').value).filter(c=> c.key!=='__sel' && c.key!=='__act');
          const head = [cols.map(c=> c.label)];
          const allRows = await fetchAllFilteredRows();
          const useSelected = selected && selected.size>0;
          const idSet = useSelected ? new Set(Array.from(selected)) : null;
          const rowsSource = useSelected ? allRows.filter(r=> idSet.has(String(r.id))) : allRows;
          const body = rowsSource.map(r=> cols.map(c=> r[c.key]||''));
          doc.text('Archive Export', 14, 16);
          doc.autoTable({ head, body, styles:{ fontSize:8, cellPadding:3, overflow:'linebreak' }, headStyles:{ fillColor:[13,71,161], textColor:255 }, startY:20, margin:{ left:14, right:14 } });
          doc.save('archive.pdf');
        }catch(e){ console.error(e); alert('Gagal export PDF'); }
      }

      function renderDetailHtml(d){
        const isPM = (d.jenis||'').toLowerCase() === 'pm' || d.job_source === 'maintenance';
        const rows = [
          ['ID', d.id],
          ['Job No', d.job_no],
          ['Sumber', d.job_source],
          ['Jenis', d.jenis || (d.job_source === 'maintenance' ? 'PM' : 'Workshop')],
          ['Tanggal', d.job_date],
          ['Forklift', d.forklift],
          ...(isPM ? [['Next PM', d.next_pm || '']] : []),
          ['Pekerjaan', d.pekerjaan || ''],
          ['Deskripsi', d.description || ''],
          ['Item Dipakai', d.items_used || d.item_dipakai || ''],
          ['Catatan', d.notes || ''],
          ['Dibuat', d.created_at || ''],
          ['Diupdate', d.updated_at || ''],
        ];
        return `
          <div style='display:grid; grid-template-columns: 160px 1fr; gap:8px;'>
            ${rows.map(([k,v])=>`<div style='color:#666'>${k}</div><div>${String(v??'')}</div>`).join('')}
          </div>
        `;
      }

      function openView(title, detail){
        const modal = document.getElementById('modal');
        const titleEl = document.getElementById('modalTitle');
        const bodyEl = document.getElementById('modalBody');
        const closeBtn = document.getElementById('closeBtn');
        titleEl.textContent = title;
        bodyEl.innerHTML = renderDetailHtml(detail||{});
        modal.style.display = 'flex';
        const close = ()=>{ modal.style.display='none'; };
        closeBtn.onclick = close;
        modal.onclick = (ev)=>{ if (ev.target === modal) close(); };
      }

      // Suggest forklift (single select)
      const fkInput = document.getElementById('arch_forklift_input');
      const fkSuggest = document.getElementById('archFkSuggest');
      const fkIdEl = document.getElementById('forklift_id');
      function filterForkliftList(query){
        const q = String(query||'').trim().toLowerCase();
        if (!q) return fkCache;
        return (fkCache||[]).filter(f=>{
          const fields = [f.location, f.eq_no, f.brand, f.type, f.powertrain].map(v=> String(v||'').toLowerCase());
          return fields.some(v=> v.includes(q));
        });
      }
      function renderFkSuggest(){
        if (!fkInput || !fkSuggest) return;
        const list = filterForkliftList(fkInput.value);
        if (fkIdEl) fkIdEl.value = ''; // reset id saat mengetik
        if (!Array.isArray(list) || list.length===0){ fkSuggest.style.display='none'; fkSuggest.innerHTML=''; return; }
        fkSuggest.innerHTML = list.map(f=>{
          const label = fkLabel(f);
          return `<div class="item" data-id="${f.id}">${label}</div>`;
        }).join('');
        fkSuggest.style.display='block';
        if (!fkSuggest._dragGuardAttached){
          let startY=0, dragging=false;
          fkSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY||0; dragging=false; }, {passive:true});
          fkSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging=true; }, {passive:true});
          fkSuggest._isDragging = ()=>dragging;
          fkSuggest._dragGuardAttached = true;
        }
        fkSuggest.querySelectorAll('.item').forEach(it=>{
          it.onclick = (ev)=>{
            if (fkSuggest._isDragging && fkSuggest._isDragging()) { ev.preventDefault(); return; }
            const id = +it.getAttribute('data-id');
            const f = (fkCache||[]).find(x=>x.id===id); if (!f) return;
            if (fkIdEl) fkIdEl.value = String(f.id);
            fkInput.value = fkLabel(f);
            fkSuggest.style.display='none';
            offset = 0; fetchAndRender();
          };
        });
      }
      if (fkInput){
        const debouncedFk = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),200); }; })(renderFkSuggest);
        fkInput.addEventListener('input', debouncedFk);
        fkInput.addEventListener('focus', ()=> renderFkSuggest());
        fkInput.addEventListener('click', ()=> renderFkSuggest());
        fkInput.addEventListener('keydown', (e)=>{
          if (e.key==='Enter'){
            const first = fkSuggest && fkSuggest.querySelector('.item');
            if (first){ first.click(); e.preventDefault(); }
          }
          if (e.key==='Escape'){ if (fkSuggest) fkSuggest.style.display='none'; }
        });
        document.addEventListener('click', (e)=>{ if (fkSuggest && !fkSuggest.contains(e.target) && e.target!==fkInput){ fkSuggest.style.display='none'; } });
      }

      (async function(){
        bindEvents();
        await load();
      })();
    </script>
  </body>
  </html>