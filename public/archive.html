<!doctype html>
<html lang="id" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Arsip Jobs</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; }
      .container { padding: 16px; }
      .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end; margin-bottom:12px; }
      .toolbar label { display:flex; flex-direction:column; font-size:12px; gap:4px; }
      .toolbar input, .toolbar select { padding:6px 8px; }
      /* Actions container (desktop: dorong ke kanan) */
      .toolbar .actions { margin-left:auto; display:flex; gap:8px; align-items:center; }
      .toolbar .actions button, .toolbar .actions select { height:36px; min-height:36px; }
      /* Pastikan teks tombol sejajar ke kiri agar konsisten */
      .toolbar .actions button { display:flex; align-items:center; justify-content:flex-start; gap:6px; text-align:left; }
      /* Kelompok Rows agar label dan dropdown berdampingan */
      .toolbar .rows-group { display:inline-flex; align-items:center; gap:8px; height:36px; }
      .toolbar .rows-group select { width:96px; min-width:96px; height:36px; }
      .table-scroll { overflow:auto; border:1px solid #ddd; border-radius:8px; }
      /* Border tabel ala records (terlihat jelas di light mode) */
      #table table { width:100%; border-collapse:collapse; }
      #table table th, #table table td { text-align:left; padding:8px; border-bottom:1px solid #eee; }
      #table table td { line-height:1.4; }
      #table table th { background:#fafafa; }
      [data-theme="dark"] #table table th, [data-theme="dark"] #table table td { border-bottom:1px solid #1f2937; }
      [data-theme="dark"] #table table th { background:#0f172a; }
      .pagination { display:flex; gap:8px; align-items:center; }
      .pagination button { padding:6px 10px; }
      /* Seragamkan ukuran tombol di tabel dan hentikan kolom aksi megar */
      #table table th:last-child, #table table td:last-child { white-space: nowrap; width: 1%; }
      #table button { height:32px; min-height:32px; padding:0 10px; box-sizing:border-box; display:flex; align-items:center; gap:6px; line-height:1; white-space:nowrap; }
      /* Ikon kalender kustom seperti di records */
      input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0 !important; filter: none !important; }
      .date-input-wrap { position: relative; display: inline-block; color:#111; }
      [data-theme="dark"] .date-input-wrap { color:#fff; }
      .date-input-wrap input[type="date"] { padding-right: 26px; }
      .date-input-wrap::after { content: ""; position:absolute; right:4px; top:50%; transform:translateY(-50%); width:18px; height:18px; pointer-events:none; background-color: currentColor; -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><rect x='3' y='4' width='18' height='17' rx='2' ry='2' fill='none' stroke='%23fff' stroke-width='2'/><line x1='16' y1='2' x2='16' y2='6' stroke='%23fff' stroke-width='2'/><line x1='8' y1='2' x2='8' y2='6' stroke='%23fff' stroke-width='2'/><line x1='3' y1='10' x2='21' y2='10' stroke='%23fff' stroke-width='2'/></svg>") no-repeat center / contain; }
      /* Dropdown suggest (selaras dengan records) */
      .suggest { position:absolute; z-index:1000; top: calc(100% + 4px); left:0; width:100%; border:1px solid #e0e0e0; border-radius:6px; max-height:140px; overflow:auto; background:#fff; box-shadow:0 6px 16px rgba(0,0,0,0.12); }
      .suggest .item { padding:6px 8px; cursor:pointer; border-bottom:1px solid #f5f5f5; }
      .suggest .item:hover { background:#f6f9ff; }
      [data-theme="dark"] .suggest { background:#0f172a; border-color:#334155; box-shadow:0 6px 16px rgba(0,0,0,0.6); }
      [data-theme="dark"] .suggest .item { color:#e5e7eb; border-bottom:1px solid #1f2937; }
      [data-theme="dark"] .suggest .item:hover { background:#1f2937; }
      /* Subteks pada kolom Forklift */
      .subtext { color:#666; font-size:12px; }
      [data-theme="dark"] .subtext { color:#fff; }
      /* Tag input untuk filter Forklift (chip + tombol X) */
      .tag-input { display:flex; flex-wrap:wrap; align-items:center; gap:6px; border:1px solid #ddd; border-radius:6px; padding:4px; background:inherit; }
      .tag-input input { border:none; outline:none; padding:6px 8px; min-width:120px; flex:1; }
      .tag { display:inline-flex; align-items:center; padding:2px 8px; border-radius:12px; background:#eef2ff; color:#111; font-size:12px; }
      .tag .remove { appearance:none; border:none; background:transparent; color:inherit; cursor:pointer; margin-left:6px; font-weight:bold; line-height:1; }
      [data-theme="dark"] .tag { background:#1f2937; color:#e5e7eb; }
      /* Responsive: mobile-friendly */
      @media (max-width: 768px){
        .container { padding:0 12px; }
        .toolbar { align-items:flex-start; flex-direction:column; }
        /* Batasi lebar field agar tidak tampak terlalu lebar; center alignment */
        .toolbar label, .toolbar .filter-group { width:100%; max-width:520px; align-self:center; }
        .toolbar .date-input-wrap { width:100%; }
        #table { overflow-x:auto; }
        /* Neutralisasi aturan width per kolom agar tidak bentrok saat re-order dan lebih rapi */
        #table table th, #table table td { width:auto !important; }
        .pagination { flex-wrap:wrap; gap:6px; }
        /* Actions di mobile: grid dua kolom dan center */
        .toolbar .actions { margin-left:0; display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:8px; width:100%; align-items:start; }
        .toolbar .actions button { width:100%; }
        /* Jadikan Rows satu baris penuh di atas tombol agar rapi */
        .toolbar .rows-group { grid-column:1 / -1; }
      }
    </style>
    <!-- Tambahan style untuk perbaikan ikon tanggal & mobile sticky -->
    <style>
      /* Samakan tinggi kontrol untuk alignment dan ikon kalender center */
      .toolbar input, .toolbar select, .toolbar button { height:36px; min-height:36px; }
      /* Pastikan input tanggal penuh dan ikon di dalam kolom */
      .date-input-wrap input[type="date"] { width:100%; box-sizing:border-box; height:36px; padding-right:26px; }
      /* Sticky columns visual fix (hindari overlap saat scroll) */
      .sticky-th, .sticky-cell { background:#fff !important; }
      [data-theme="dark"] .sticky-th, [data-theme="dark"] .sticky-cell { background:#0f172a !important; }
      .sticky-th { z-index:4 !important; box-shadow: 2px 0 0 #eee; }
      .sticky-cell { z-index:2 !important; box-shadow: 2px 0 0 #eee; }
      /* Chips gaya records */
      .chips { display:flex; flex-wrap:wrap; gap:6px; }
      .chip { display:inline-flex; align-items:center; gap:6px; background:#f0f0f0; border:1px solid #e0e0e0; border-radius:16px; padding:2px 8px; font-size:12px; white-space:nowrap; }
      .chip .x { border:none; background:transparent; cursor:pointer; font-size:12px; color:#666; }
      .chip .x:hover { color:#000; }
      .toolbar .filter-group .chips-inline { display:flex; gap:6px; flex-wrap:wrap; max-width: calc(100% - 80px); }
      .toolbar .filter-group .chips-inline .chip { background:#eee; border-color:#ddd; }
      [data-theme="dark"] .sticky-th, [data-theme="dark"] .sticky-cell { box-shadow: 2px 0 0 #334155; }
      @media (max-width: 768px){
        /* Netralisasi lebar default agar reordering mobile nyaman */
        #table table th, #table table td { width:auto !important; }
        /* Buat ukuran tabel nyaman dibaca di mobile */
        #table table { font-size:14px; }
        #table table td, #table table th { padding:8px; }
        /* Perkecil dan pusatkan kotak pencarian Kata Kunci & Forklift */
        .toolbar .narrow-field { align-self:center; width: clamp(260px, 92vw, 520px); }
        .toolbar .narrow-field input { width:100%; box-sizing:border-box; }
        .toolbar .filter-group.narrow-field { max-width: clamp(260px, 92vw, 520px) !important; }
        .toolbar .filter-group.narrow-field .tag-input { width:100%; }
      }
    </style>
    <script src="/common.js"></script>
  </head>
  <body>
    <div id="header"></div>
    <div class="container">
      <h2>Arsip Jobs</h2>
      <div class="toolbar" id="filters">
        <label class="narrow-field">
          Kata kunci
          <input type="text" id="q" placeholder="Cari job_no, forklift, deskripsi" />
        </label>
        <!-- Forklift filter: samakan dengan records (chips + suggest, input di bawah chips) -->
        <div class="filter-group narrow-field" style="position:relative;">
          <div class="label-row">
            <label>Forklift</label>
            <div id="forklift_tags" class="chips chips-inline"></div>
          </div>
          <input id="arch_forklift_input" placeholder="Ketik untuk cari forklift..." autocomplete="off" />
          <div id="archFkSuggest" class="suggest" style="display:none; content-visibility:auto; contain-intrinsic-size: 120px;"></div>
        </div>

        <label>
          Tanggal mulai
          <div class="date-input-wrap"><input type="date" id="start" /></div>
        </label>
        <label>
          Tanggal akhir
          <div class="date-input-wrap"><input type="date" id="end" /></div>
        </label>
        <label>
          Jenis Job
          <select id="jenis">
            <option value="Workshop">Workshop</option>
            <option value="PM">PM/Lapangan Jobs (PM)</option>
            <option value="All" selected>All</option>
          </select>
          </label>
        <div class="rows-group">
          <span>Rows</span>
          <select id="rowsPerPage">
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="all">All</option>
          </select>
        </div>
        <div class="actions">
          <button id="resetBtn">Reset</button>
          <button id="exportBtn" title="Export hasil saat ini ke CSV">Export CSV</button>
          <button id="exportExcel" title="Export hasil ke Excel">Export Excel</button>
          <button id="exportPDF" title="Export hasil ke PDF">Export PDF</button>
        </div>
      </div>
      <div id="summary" style="margin-bottom:8px; color:#555;"></div>
      <div id="table"></div>
      <!-- Modal detail (view-only) -->
      <div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.3); align-items:center; justify-content:center;">
        <div class="dialog" style="background:#fff; padding:16px; border-radius:8px; width:720px; max-width:95vw; max-height:85vh; display:flex; flex-direction:column; box-shadow:0 10px 24px rgba(0,0,0,0.18);">
          <h3 id="modalTitle" style="margin-top:0;">Detail Arsip</h3>
          <div id="modalBody" style="overflow:auto;"></div>
          <div style="text-align:right; margin-top:10px;">
            <button id="closeBtn">Tutup</button>
          </div>
        </div>
      </div>
      <div id="detail" style="margin-top:16px; display:none;"></div>
      <div class="pagination" style="margin-top:12px; display:flex; gap:8px; align-items:center;">
        <button id="prevBtn">Prev</button>
        <span>Halaman</span>
        <input id="pageInput" type="number" min="1" value="1" style="width:64px;" />
        <span id="pageInfo"></span>
        <button id="nextBtn">Next</button>
      </div>
    </div>

    <script>
      let limit = 25;
      let offset = 0;
      let total = 0;
      let lastRows = [];
      let selected = new Set();
      let orderDir = 'desc';

      function columnsForJenis(j){
        const selCol = { key:'__sel', label:'Sel', render:(row)=>{
          const idStr = String(row.id);
          const checked = selected.has(idStr) ? 'checked' : '';
          return `<input type="checkbox" data-id="${idStr}" ${checked} />`;
        }};
        const base = [
          { key:'id', label:'ID' },
          { key:'job_no', label:'Report No' },
          { key:'jenis', label:'Jenis', render:(row)=>{
            const j = String(row.jenis||'').toLowerCase();
            return (j==='pm' || row.job_source==='maintenance') ? 'PM/Lapangan' : (row.jenis||'');
          } },
          { key:'job_date', label:'Tanggal' },
          { key:'forklift', label:'Forklift', render:(row)=>{
            const main = String(row.forklift||'').trim();
            const eq = String(row.forklift_eq_no||'').trim() || (main.match(/\(([^)]+)\)\s*$/)?.[1]||'').trim();
            const brandType = main ? main.replace(/\s*\([^)]*\)\s*$/, '').trim() : '';
            const location = String(row.forklift_location||'').trim();
            const powertrain = String(row.forklift_powertrain||'').trim();
            const details = [location].filter(Boolean).join(' / ');
            const extra = [powertrain].filter(Boolean).join(' · ');
            const sub = [brandType, details, extra].filter(Boolean).join(' — ');
            const top = eq || brandType || main;
            return sub ? `<div>${top}<div class='subtext'>${sub}</div></div>` : top;
          } },
        ];
        const v = String(j||'').toLowerCase();
        if (v === 'pm'){
          const actionCol = { key:'__act', label:'Aksi', render: (row)=>{
            return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
              <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
                <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
                <circle cx='12' cy='12' r='3'></circle>
              </svg>
              View
            </button>`;
          }};
          return [selCol, ...base, { key:'next_pm', label:'Next PM' }, { key:'pekerjaan', label:'Pekerjaan' }, { key:'recommendation', label:'Recommendation' }, { key:'notes', label:'Catatan' }, actionCol];
        }
        if (v === 'all'){
          const actionCol = { key:'__act', label:'Aksi', render: (row)=>{
            return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
              <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
                <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
                <circle cx='12' cy='12' r='3'></circle>
              </svg>
              View
            </button>`;
          }};
          return [selCol, ...base, { key:'next_pm', label:'Next PM' }, { key:'pekerjaan', label:'Pekerjaan' }, { key:'recommendation', label:'Recommendation' }, { key:'item_dipakai', label:'Item Dipakai' }, { key:'notes', label:'Catatan' }, actionCol];
        }
        const actionCol = { key:'__act', label:'Aksi', render: (row)=>{
          return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
            <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
              <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
              <circle cx='12' cy='12' r='3'></circle>
            </svg>
            View
          </button>`;
        }};
        return [selCol, ...base, { key:'pekerjaan', label:'Pekerjaan' }, { key:'item_dipakai', label:'Item Dipakai' }, { key:'notes', label:'Catatan' }, actionCol];
      }

      // Versi kolom khusus mobile (mengacu records.html): fokus kolom penting dan urutan yang nyaman
      function columnsMobileForJenis(j){
        const v = String(j||'').toLowerCase();
        const selCol = { key:'__sel', label:'Sel', render:(row)=>{
          const idStr = String(row.id);
          const checked = selected.has(idStr) ? 'checked' : '';
          return `<input type="checkbox" data-id="${idStr}" ${checked} />`;
        }};
        const tanggalCol = { key:'job_date', label:'Tanggal' };
        const forkliftCol = { key:'forklift', label:'Forklift', render:(row)=>{
          const main = String(row.forklift||'').trim();
          const eq = String(row.forklift_eq_no||'').trim() || (main.match(/\(([^)]+)\)\s*$/)?.[1]||'').trim();
          const brandType = main ? main.replace(/\s*\([^)]*\)\s*$/, '').trim() : '';
          const location = String(row.forklift_location||'').trim();
          const powertrain = String(row.forklift_powertrain||'').trim();
          const details = [location].filter(Boolean).join(' / ');
          const extra = [powertrain].filter(Boolean).join(' · ');
          const sub = [brandType, details, extra].filter(Boolean).join(' — ');
          const top = eq || brandType || main;
          return sub ? `<div>${top}<div class='subtext'>${sub}</div></div>` : top;
        }};
        const pekerjaanCol = { key:'pekerjaan', label:'Pekerjaan' };
        const reportCol = { key:'job_no', label:'Report No' };
        const nextPmCol = { key:'next_pm', label:'Next PM' };
        const recCol = { key:'recommendation', label:'Recommendation' };
        const itemsCol = { key:'item_dipakai', label:'Item Dipakai' };
        const notesCol = { key:'notes', label:'Catatan' };
        const actCol = { key:'__act', label:'Aksi', render: (row)=>{
          return `<button class='btn-view' data-view='${row.id}' title='View' aria-label='View'>
            <svg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' style='vertical-align:middle;margin-right:6px'>
              <path d='M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z'></path>
              <circle cx='12' cy='12' r='3'></circle>
            </svg>
            View
          </button>`;
        }};
        if (v==='pm') return [selCol, tanggalCol, forkliftCol, pekerjaanCol, reportCol, nextPmCol, recCol, notesCol, actCol];
        if (v==='all') return [selCol, tanggalCol, forkliftCol, pekerjaanCol, reportCol, nextPmCol, recCol, itemsCol, notesCol, actCol];
        // workshop
        return [selCol, tanggalCol, forkliftCol, pekerjaanCol, reportCol, recCol, itemsCol, notesCol, actCol];
      }

      function getFilters(){
        const fkIdSet = new Set((selectedForklifts||[]).map(f=> f.id));
        const singleFkId = (Array.isArray(selectedForklifts) && selectedForklifts.length===1) ? selectedForklifts[0].id : '';
        return {
          q: document.getElementById('q').value.trim(),
          start: document.getElementById('start').value,
          end: document.getElementById('end').value,
          jenis: document.getElementById('jenis').value,
          fkIdSet,
          singleFkId,
        };
      }

      async function load(){
        const user = await ensureAuthedAndRenderNav();
        if (!user) return;
        await populateForklifts();
        await fetchAndRender();
      }

      let fkCache = [];
      function fkLabel(f){
        return [f.location, (f.eq_alias||f.eq_no), f.brand, f.type, f.powertrain].map(v=>String(v||'').trim()).filter(Boolean).join(' - ');
      }
      function normalizeNoSpace(str){ return String(str||'').toLowerCase().replace(/[\s-]+/g,''); }
      function makeTokens(q){ const base=String(q||'').trim().toLowerCase(); const bySpace=base.split(/\s+/).filter(Boolean); const byGroup=(base.match(/[a-z]+|\d+/g)||[]); const set=new Set([...bySpace,...byGroup]); return Array.from(set); }
      function matchesForklift(f, q){ const tokens=makeTokens(q); if(!tokens.length) return true; const fields=[f.location, f.owner, (f.eq_alias||f.eq_no), f.serial, f.brand, f.type, f.powertrain]; const normFields=fields.map(s=> normalizeNoSpace(s)); const joined=normalizeNoSpace(fields.map(v=> String(v||'')) .join(' | ')); const qNo=normalizeNoSpace(q); if(qNo && joined.includes(qNo)) return true; return tokens.every(tok=>{ const nt=normalizeNoSpace(tok); return normFields.some(nf=> nf.includes(nt)); }); }
      function filterForkliftList(query){
        const s = String(query||'');
        if (!s.trim()) return fkCache;
        try{ return (fkCache||[]).filter(f=> matchesForklift(f, s)); }
        catch{ return (fkCache||[]); }
      }
      async function populateForklifts(){
        try{
          const list = await api('/api/forklifts');
          fkCache = Array.isArray(list) ? list : [];
        }catch(e){ fkCache = []; }
      }

      async function fetchAndRender(){
        try{
          const f = getFilters();
          // Terjemahkan jenis ke job_source; "All" artinya union (tanpa job_source)
          const jenisLower = String(f.jenis||'').toLowerCase();
          const mappedJenis = jenisLower === 'pm' ? 'maintenance' : (jenisLower === 'workshop' ? 'workshop' : '');
          const paramsObj = {
            q: f.q,
            forklift_id: f.singleFkId,
            start: f.start,
            end: f.end,
            limit: String(limit),
            offset: String(offset),
            order: orderDir,
          };
          if (mappedJenis) paramsObj.job_source = mappedJenis;
          // Sorting berdasarkan tanggal
          const params = new URLSearchParams(paramsObj);
          const res = await api(`/api/archive/jobs?${params.toString()}`);
          let rows = res.rows || [];
          if (f.q){ rows = rows.filter(r=> rowMatchesQuery(r, f.q)); }
          if (f.fkIdSet && f.fkIdSet.size>0){
            rows = rows.filter(r=> f.fkIdSet.has(r.forklift_id));
          }
          lastRows = rows;
          total = res.total || rows.length;
          const isMobile = window.matchMedia('(max-width: 768px)').matches;
          const renderCols = isMobile ? columnsMobileForJenis(f.jenis) : columnsForJenis(f.jenis);
          simpleTable('table', renderCols, rows);
          // Header tanggal: klik untuk toggle newest/oldest
          try{
            const dateIdx = renderCols.findIndex(c=> c.key==='job_date');
            const ths = Array.from(document.querySelectorAll('#table th'));
            const dateTh = dateIdx>=0 ? ths[dateIdx] : null;
            if (dateTh){
              dateTh.style.cursor = 'pointer';
              dateTh.title = 'Klik untuk urutkan tanggal newest/oldest';
              dateTh.onclick = ()=>{ orderDir = (orderDir==='desc' ? 'asc' : 'desc'); offset = 0; fetchAndRender(); };
              // Tampilkan indikator arah
              dateTh.textContent = renderCols[dateIdx].label + (orderDir==='desc' ? ' ▼' : ' ▲');
            }
          }catch{}
          
          // (Sticky kolom dihapus sesuai permintaan; urutan kolom mobile tetap dikendalikan oleh columnsMobileForJenis)
          // Header "Sel": toggle pilih semua di halaman saat ini
          const selHead = document.querySelector('#table th:first-child');
          if (selHead){
            selHead.style.cursor = 'pointer';
            selHead.title = 'Pilih/bersihkan semua baris di halaman ini';
            selHead.onclick = ()=>{
              const allSelected = rows.length>0 && rows.every(r=> selected.has(String(r.id)));
              rows.forEach(r=>{ const idStr = String(r.id); if (allSelected) selected.delete(idStr); else selected.add(idStr); });
              fetchAndRender();
            };
          }
          // Delegasi klik tombol View untuk buka modal detail
          const container = document.getElementById('table');
          if (container && !container.dataset.viewDelegated){
            container.addEventListener('click', async (ev)=>{
              const btn = ev.target.closest('button.btn-view[data-view]');
              if (!btn) return;
              const id = btn.getAttribute('data-view');
              const row = (rows||[]).find(r=> String(r.id)===String(id));
              try{
                const d = await api(`/api/archive/jobs/${id}?job_source=${encodeURIComponent(row?.job_source||'')}`);
                openView('Detail Arsip', d);
              }catch(e){ console.error('Gagal ambil detail arsip', e); }
            });
            container.dataset.viewDelegated = '1';
          }
          document.getElementById('summary').textContent = `Menampilkan ${rows.length} dari total ${total} data.`;
          const page = Math.floor(offset / limit) + 1;
          const pages = Math.max(1, Math.ceil(total / limit));
          const pageEl = document.getElementById('pageInfo'); if (pageEl) pageEl.textContent = ` / ${pages}`;
          const pageInput = document.getElementById('pageInput'); if (pageInput) pageInput.value = String(page);
          const prevBtn = document.getElementById('prevBtn'); const nextBtn = document.getElementById('nextBtn');
          if (prevBtn) prevBtn.disabled = page <= 1;
          if (nextBtn) nextBtn.disabled = page >= pages;
        }catch(e){ console.error('Gagal memuat arsip', e); alert('Gagal memuat arsip'); }
      }

      function rowMatchesQuery(row, q){
        const tokens = makeTokens(q);
        if (!tokens.length) return true;
        const fields = [row.job_no, row.forklift, row.forklift_eq_no, row.forklift_serial, row.forklift_location, row.forklift_powertrain, row.description, row.recommendation, row.item_dipakai, row.notes, row.jenis, row.status];
        const norm = fields.map(s=> normalizeNoSpace(s));
        const joined = normalizeNoSpace(fields.map(v=> String(v||'')) .join(' | '));
        const qNo = normalizeNoSpace(q);
        if (qNo && joined.includes(qNo)) return true;
        return tokens.every(tok=>{ const nt = normalizeNoSpace(tok); return norm.some(nf=> nf.includes(nt)); });
      }

      function bindEvents(){
        document.getElementById('resetBtn').onclick = () => {
          document.getElementById('q').value = '';
          // Bersihkan pilihan forklift (chips)
          try{ selectedForklifts = []; renderFkTags(); }catch{}

          document.getElementById('start').value = '';
          document.getElementById('end').value = '';
          document.getElementById('jenis').value = 'All';
          const rpp = document.getElementById('rowsPerPage'); if (rpp) rpp.value = '25'; limit = 25;
          offset = 0;
          fetchAndRender();
        };
        document.getElementById('prevBtn').onclick = () => { const pages = Math.max(1, Math.ceil(total/limit)); const page = Math.floor(offset/limit)+1; if (page>1){ offset = Math.max(0, offset - limit); fetchAndRender(); } };
        document.getElementById('nextBtn').onclick = () => { const pages = Math.max(1, Math.ceil(total/limit)); const page = Math.floor(offset/limit)+1; if (page<pages){ offset = offset + limit; fetchAndRender(); } };
        const pageInput = document.getElementById('pageInput');
        if (pageInput){
          pageInput.addEventListener('change', ()=>{
            const pages = Math.max(1, Math.ceil(total / limit));
            let p = parseInt(pageInput.value, 10) || 1;
            if (p < 1) p = 1; if (p > pages) p = pages;
            offset = (p - 1) * limit;
            fetchAndRender();
          });
          pageInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); pageInput.dispatchEvent(new Event('change')); } });
        }
        // Pencarian realtime: debounce saat mengetik kata kunci
        const trigger = () => { offset = 0; fetchAndRender(); };
        const debouncedTrigger = debounce(trigger, 250);
        const qEl = document.getElementById('q');
        if (qEl) qEl.addEventListener('input', debouncedTrigger);
        // Filter lain auto-apply saat berubah
        ['jenis','start','end'].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => { offset = 0; fetchAndRender(); });
        });
        // Rows per page selector
        const rppEl = document.getElementById('rowsPerPage');
        if (rppEl){
          rppEl.addEventListener('change', ()=>{
            const v = rppEl.value;
            if (v === 'all'){ limit = 100000; offset = 0; }
            else { const n = parseInt(v,10); limit = (!isNaN(n) && n>0) ? n : 25; offset = 0; }
            fetchAndRender();
          });
        }
        // tetap dukung Enter untuk submit manual pada keyword
        document.getElementById('q').addEventListener('keydown', (e)=>{ if (e.key === 'Enter'){ e.preventDefault(); offset = 0; fetchAndRender(); } });
        const exportBtn = document.getElementById('exportBtn');
        if (exportBtn) exportBtn.onclick = exportCSV;
        const exportExcelBtn = document.getElementById('exportExcel');
        if (exportExcelBtn) exportExcelBtn.onclick = exportExcel;
        const exportPDFBtn = document.getElementById('exportPDF');
        if (exportPDFBtn) exportPDFBtn.onclick = exportPDF;
        // Ikon tombol seperti di records
        try{
          setButtonIcon(document.getElementById('resetBtn'),'reset',true);
          setButtonIcon(document.getElementById('exportExcel'),'file-excel',true);
          setButtonIcon(document.getElementById('exportPDF'),'pdf-export',true);
        }catch{}
        // Delegasi checkbox di tabel
        const tbl = document.getElementById('table');
        tbl.addEventListener('change', (e)=>{
          const t = e.target;
          if (t && t.matches('input[type="checkbox"][data-id]')){
            const idStr = String(t.getAttribute('data-id'));
            if (t.checked) selected.add(idStr); else selected.delete(idStr);
          }
        });
      }

      function toCSVRow(vals){
        return vals.map(v=>{
          let s = String(v==null?'':v);
          const needsQuote = s.includes(',') || s.includes('\n') || s.includes('"');
          if (needsQuote){ s = '"' + s.replace(/"/g,'""') + '"'; }
          return s;
        }).join(',');
      }

      function exportCSV(){
        try{
          const columns = columnsForJenis(document.getElementById('jenis').value);
          const headers = columns.map(c=> c.label);
          const keys = columns.map(c=> c.key);
          const lines = [toCSVRow(headers)];
          (Array.isArray(lastRows)? lastRows : []).forEach(r=>{
            const vals = keys.map(k=>{
              let v = r && r[k];
              if (k === 'jenis'){
                const isPM = (String(r.jenis||'').toLowerCase()==='pm') || r.job_source === 'maintenance';
                v = isPM ? 'PM/Lapangan' : (r.jenis || 'Workshop');
              }
              return v;
            });
            lines.push(toCSVRow(vals));
          });
          const csv = lines.join('\n');
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
          a.href = url; a.download = `arsip-jobs-${stamp}.csv`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (e){ alert('Gagal export CSV'); }
      }

      async function ensureExcelJS(){
        if (window.ExcelJS) return window.ExcelJS;
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js';
        await new Promise((res,rej)=>{ s.onload=res; s.onerror=rej; document.head.appendChild(s); });
        return window.ExcelJS;
      }
      async function ensureJsPDF(){
        if (window.jspdf && window.jspdf.jsPDF && window.jspdf.autoTable) return window.jspdf.jsPDF;
        const s1 = document.createElement('script');
        s1.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        const s2 = document.createElement('script');
        s2.src = 'https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js';
        await new Promise((res,rej)=>{ s1.onload=res; s1.onerror=rej; document.head.appendChild(s1); });
        await new Promise((res,rej)=>{ s2.onload=res; s2.onerror=rej; document.head.appendChild(s2); });
        return window.jspdf.jsPDF;
      }
      function downloadBlob(blob, filename){
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }
      async function fetchAllFilteredRows(){
        const f = getFilters();
        const jenisLower = String(f.jenis||'').toLowerCase();
        const mappedJenis = jenisLower === 'pm' ? 'maintenance' : (jenisLower === 'workshop' ? 'workshop' : '');
        const params = new URLSearchParams();
        if (f.q) params.set('q', f.q);
        if (f.start) params.set('start', f.start);
        if (f.end) params.set('end', f.end);
        if (mappedJenis) params.set('job_source', mappedJenis);
        params.set('limit', '100000');
        params.set('offset', '0');
        const r = await api('/api/archive/jobs?' + params.toString());
        return Array.isArray(r.rows) ? r.rows : [];
      }
      async function exportExcel(){
        try{
          await ensureExcelJS();
          const ExcelJS = window.ExcelJS;
          const wb = new ExcelJS.Workbook();
          const ws = wb.addWorksheet('Archive');
          const cols = columnsForJenis(document.getElementById('jenis').value).filter(c=> c.key!=='__sel' && c.key!=='__act');
          // Lebar kolom dan alignment menyerupai records.html
          const widthsMap = { job_date:14, job_no:16, jenis:12, forklift:28, pekerjaan:24, recommendation:24, next_pm:16, item_dipakai:24, notes:24, description:40 };
          ws.columns = cols.map(c=> ({
            header: c.label,
            key: c.key,
            width: widthsMap[c.key] || 18,
            style: { alignment: { vertical:'top', wrapText: ['description','notes','pekerjaan','recommendation'].includes(c.key) } }
          }));
          const allRows = await fetchAllFilteredRows();
          const useSelected = selected && selected.size>0;
          const idSet = useSelected ? new Set(Array.from(selected)) : null;
          const rowsSource = useSelected ? allRows.filter(r=> idSet.has(String(r.id))) : allRows;
          rowsSource.forEach(r=>{
            const row = {};
            cols.forEach(c=>{
              let v = r[c.key];
              if (c.key === 'jenis'){
                const isPM = (String(r.jenis||'').toLowerCase()==='pm') || r.job_source === 'maintenance';
                v = isPM ? 'PM/Lapangan' : (r.jenis || 'Workshop');
              }
              row[c.key] = v;
            });
            ws.addRow(row);
          });
          // Header styling, freeze, autoFilter
          try{
            const headerRow = ws.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
            headerRow.height = 22;
            headerRow.eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FF0D47A1' } });
            ws.views = [{ state:'frozen', ySplit:1 }];
            ws.autoFilter = { from: { row:1, column:1 }, to: { row:1, column: cols.length } };
          }catch{}
          // Zebra striping & borders
          try{
            const lastRow = ws.rowCount;
            for (let r = 2; r <= lastRow; r++){
              if (r % 2 === 0){ ws.getRow(r).eachCell(cell=> cell.fill = { type:'pattern', pattern:'solid', fgColor:{ argb:'FFF2F6FC' } }); }
              ws.getRow(r).eachCell(cell=>{ cell.border = {
                top: { style:'thin', color:{ argb:'FFB0BEC5' } },
                left: { style:'thin', color:{ argb:'FFB0BEC5' } },
                bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
                right: { style:'thin', color:{ argb:'FFB0BEC5' } },
              }; });
            }
            // Header borders
            ws.getRow(1).eachCell(cell=>{ cell.border = {
              top: { style:'thin', color:{ argb:'FFB0BEC5' } },
              left: { style:'thin', color:{ argb:'FFB0BEC5' } },
              bottom: { style:'thin', color:{ argb:'FFB0BEC5' } },
              right: { style:'thin', color:{ argb:'FFB0BEC5' } },
            }; });
          }catch{}
          const buf = await wb.xlsx.writeBuffer();
          downloadBlob(new Blob([buf], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), 'archive.xlsx');
        }catch(e){ console.error(e); alert('Gagal export Excel'); }
      }
      async function exportPDF(){
        try{
          const jsPDF = await ensureJsPDF();
          const doc = new jsPDF({ orientation:'landscape' });
          const cols = columnsForJenis(document.getElementById('jenis').value).filter(c=> c.key!=='__sel' && c.key!=='__act');
          const head = [cols.map(c=> c.label)];
          const allRows = await fetchAllFilteredRows();
          const useSelected = selected && selected.size>0;
          const idSet = useSelected ? new Set(Array.from(selected)) : null;
          const rowsSource = useSelected ? allRows.filter(r=> idSet.has(String(r.id))) : allRows;
          const body = rowsSource.map(r=> cols.map(c=>{
            let v = r[c.key]||'';
            if (c.key === 'jenis'){
              const isPM = (String(r.jenis||'').toLowerCase()==='pm') || r.job_source === 'maintenance';
              v = isPM ? 'PM/Lapangan' : (r.jenis || 'Workshop');
            }
            return v;
          }));
          doc.text('Archive Export', 14, 16);
          doc.autoTable({ head, body, styles:{ fontSize:8, cellPadding:3, overflow:'linebreak' }, headStyles:{ fillColor:[13,71,161], textColor:255 }, startY:20, margin:{ left:14, right:14 } });
          doc.save('archive.pdf');
        }catch(e){ console.error(e); alert('Gagal export PDF'); }
      }

      function renderDetailHtml(d){
        const isPM = (d.jenis||'').toLowerCase() === 'pm' || d.job_source === 'maintenance';
        const rows = [
          ['ID', d.id],
          ['Job No', d.job_no],
          ['Sumber', d.job_source],
          ['Jenis', ((String(d.jenis||'').toLowerCase()==='pm') || d.job_source === 'maintenance') ? 'PM/Lapangan' : (d.jenis || 'Workshop')],
          ['Tanggal', d.job_date],
          ['Forklift', d.forklift],
          ...(isPM ? [['Next PM', d.next_pm || '']] : []),
          ['Pekerjaan', d.pekerjaan || ''],
          ['Recommendation', (d.recommendation ?? d.description) || ''],
          ['Item Dipakai', d.items_used || d.item_dipakai || ''],
          ['Catatan', d.notes || ''],
          ['Dibuat', d.created_at || ''],
          ['Diupdate', d.updated_at || ''],
        ];
        return `
          <div style='display:grid; grid-template-columns: 160px 1fr; gap:8px;'>
            ${rows.map(([k,v])=>`<div style='color:#666'>${k}</div><div>${String(v??'')}</div>`).join('')}
          </div>
        `;
      }

      function openView(title, detail){
        const modal = document.getElementById('modal');
        const titleEl = document.getElementById('modalTitle');
        const bodyEl = document.getElementById('modalBody');
        const closeBtn = document.getElementById('closeBtn');
        titleEl.textContent = title;
        bodyEl.innerHTML = renderDetailHtml(detail||{});
        modal.style.display = 'flex';
        const close = ()=>{ modal.style.display='none'; };
        closeBtn.onclick = close;
        modal.onclick = (ev)=>{ if (ev.target === modal) close(); };
      }

      // Suggest forklift (chips + multi-select) — samakan dengan records
      const fkInput = document.getElementById('arch_forklift_input');
      const fkTags = document.getElementById('forklift_tags');
      const fkSuggest = document.getElementById('archFkSuggest');
      let selectedForklifts = [];
      function renderFkTags(){
        if (!fkTags) return;
        fkTags.innerHTML = (selectedForklifts||[]).map(f=>`<span class="chip" data-id="${f.id}">${f.label} <button class="x" title="Hapus" data-rem="${f.id}">×</button></span>`).join('');
        fkTags.querySelectorAll('button[data-rem]').forEach(b=>{
          b.onclick = ()=>{ const id = +b.getAttribute('data-rem'); selectedForklifts = (selectedForklifts||[]).filter(x=>x.id!==id); renderFkTags(); offset=0; fetchAndRender(); };
        });
      }
      function fetchAndRenderFk(){
        if (!fkInput || !fkSuggest) return;
        const list = filterForkliftList(fkInput.value);
        if (!Array.isArray(list) || list.length===0){ fkSuggest.style.display='none'; fkSuggest.innerHTML=''; return; }
        fkSuggest.innerHTML = list.map(f=>{
          const label = fkLabel(f);
          return `<div class="item" data-id="${f.id}">${label}</div>`;
        }).join('');
        fkSuggest.style.display='block';
        if (!fkSuggest._dragGuardAttached){
          let startY=0, dragging=false;
          fkSuggest.addEventListener('pointerdown', e=>{ startY = e.clientY||0; dragging=false; }, {passive:true});
          fkSuggest.addEventListener('pointermove', e=>{ if (Math.abs((e.clientY||0)-startY) > 8) dragging=true; }, {passive:true});
          fkSuggest._isDragging = ()=>dragging;
          fkSuggest._dragGuardAttached = true;
        }
        fkSuggest.querySelectorAll('.item').forEach(it=>{
          const chooseFk = (ev)=>{
            if (fkSuggest._isDragging && fkSuggest._isDragging()) { ev.preventDefault(); return; }
            const id = +it.getAttribute('data-id');
            const f = (fkCache||[]).find(x=>x.id===id); if (!f) return;
            if (!selectedForklifts.some(x=>x.id===f.id)){
              const label = fkLabel(f);
              selectedForklifts.push({ id:f.id, label });
              renderFkTags(); offset=0; fetchAndRender();
            }
            fkInput.value=''; fkSuggest.style.display='none'; fkInput.focus();
          };
          it.onclick = chooseFk;
        });
      }
      if (fkInput){
        const debouncedFk = (fn=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),200); }; })(fetchAndRenderFk);
        fkInput.addEventListener('input', debouncedFk);
        fkInput.addEventListener('focus', ()=> fetchAndRenderFk());
        fkInput.addEventListener('keydown', (e)=>{
          if (e.key==='Enter'){
            const first = fkSuggest && fkSuggest.querySelector('.item');
            if (first){ first.click(); e.preventDefault(); }
          }
          if (e.key==='Escape'){ if (fkSuggest) fkSuggest.style.display='none'; }
        });
        document.addEventListener('click', (e)=>{ if (fkSuggest && !fkSuggest.contains(e.target) && e.target!==fkInput){ fkSuggest.style.display='none'; } });
      }

      (async function(){
        bindEvents();
        await load();
      })();
    </script>
  </body>
  </html>